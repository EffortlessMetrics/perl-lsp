<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Modern Architecture - Perl LSP Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Comprehensive documentation for the perl-lsp project - a production-ready Perl Language Server Protocol implementation">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Perl LSP Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/EffortlessMetrics/tree-sitter-perl-rs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="the-modern-two-crate-architecture"><a class="header" href="#the-modern-two-crate-architecture">The Modern Two-Crate Architecture</a></h1>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>This document describes the modern, modular architecture for Perl parsing in Rust, consisting of two cleanly separated crates:</p>
<ol>
<li><strong><code>perl-lexer</code></strong> - The tokenization engine</li>
<li><strong><code>perl-parser</code></strong> - The syntax analysis layer</li>
</ol>
<p>This architecture represents the professional, production-ready approach to building language tooling in Rust.</p>
<h2 id="architecture-diagram"><a class="header" href="#architecture-diagram">Architecture Diagram</a></h2>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Perl Source   â”‚  â”€â”€&gt;    â”‚   perl-lexer    â”‚  â”€â”€&gt;    â”‚  perl-parser    â”‚
â”‚     (&amp;str)      â”‚         â”‚  (Token Stream) â”‚         â”‚     (AST)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚                            â”‚
                                     â–¼                            â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚  Other Tools    â”‚         â”‚ Tree-sitter     â”‚
                            â”‚  (Linters,      â”‚         â”‚ S-expressions   â”‚
                            â”‚   Analyzers)    â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h2 id="crate-1-perl-lexer---the-foundation"><a class="header" href="#crate-1-perl-lexer---the-foundation">Crate 1: <code>perl-lexer</code> - The Foundation</a></h2>
<h3 id="purpose"><a class="header" href="#purpose">Purpose</a></h3>
<p>Convert raw Perl source code into a stream of well-defined tokens.</p>
<h3 id="key-features"><a class="header" href="#key-features">Key Features</a></h3>
<ul>
<li><strong>99.995% Perl 5 coverage</strong> with sophisticated heredoc recovery</li>
<li><strong>Enhanced delimiter recognition</strong> with comprehensive pattern matching âœ¨</li>
<li><strong>Zero dependencies</strong> on the parser - completely standalone</li>
<li><strong>Rich token types</strong> that preserve all source information</li>
<li><strong>Streaming interface</strong> for memory-efficient processing</li>
<li><strong>Unicode support</strong> with proper character boundary handling</li>
<li><strong>Performance-optimized lexing</strong> (v0.8.8+) with intelligent batch processing âœ¨</li>
</ul>
<h3 id="enhanced-delimiter-recovery-"><a class="header" href="#enhanced-delimiter-recovery-">Enhanced Delimiter Recovery âœ¨</a></h3>
<p>Advanced pattern recognition for dynamic delimiter detection:</p>
<ul>
<li><strong>Comprehensive variable pattern support</strong>: Scalar, array, and hash assignments</li>
<li><strong>Smart confidence scoring</strong>: Based on variable naming patterns (delim, end, eof, marker, etc.)</li>
<li><strong>All declaration types</strong>: <code>my</code>, <code>our</code>, <code>local</code>, <code>state</code> variable declarations</li>
<li><strong>Multiple recovery strategies</strong>: Conservative, BestGuess, Interactive modes</li>
</ul>
<h3 id="performance-optimization-engine-v088--new-diataxis-explanation"><a class="header" href="#performance-optimization-engine-v088--new-diataxis-explanation">Performance Optimization Engine (v0.8.8+) â­ <strong>NEW</strong> (<strong>Diataxis: Explanation</strong>)</a></h3>
<p><strong>PR #102 Lexer Optimizations</strong> deliver significant performance improvements through intelligent algorithm optimization:</p>
<p><strong>Core Optimization Techniques:</strong></p>
<ul>
<li><strong>Batch Whitespace Processing</strong>: 18.779% improvement through consecutive space/tab handling</li>
<li><strong>Optimized Slash Disambiguation</strong>: 14.768% improvement via direct byte operations</li>
<li><strong>Enhanced String Interpolation</strong>: 22.156% improvement using fast-path ASCII identifier parsing</li>
<li><strong>Smart ASCII Comment Skipping</strong>: Direct position advancement for non-Unicode comments</li>
<li><strong>Unrolled Number Parsing</strong>: Enhanced bounds checking and digit consumption patterns</li>
</ul>
<p><strong>Implementation Strategies:</strong></p>
<ul>
<li><strong>Conditional Heredoc Processing</strong>: Avoid unnecessary work when no heredocs are pending</li>
<li><strong>Perfect Hash Compound Operators</strong>: Optimized lookup for common operator combinations</li>
<li><strong>UTF-8 Fallback Architecture</strong>: Smart ASCII detection with Unicode parsing only when needed</li>
<li><strong>Memory Efficiency</strong>: In-place processing reduces allocations and improves cache performance</li>
</ul>
<p><strong>Performance Impact:</strong></p>
<ul>
<li><strong>Whitespace-heavy code</strong>: 18-22% faster processing through batch character handling</li>
<li><strong>Operator-dense expressions</strong>: 14-15% improvement in disambiguation performance</li>
<li><strong>String interpolation</strong>: 22% faster variable extraction in template contexts</li>
<li><strong>Overall lexing throughput</strong>: Compound improvements across all parsing scenarios</li>
</ul>
<h3 id="api-surface"><a class="header" href="#api-surface">API Surface</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct PerlLexer&lt;'a&gt; { ... }

impl&lt;'a&gt; PerlLexer&lt;'a&gt; {
    pub fn new(input: &amp;'a str) -&gt; Self;
    pub fn with_heredoc_recovery(input: &amp;'a str) -&gt; Self;
    pub fn next_token(&amp;mut self) -&gt; Option&lt;Token&gt;;
}

pub struct Token {
    pub token_type: TokenType,
    pub text: String,
    pub start: usize,
    pub end: usize,
}
<span class="boring">}</span></code></pre></pre>
<h3 id="status"><a class="header" href="#status">Status</a></h3>
<p>âœ… <strong>Production Ready</strong> - Feature complete, exhaustively tested</p>
<h2 id="crate-2-perl-parser---the-structure"><a class="header" href="#crate-2-perl-parser---the-structure">Crate 2: <code>perl-parser</code> - The Structure</a></h2>
<h3 id="purpose-1"><a class="header" href="#purpose-1">Purpose</a></h3>
<p>Transform the token stream from <code>perl-lexer</code> into a structured Abstract Syntax Tree (AST).</p>
<h3 id="key-features-1"><a class="header" href="#key-features-1">Key Features</a></h3>
<ul>
<li><strong>Clean token consumption</strong> via adapter layer</li>
<li><strong>Recursive descent</strong> with operator precedence</li>
<li><strong>Incremental parsing</strong> with Rope-based document management for real-time editing âœ¨</li>
<li><strong>Enhanced scope analysis</strong> with advanced variable pattern recognition âœ¨</li>
<li><strong>Production-ready Rope integration</strong> for UTF-16/UTF-8 position conversion âœ¨</li>
<li><strong>Tree-sitter compatible</strong> S-expression output</li>
<li><strong>Error recovery</strong> for resilient parsing</li>
</ul>
<h3 id="enhanced-scope-analysis-"><a class="header" href="#enhanced-scope-analysis-">Enhanced Scope Analysis âœ¨</a></h3>
<p>The <code>perl-parser</code> crate includes advanced scope analysis capabilities:</p>
<ul>
<li><strong>Complex variable pattern recognition</strong>: <code>$hash{key}</code> â†’ <code>%hash</code>, <code>$array[idx]</code> â†’ <code>@array</code></li>
<li><strong>Method call resolution</strong>: <code>$obj-&gt;method</code> â†’ base <code>$obj</code> variable</li>
<li><strong>Hash key context detection</strong>: Reduces false bareword warnings in subscript contexts</li>
<li><strong>Recursive fallback resolution</strong>: Handles nested and complex variable patterns</li>
<li><strong>Enhanced diagnostics</strong>: Improved undefined variable detection under <code>use strict</code></li>
</ul>
<h3 id="rope-based-document-management-"><a class="header" href="#rope-based-document-management-">Rope-based Document Management âœ¨</a></h3>
<p>The <code>perl-parser</code> crate includes production-ready Rope integration for efficient text handling:</p>
<ul>
<li><strong>UTF-16/UTF-8 position conversion</strong>: Accurate LSP protocol compliance with <code>ropey::Rope</code></li>
<li><strong>Line ending support</strong>: CRLF, LF, CR, and mixed line ending detection and handling</li>
<li><strong>Incremental document updates</strong>: Efficient text edits using Ropeâ€™s piece table architecture</li>
<li><strong>Unicode support</strong>: Proper handling of emoji, surrogate pairs, and variable-width characters</li>
<li><strong>Performance optimization</strong>: Sub-millisecond position conversions and document updates</li>
</ul>
<h3 id="api-surface-1"><a class="header" href="#api-surface-1">API Surface</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Parser&lt;'a&gt; { ... }

impl&lt;'a&gt; Parser&lt;'a&gt; {
    pub fn new(input: &amp;'a str) -&gt; Self;
    pub fn parse(&amp;mut self) -&gt; Result&lt;Node, ParseError&gt;;
}

pub struct Node {
    pub kind: NodeKind,
    pub location: SourceLocation,
}

impl Node {
    pub fn to_sexp(&amp;self) -&gt; String;
}
<span class="boring">}</span></code></pre></pre>
<h3 id="status-1"><a class="header" href="#status-1">Status</a></h3>
<p>ğŸš§ <strong>Architecturally Complete</strong> - Core design proven, implementation in progress</p>
<h2 id="benefits-of-this-architecture"><a class="header" href="#benefits-of-this-architecture">Benefits of This Architecture</a></h2>
<h3 id="1-enforced-separation-of-concerns"><a class="header" href="#1-enforced-separation-of-concerns">1. Enforced Separation of Concerns</a></h3>
<p>The crate boundary enforces a clean API. The parser cannot access lexer internals, ensuring proper abstraction.</p>
<h3 id="2-independent-reusability"><a class="header" href="#2-independent-reusability">2. Independent Reusability</a></h3>
<ul>
<li>Use <code>perl-lexer</code> alone for syntax highlighting</li>
<li>Build alternative parsers on the same lexer</li>
<li>Create specialized tools that only need tokens</li>
</ul>
<h3 id="3-testability"><a class="header" href="#3-testability">3. Testability</a></h3>
<ul>
<li>Test lexer with simple token assertions</li>
<li>Test parser with mock token streams</li>
<li>Clear boundaries make debugging trivial</li>
</ul>
<h3 id="4-performance-optimization"><a class="header" href="#4-performance-optimization">4. Performance Optimization</a></h3>
<ul>
<li>Profile lexer and parser independently</li>
<li>Optimize the bottleneck without affecting the other component</li>
<li>Enable parallel processing strategies</li>
</ul>
<h3 id="5-maintenance"><a class="header" href="#5-maintenance">5. Maintenance</a></h3>
<ul>
<li>Changes to lexing logic donâ€™t affect parsing</li>
<li>Parser improvements donâ€™t risk breaking tokenization</li>
<li>Clear ownership and responsibility</li>
</ul>
<h2 id="three-way-performance-comparison"><a class="header" href="#three-way-performance-comparison">Three-Way Performance Comparison</a></h2>
<p>This architecture enables scientific comparison between three implementations:</p>
<div class="table-wrapper"><table><thead><tr><th>Implementation</th><th>Architecture</th><th>Safety</th><th>Performance</th><th>Use Case</th></tr></thead><tbody>
<tr><td><strong>Legacy C</strong></td><td>Monolithic C + Tree-sitter</td><td>âŒ Unsafe</td><td>~50 Âµs (baseline)</td><td>Existing tools</td></tr>
<tr><td><strong>Pest Monolith</strong></td><td>Single Rust crate with PEG</td><td>âœ… Safe</td><td>~300 Âµs (6x slower)</td><td>Test oracle</td></tr>
<tr><td><strong>Modern Stack</strong></td><td>perl-lexer + perl-parser</td><td>âœ… Safe</td><td>~150 Âµs (3x slower)*</td><td>New tools</td></tr>
</tbody></table>
</div>
<p>*Estimated based on architectural efficiency</p>
<h3 id="comprehensive-benchmark-framework-v088--new"><a class="header" href="#comprehensive-benchmark-framework-v088--new">Comprehensive Benchmark Framework (v0.8.8) â­ <strong>NEW</strong></a></h3>
<p>The project now includes an enterprise-grade cross-language benchmark framework that provides systematic performance validation:</p>
<p><strong>Framework Components:</strong></p>
<ul>
<li><strong>Rust Benchmark Runner</strong> - Statistical analysis with confidence intervals</li>
<li><strong>C Benchmark Harness</strong> - Node.js-based benchmarking for C implementation</li>
<li><strong>Statistical Comparison Generator</strong> - Python-based analysis with performance gates</li>
<li><strong>Integration Layer</strong> - Orchestrates complete benchmark workflow</li>
</ul>
<p><strong>Performance Validation Features:</strong></p>
<ul>
<li><strong>Statistical Significance Testing</strong> - Confidence intervals and regression detection</li>
<li><strong>Configurable Performance Gates</strong> - 5% parse time, 20% memory regression thresholds</li>
<li><strong>Automated CI/CD Integration</strong> - Fail builds on performance regressions</li>
<li><strong>Comprehensive Reporting</strong> - Markdown and JSON outputs with detailed analysis</li>
</ul>
<p><strong>Usage Example:</strong></p>
<pre><code class="language-bash"># Run complete cross-language benchmark suite
cargo xtask bench

# Generate statistical comparison with custom thresholds  
python3 scripts/generate_comparison.py \
  --c-results c_benchmark.json \
  --rust-results rust_benchmark.json \
  --parse-threshold 3.0 \
  --memory-threshold 15.0
</code></pre>
<p>This framework enables data-driven performance optimization and ensures no performance regressions across implementations (<strong>Diataxis: How-to</strong>).</p>
<h2 id="integration-points"><a class="header" href="#integration-points">Integration Points</a></h2>
<h3 id="for-tree-sitter-compatibility"><a class="header" href="#for-tree-sitter-compatibility">For Tree-sitter Compatibility</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// In tree-sitter-perl-rs
use perl_lexer::PerlLexer;

extern "C" fn tree_sitter_perl_external_scanner_scan(...) {
    let mut lexer = PerlLexer::new(source);
    // Adapt tokens for tree-sitter
}
<span class="boring">}</span></code></pre></pre>
<h3 id="for-native-rust-tools"><a class="header" href="#for-native-rust-tools">For Native Rust Tools</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// In a Perl analyzer
use perl_parser::{Parser, NodeKind};

let mut parser = Parser::new(source);
match parser.parse() {
    Ok(ast) =&gt; analyze_ast(&amp;ast),
    Err(e) =&gt; report_error(e),
}
<span class="boring">}</span></code></pre></pre>
<h3 id="for-custom-processing"><a class="header" href="#for-custom-processing">For Custom Processing</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// In a syntax highlighter
use perl_lexer::{PerlLexer, TokenType};

let mut lexer = PerlLexer::new(source);
while let Some(token) = lexer.next_token() {
    highlight_token(&amp;token);
}
<span class="boring">}</span></code></pre></pre>
<h2 id="migration-path"><a class="header" href="#migration-path">Migration Path</a></h2>
<p>For projects currently using the monolithic approach:</p>
<ol>
<li><strong>Phase 1</strong>: Use <code>perl-lexer</code> as a drop-in replacement for tokenization</li>
<li><strong>Phase 2</strong>: Gradually migrate parsing logic to use token stream</li>
<li><strong>Phase 3</strong>: Fully adopt <code>perl-parser</code> for AST generation</li>
</ol>
<h2 id="future-extensions"><a class="header" href="#future-extensions">Future Extensions</a></h2>
<p>This architecture enables:</p>
<ul>
<li><strong>Incremental parsing</strong> by tracking token positions</li>
<li><strong>Parallel parsing</strong> of independent code sections</li>
<li><strong>Language server</strong> protocol implementation</li>
<li><strong>Code formatting</strong> with token preservation</li>
<li><strong>Static analysis</strong> on the AST</li>
</ul>
<h2 id="document-management-layer-rope-integration-v087"><a class="header" href="#document-management-layer-rope-integration-v087">Document Management Layer: Rope Integration (v0.8.7)</a></h2>
<p>The perl-parser crate includes a comprehensive <strong>Rope-based document management layer</strong> for efficient text operations and LSP integration:</p>
<h3 id="architecture"><a class="header" href="#architecture">Architecture</a></h3>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LSP Client    â”‚  â”€â”€&gt;    â”‚   Rope-based    â”‚  â”€â”€&gt;    â”‚  perl-parser    â”‚
â”‚   (UTF-16)      â”‚         â”‚ Position Mapper â”‚         â”‚ (UTF-8 bytes)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚                            â”‚
                                     â–¼                            â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ Incremental     â”‚         â”‚ IncrementalDoc  â”‚
                            â”‚ Edit Handling   â”‚         â”‚ with Subtree    â”‚
                            â”‚                 â”‚         â”‚ Reuse           â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="key-components-diataxis-reference"><a class="header" href="#key-components-diataxis-reference">Key Components (<strong>Diataxis: Reference</strong>)</a></h3>
<h4 id="rope-based-position-management"><a class="header" href="#rope-based-position-management">Rope-based Position Management</a></h4>
<ul>
<li><strong><code>textdoc.rs</code></strong>: Core <code>Doc</code> struct with <code>ropey::Rope</code> for efficient text storage</li>
<li><strong><code>position_mapper.rs</code></strong>: Centralized UTF-16 â†” UTF-8 conversion with line ending detection</li>
<li><strong>Multi-platform support</strong>: Windows (CRLF), Unix (LF), Classic Mac (CR), Mixed line endings</li>
<li><strong>Unicode handling</strong>: Proper emoji and surrogate pair support</li>
</ul>
<h4 id="lsp-integration-bridge"><a class="header" href="#lsp-integration-bridge">LSP Integration Bridge</a></h4>
<ul>
<li><strong><code>incremental_integration.rs</code></strong>: Bridge between LSP change events and incremental parsing</li>
<li><strong><code>incremental_handler_v2.rs</code></strong>: Enhanced document change processing using Rope operations</li>
<li><strong>Automatic fallback</strong>: Graceful degradation to full parsing when needed</li>
</ul>
<h3 id="benefits-diataxis-explanation"><a class="header" href="#benefits-diataxis-explanation">Benefits (<strong>Diataxis: Explanation</strong>)</a></h3>
<ul>
<li><strong>Efficient text operations</strong>: Ropeâ€™s piece table architecture optimizes insertions/deletions</li>
<li><strong>Accurate position mapping</strong>: Eliminates UTF-16/UTF-8 conversion bugs common in LSP servers</li>
<li><strong>Real-time editing support</strong>: Sub-millisecond document updates with incremental parsing</li>
<li><strong>Cross-platform compatibility</strong>: Handles all line ending styles correctly</li>
</ul>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>The modern architecture with Rope integration represents the mature, professional approach to building language tooling. It provides:</p>
<ul>
<li>Clear separation of concerns between lexing, parsing, and document management</li>
<li>Maximum reusability across different editor integrations</li>
<li>Optimal testability with comprehensive position conversion validation</li>
<li>Scientific comparability with performance benchmarks</li>
<li>Future extensibility with clean abstraction boundaries</li>
<li><strong>Production-ready document management</strong> with industry-standard Rope data structures</li>
</ul>
<p>This is not just a parser implementationâ€”itâ€™s a <strong>platform for Perl tooling innovation</strong> with enterprise-grade document handling.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../architecture/dap-implementation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../developer/contributing.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../architecture/dap-implementation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../developer/contributing.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
