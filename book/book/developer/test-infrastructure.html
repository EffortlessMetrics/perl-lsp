<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Test Infrastructure - Perl LSP Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Comprehensive documentation for the perl-lsp project - a production-ready Perl Language Server Protocol implementation">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Perl LSP Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/EffortlessMetrics/tree-sitter-perl-rs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="test-infrastructure-guide"><a class="header" href="#test-infrastructure-guide">Test Infrastructure Guide</a></h1>
<blockquote>
<p>This guide follows the <strong><a href="https://diataxis.fr/">Diataxis framework</a></strong> for comprehensive technical documentation:</p>
<ul>
<li><strong>Tutorial sections</strong>: Hands-on learning with test execution examples</li>
<li><strong>How-to sections</strong>: Step-by-step guidance for specific testing scenarios</li>
<li><strong>Reference sections</strong>: Complete technical specifications and test categories</li>
<li><strong>Explanation sections</strong>: Design concepts and testing philosophy</li>
</ul>
</blockquote>
<h2 id="table-of-contents"><a class="header" href="#table-of-contents">Table of Contents</a></h2>
<ol>
<li><a href="#test-categories">Test Categories</a></li>
<li><a href="#test-discovery-protocol">Test Discovery Protocol</a></li>
<li><a href="#timeout-strategy">Timeout Strategy</a></li>
<li><a href="#nextest-configuration">Nextest Configuration</a></li>
<li><a href="#known-flaky-tests">Known Flaky Tests</a></li>
<li><a href="#environment-variables">Environment Variables</a></li>
<li><a href="#running-tests-locally-vs-ci">Running Tests Locally vs CI</a></li>
<li><a href="#test-quality-assurance">Test Quality Assurance</a></li>
</ol>
<hr />
<h2 id="test-categories"><a class="header" href="#test-categories">Test Categories</a></h2>
<h3 id="overview-diataxis-reference"><a class="header" href="#overview-diataxis-reference">Overview (<em>Diataxis: Reference</em>)</a></h3>
<p>The Perl LSP project uses a comprehensive multi-tiered testing strategy with ~720 baseline tests across unit, integration, property-based, and E2E categories:</p>
<pre><code>┌─────────────────────────────────────────────────────────┐
│                 Test Pyramid Structure                  │
├─────────────────────────────────────────────────────────┤
│  E2E Tests (~50)           │ Full workflow validation   │
│  Integration Tests (~200)  │ LSP protocol compliance    │
│  Property Tests (~100)     │ Invariant verification     │
│  Unit Tests (~370)         │ Component isolation        │
└─────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>Baseline Test Count</strong>: 720 tests (as of 2025-12-31)</p>
<ul>
<li><strong>perl-lexer</strong>: 12 tests</li>
<li><strong>perl-parser</strong>: 324 tests (lib tests only)</li>
<li><strong>perl-lsp</strong>: 37 tests (lib tests only)</li>
<li><strong>perl-dap</strong>: 9 tests</li>
<li><strong>Integration tests</strong>: ~338+ additional tests in test files</li>
</ul>
<p><strong>5% Drop Threshold</strong>: If test count falls below 684 tests (720 × 0.95), investigate for accidentally disabled or deleted tests.</p>
<h3 id="1-unit-tests-diataxis-tutorial"><a class="header" href="#1-unit-tests-diataxis-tutorial">1. Unit Tests (<em>Diataxis: Tutorial</em>)</a></h3>
<p><strong>Purpose</strong>: Fast, isolated component testing with millisecond execution times.</p>
<p><strong>Location</strong>: <code>crates/*/src/</code> (inline <code>#[cfg(test)]</code> modules) and <code>crates/*/tests/*_test.rs</code></p>
<p><strong>Examples</strong>:</p>
<pre><code class="language-bash"># Run all unit tests across workspace
cargo test --workspace --lib

# Run parser unit tests only
cargo test -p perl-parser --lib

# Run specific unit test module
cargo test -p perl-parser semantic::tests
</code></pre>
<p><strong>Characteristics</strong>:</p>
<ul>
<li><strong>Execution time</strong>: &lt;1ms per test typically</li>
<li><strong>Parallelization</strong>: Safe to run with unlimited threads</li>
<li><strong>Dependencies</strong>: No external services or I/O</li>
<li><strong>Coverage</strong>: Core parsing, semantic analysis, utility functions</li>
</ul>
<p><strong>Key Test Modules</strong>:</p>
<ul>
<li>Parser unit tests: <code>/crates/perl-parser/src/lib.rs</code> (semantic analysis, AST validation)</li>
<li>Lexer unit tests: <code>/crates/perl-lexer/src/lib.rs</code> (tokenization, Unicode handling)</li>
<li>LSP unit tests: <code>/crates/perl-lsp/src/lib.rs</code> (protocol handling, state management)</li>
</ul>
<h3 id="2-integration-tests-diataxis-tutorial"><a class="header" href="#2-integration-tests-diataxis-tutorial">2. Integration Tests (<em>Diataxis: Tutorial</em>)</a></h3>
<p><strong>Purpose</strong>: Test component interactions, LSP protocol compliance, and cross-module behavior.</p>
<p><strong>Location</strong>: <code>crates/perl-lsp/tests/lsp_*.rs</code> and <code>crates/perl-parser/tests/*_tests.rs</code></p>
<p><strong>Examples</strong>:</p>
<pre><code class="language-bash"># Run all LSP integration tests (with adaptive threading)
RUST_TEST_THREADS=2 cargo test -p perl-lsp -- --test-threads=2

# Run specific integration test suite
cargo test -p perl-lsp --test lsp_comprehensive_e2e_test

# Run parser integration tests
cargo test -p perl-parser --test substitution_fixed_tests
</code></pre>
<p><strong>Characteristics</strong>:</p>
<ul>
<li><strong>Execution time</strong>: 10ms-500ms per test</li>
<li><strong>Parallelization</strong>: Requires thread management (RUST_TEST_THREADS=2 recommended)</li>
<li><strong>Dependencies</strong>: LSP server process, file I/O, workspace indexing</li>
<li><strong>Coverage</strong>: LSP features, cross-file navigation, refactoring operations</li>
</ul>
<p><strong>Key Test Files</strong>:</p>
<ul>
<li><code>lsp_comprehensive_e2e_test.rs</code>: Full LSP workflow validation</li>
<li><code>lsp_behavioral_tests.rs</code>: LSP feature behavior (0.31s with RUST_TEST_THREADS=2)</li>
<li><code>lsp_full_coverage_user_stories.rs</code>: User story validation (0.32s with RUST_TEST_THREADS=2)</li>
<li><code>semantic_definition.rs</code>: Semantic-aware go-to-definition tests</li>
</ul>
<h3 id="3-property-based-tests-diataxis-tutorial"><a class="header" href="#3-property-based-tests-diataxis-tutorial">3. Property-Based Tests (<em>Diataxis: Tutorial</em>)</a></h3>
<p><strong>Purpose</strong>: Validate invariants across randomly generated inputs using proptest framework.</p>
<p><strong>Location</strong>: <code>crates/*/tests/prop_*.rs</code> and <code>crates/*/tests/fuzz_*.rs</code></p>
<p><strong>Examples</strong>:</p>
<pre><code class="language-bash"># Run all property-based tests
cargo test -p perl-parser prop_

# Run specific property test suite
cargo test -p perl-parser --test prop_whitespace_idempotence

# Run fuzzing tests with bounded iterations
cargo test -p perl-parser --test fuzz_quote_parser_comprehensive
</code></pre>
<p><strong>Characteristics</strong>:</p>
<ul>
<li><strong>Execution time</strong>: 100ms-5s per test (depends on iterations)</li>
<li><strong>Parallelization</strong>: CPU-intensive, benefits from multiple cores</li>
<li><strong>Dependencies</strong>: Proptest crate, regression file management</li>
<li><strong>Coverage</strong>: Parser invariants, Unicode handling, incremental parsing</li>
</ul>
<p><strong>Key Test Categories</strong>:</p>
<ul>
<li><strong>Parser Fuzzing</strong>: <code>fuzz_quote_parser_*.rs</code>, <code>fuzz_incremental_parsing.rs</code></li>
<li><strong>Position Tracking</strong>: <code>prop_position_utf16.rs</code> (UTF-16/UTF-8 conversion)</li>
<li><strong>Whitespace Handling</strong>: <code>prop_whitespace*.rs</code> (parsing idempotence)</li>
<li><strong>Quote-Like Operators</strong>: <code>prop_quote_like.rs</code>, <code>prop_qw.rs</code></li>
</ul>
<p><strong>Proptest Configuration</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Typical configuration in prop_*.rs files
proptest! {
    #![proptest_config(ProptestConfig {
        cases: 100,           // Number of test cases
        max_shrink_iters: 1000,
        timeout: 5000,        // 5 second timeout
        .. ProptestConfig::default()
    })]

    #[test]
    fn test_invariant(input in strategy()) {
        // Property verification
    }
}
<span class="boring">}</span></code></pre></pre>
<h3 id="4-end-to-end-e2e-tests-diataxis-tutorial"><a class="header" href="#4-end-to-end-e2e-tests-diataxis-tutorial">4. End-to-End (E2E) Tests (<em>Diataxis: Tutorial</em>)</a></h3>
<p><strong>Purpose</strong>: Full workflow validation including LSP server lifecycle, client communication, and workspace operations.</p>
<p><strong>Location</strong>: <code>crates/perl-lsp/tests/lsp_comprehensive_e2e_test.rs</code></p>
<p><strong>Examples</strong>:</p>
<pre><code class="language-bash"># Run comprehensive E2E test (maximum reliability)
RUST_TEST_THREADS=1 cargo test --test lsp_comprehensive_e2e_test

# Run with adaptive threading (faster)
RUST_TEST_THREADS=2 cargo test -p perl-lsp --test lsp_comprehensive_e2e_test -- --test-threads=2

# Run with debugging output
RUST_LOG=debug RUST_TEST_THREADS=1 cargo test -p perl-lsp --test lsp_comprehensive_e2e_test -- --nocapture
</code></pre>
<p><strong>Characteristics</strong>:</p>
<ul>
<li><strong>Execution time</strong>: 5s-60s per test suite</li>
<li><strong>Parallelization</strong>: Serial execution recommended (RUST_TEST_THREADS=1)</li>
<li><strong>Dependencies</strong>: Full LSP server, JSON-RPC protocol, workspace files</li>
<li><strong>Coverage</strong>: Complete LSP workflows, initialization, shutdown, error handling</li>
</ul>
<p><strong>Key Workflows Tested</strong>:</p>
<ol>
<li><strong>Initialization</strong>: Server startup, capability negotiation, workspace indexing</li>
<li><strong>Navigation</strong>: Go-to-definition, find references, call hierarchy</li>
<li><strong>Completion</strong>: Context-aware suggestions, documentation, detail formatting</li>
<li><strong>Refactoring</strong>: Rename, extract variable/subroutine, import optimization</li>
<li><strong>Diagnostics</strong>: Syntax errors, semantic warnings, code actions</li>
</ol>
<hr />
<h2 id="test-discovery-protocol"><a class="header" href="#test-discovery-protocol">Test Discovery Protocol</a></h2>
<h3 id="baseline-verification-diataxis-reference"><a class="header" href="#baseline-verification-diataxis-reference">Baseline Verification (<em>Diataxis: Reference</em>)</a></h3>
<p><strong>Current Baseline</strong>: 720 tests (workspace lib tests: 382 tests)</p>
<p><strong>Verification Commands</strong>:</p>
<pre><code class="language-bash"># Quick baseline check (lib tests only)
cargo test --workspace --lib 2&gt;&amp;1 | grep "test result:"

# Full test discovery (all targets)
cargo test --workspace --no-run 2&gt;&amp;1 | grep -E "(test|running)" | wc -l

# Per-crate breakdown
cargo test --workspace --lib -- --list | grep -c "^test"
</code></pre>
<p><strong>Expected Output</strong> (workspace lib tests):</p>
<pre><code>running 12 tests    # perl-lexer
running 37 tests    # perl-lsp
running 9 tests     # perl-dap
running 324 tests   # perl-parser
</code></pre>
<h3 id="test-count-monitoring-diataxis-how-to"><a class="header" href="#test-count-monitoring-diataxis-how-to">Test Count Monitoring (<em>Diataxis: How-to</em>)</a></h3>
<p><strong>5% Drop Threshold</strong>: Investigate if total test count falls below 684 tests.</p>
<p><strong>Automated Monitoring</strong>:</p>
<pre><code class="language-bash">#!/bin/bash
# Save as scripts/check-test-count.sh
BASELINE=720
THRESHOLD=$(echo "$BASELINE * 0.95" | bc | cut -d. -f1)

CURRENT=$(cargo test --workspace --lib -- --list 2&gt;/dev/null | grep -c "^test")

if [ "$CURRENT" -lt "$THRESHOLD" ]; then
    echo "::error::Test count dropped below threshold: $CURRENT &lt; $THRESHOLD (5% drop from $BASELINE)"
    exit 1
else
    echo "Test count OK: $CURRENT tests (baseline: $BASELINE, threshold: $THRESHOLD)"
fi
</code></pre>
<p><strong>CI Integration</strong>:</p>
<pre><code class="language-yaml"># Add to .github/workflows/ci.yml
- name: Verify test count (5% drop threshold)
  run: |
    BASELINE=720
    THRESHOLD=$((BASELINE * 95 / 100))
    CURRENT=$(cargo test --workspace --lib -- --list 2&gt;/dev/null | grep -c "^test" || echo 0)
    if [ "$CURRENT" -lt "$THRESHOLD" ]; then
      echo "::error::Test count dropped: $CURRENT &lt; $THRESHOLD"
      exit 1
    fi
</code></pre>
<hr />
<h2 id="timeout-strategy"><a class="header" href="#timeout-strategy">Timeout Strategy</a></h2>
<h3 id="adaptive-timeout-architecture-diataxis-explanation"><a class="header" href="#adaptive-timeout-architecture-diataxis-explanation">Adaptive Timeout Architecture (<em>Diataxis: Explanation</em>)</a></h3>
<p>The LSP server implements <strong>adaptive timeout scaling</strong> based on thread count detection, achieving <strong>5000x performance improvements</strong> in PR #140:</p>
<pre><code>┌─────────────────────────────────────────────────────────┐
│           Adaptive Timeout Decision Matrix              │
├─────────────────────────────────────────────────────────┤
│ Thread Count │ Timeout      │ Sleep Multiplier │ Use   │
├──────────────┼──────────────┼──────────────────┼───────┤
│ ≤2 threads   │ 15s (500ms*) │ 3x               │ CI    │
│ ≤4 threads   │ 10s (300ms*) │ 2x               │ Dev   │
│ 5-8 threads  │ 7.5s (200ms*)│ 1.5x             │ Local │
│ &gt;8 threads   │ 5s (200ms*)  │ 1x               │ Full  │
└──────────────┴──────────────┴──────────────────┴───────┘

* LSP harness millisecond-precision timeouts (see get_adaptive_timeout)
</code></pre>
<h3 id="multi-tier-timeout-system-diataxis-reference"><a class="header" href="#multi-tier-timeout-system-diataxis-reference">Multi-Tier Timeout System (<em>Diataxis: Reference</em>)</a></h3>
<h4 id="1-lsp-harness-timeouts-millisecond-precision"><a class="header" href="#1-lsp-harness-timeouts-millisecond-precision">1. LSP Harness Timeouts (Millisecond Precision)</a></h4>
<p><strong>Purpose</strong>: Fine-grained timeout control for LSP JSON-RPC message handling.</p>
<p><strong>Implementation</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Get adaptive timeout based on RUST_TEST_THREADS environment variable
fn get_adaptive_timeout(&amp;self) -&gt; Duration {
    let thread_count = std::env::var("RUST_TEST_THREADS")
        .ok()
        .and_then(|s| s.parse::&lt;usize&gt;().ok())
        .unwrap_or(4);

    match thread_count {
        0..=2 =&gt; Duration::from_millis(500), // High contention
        3..=4 =&gt; Duration::from_millis(300), // Medium contention
        _ =&gt; Duration::from_millis(200),     // Low contention
    }
}
<span class="boring">}</span></code></pre></pre>
<p><strong>Use Cases</strong>:</p>
<ul>
<li>JSON-RPC request/response cycles</li>
<li>LSP initialization handshake</li>
<li>Rapid message exchange in behavioral tests</li>
</ul>
<h4 id="2-comprehensive-test-timeouts-second-precision"><a class="header" href="#2-comprehensive-test-timeouts-second-precision">2. Comprehensive Test Timeouts (Second Precision)</a></h4>
<p><strong>Purpose</strong>: Broader timeout scaling for complete test execution.</p>
<p><strong>Scaling Formula</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn adaptive_timeout() -&gt; Duration {
    let base_timeout = Duration::from_secs(5);
    let thread_count = max_concurrent_threads();

    match thread_count {
        0..=2 =&gt; base_timeout * 3,   // 15s for heavily constrained
        3..=4 =&gt; base_timeout * 2,   // 10s for moderately constrained
        5..=8 =&gt; base_timeout * 3/2, // 7.5s for lightly constrained
        _ =&gt; base_timeout,           // 5s for unconstrained
    }
}
<span class="boring">}</span></code></pre></pre>
<p><strong>Performance Results</strong> (PR #140):</p>
<pre><code>Before Adaptive Timeouts          After Adaptive Timeouts (RUST_TEST_THREADS=2)
─────────────────────────────────  ─────────────────────────────────────────────
lsp_behavioral_tests: 1560s+    →  0.31s (5000x faster, Revolutionary)
lsp_user_stories: 1500s+        →  0.32s (4700x faster, Transformational)
Individual workspace tests: 60s →  0.26s (230x faster, Game-changing)
Overall test suite: 60s+        →  &lt;10s  (6x faster, Production-ready)
CI reliability: ~55% pass rate  →  100% pass rate (Zero timeouts)
</code></pre>
<h4 id="3-optimized-idle-detection"><a class="header" href="#3-optimized-idle-detection">3. Optimized Idle Detection</a></h4>
<p><strong>Before PR #140</strong>: 1000ms polling cycles
<strong>After PR #140</strong>: 200ms polling cycles (<strong>5x improvement</strong>)</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn wait_for_idle(&amp;self) {
    let sleep_duration = Duration::from_millis(200); // Optimized from 1000ms
    let thread_count = max_concurrent_threads();

    let multiplier = match thread_count {
        0..=2 =&gt; 3, // CI environments need longer stabilization
        3..=4 =&gt; 2,
        _ =&gt; 1,
    };

    std::thread::sleep(sleep_duration * multiplier);
}
<span class="boring">}</span></code></pre></pre>
<h3 id="timeout-configuration-best-practices-diataxis-how-to"><a class="header" href="#timeout-configuration-best-practices-diataxis-how-to">Timeout Configuration Best Practices (<em>Diataxis: How-to</em>)</a></h3>
<p><strong>For CI Environments</strong>:</p>
<pre><code class="language-bash"># GitHub Actions, GitLab CI, etc.
RUST_TEST_THREADS=2 cargo test -p perl-lsp -- --test-threads=2
</code></pre>
<p><strong>For Local Development</strong>:</p>
<pre><code class="language-bash"># Fast iteration (4 threads)
RUST_TEST_THREADS=4 cargo test -p perl-lsp

# Maximum reliability (serial)
RUST_TEST_THREADS=1 cargo test -p perl-lsp --test specific_test -- --nocapture
</code></pre>
<p><strong>For High-Performance Workstations</strong>:</p>
<pre><code class="language-bash"># Let system auto-detect (8+ threads)
cargo test --workspace

# Or explicitly set high thread count
RUST_TEST_THREADS=8 cargo test --workspace
</code></pre>
<hr />
<h2 id="nextest-configuration"><a class="header" href="#nextest-configuration">Nextest Configuration</a></h2>
<h3 id="overview-diataxis-reference-1"><a class="header" href="#overview-diataxis-reference-1">Overview (<em>Diataxis: Reference</em>)</a></h3>
<p>The project uses <strong>cargo-nextest</strong> for enhanced test execution with retry support, slow test detection, and thread management.</p>
<p><strong>Configuration File</strong>: <code>.cargo/nextest.toml</code></p>
<p><strong>Installation</strong>:</p>
<pre><code class="language-bash">cargo install cargo-nextest
</code></pre>
<h3 id="profiles-diataxis-reference"><a class="header" href="#profiles-diataxis-reference">Profiles (<em>Diataxis: Reference</em>)</a></h3>
<h4 id="1-default-profile-local-development"><a class="header" href="#1-default-profile-local-development">1. Default Profile (Local Development)</a></h4>
<pre><code class="language-toml">[profile.default]
retries = 0  # No retries for fast feedback
</code></pre>
<p><strong>Usage</strong>:</p>
<pre><code class="language-bash">cargo nextest run --workspace
</code></pre>
<h4 id="2-ci-profile-continuous-integration"><a class="header" href="#2-ci-profile-continuous-integration">2. CI Profile (Continuous Integration)</a></h4>
<pre><code class="language-toml">[profile.ci]
# Retry support for flaky tests
retries = 2
fail-fast = false

# Slow test detection
slow-timeout = { period = "60s", terminate-after = 2 }
leak-timeout = "10s"

[profile.ci.junit]
path = "target/nextest/ci/junit.xml"
</code></pre>
<p><strong>Usage</strong>:</p>
<pre><code class="language-bash">cargo nextest run --profile ci --workspace
</code></pre>
<p><strong>Features</strong>:</p>
<ul>
<li><strong>Retries</strong>: Up to 2 retries for flaky tests</li>
<li><strong>Slow Timeout</strong>: Warn if tests exceed 60s, terminate after 2 occurrences</li>
<li><strong>JUnit Reports</strong>: Generate XML reports for CI integration</li>
</ul>
<h4 id="3-lsp-integration-test-overrides"><a class="header" href="#3-lsp-integration-test-overrides">3. LSP Integration Test Overrides</a></h4>
<pre><code class="language-toml">[profile.ci.overrides]
# LSP tests need more time in CI
filter = 'package(perl-lsp)'
slow-timeout = { period = "120s", terminate-after = 3 }
threads-required = 2
</code></pre>
<p><strong>Why 120s?</strong>: Accounts for:</p>
<ol>
<li>LSP server initialization (5-10s)</li>
<li>Workspace indexing (10-30s for large codebases)</li>
<li>JSON-RPC message exchange (5-10s)</li>
<li>Graceful shutdown (2-5s)</li>
<li>CI environment overhead (2-3x local execution time)</li>
</ol>
<h4 id="4-cancellation-test-overrides"><a class="header" href="#4-cancellation-test-overrides">4. Cancellation Test Overrides</a></h4>
<pre><code class="language-toml">[[profile.ci.overrides]]
filter = 'test(lsp_cancel)'
threads-required = 1
retries = 3
</code></pre>
<p><strong>Rationale</strong>: Cancellation tests require careful thread management to validate race condition handling.</p>
<h3 id="flaky-test-retry-configuration-diataxis-reference"><a class="header" href="#flaky-test-retry-configuration-diataxis-reference">Flaky Test Retry Configuration (<em>Diataxis: Reference</em>)</a></h3>
<pre><code class="language-toml"># Known flaky BrokenPipe tests get extra retries
[[profile.ci.overrides]]
filter = 'test(lsp_document_symbols) | test(lsp_document_links) | test(lsp_encoding)'
retries = 3
</code></pre>
<p><strong>Why Extra Retries?</strong>: These tests occasionally experience BrokenPipe errors during LSP server teardown in constrained CI environments (see <a href="#known-flaky-tests">Known Flaky Tests</a>).</p>
<h3 id="local-fast-profile"><a class="header" href="#local-fast-profile">Local Fast Profile</a></h3>
<pre><code class="language-toml">[profile.local-fast]
test-threads = 4
retries = 0
</code></pre>
<p><strong>Usage</strong>:</p>
<pre><code class="language-bash">cargo nextest run --profile local-fast --workspace
</code></pre>
<p><strong>Purpose</strong>: Rapid iteration during development with balanced parallelization.</p>
<hr />
<h2 id="known-flaky-tests"><a class="header" href="#known-flaky-tests">Known Flaky Tests</a></h2>
<h3 id="overview-diataxis-explanation"><a class="header" href="#overview-diataxis-explanation">Overview (<em>Diataxis: Explanation</em>)</a></h3>
<p>Most historical “BrokenPipe” test failures were environmental/timing issues, now fully resolved by:</p>
<ol>
<li>Adaptive threading configuration (RUST_TEST_THREADS=2)</li>
<li>Enhanced LSP harness with graceful shutdown handling</li>
<li>Proper connection lifecycle management</li>
</ol>
<p><strong>Current Status</strong> (run <code>bash scripts/ignored-test-count.sh</code> for live counts):</p>
<ul>
<li><strong>Tracked test debt</strong>: BUG=0, MANUAL=1 (utility only)</li>
<li><strong>Non-default lanes</strong>: Feature-gated tests run with <code>--all-features</code> or specific feature flags</li>
<li><strong>Baseline</strong>: <code>scripts/.ignored-baseline</code></li>
</ul>
<h3 id="known-flaky-test-categories-diataxis-reference"><a class="header" href="#known-flaky-test-categories-diataxis-reference">Known Flaky Test Categories (<em>Diataxis: Reference</em>)</a></h3>
<h4 id="1-lsp-document-symbols-lsp_document_symbols_testrs"><a class="header" href="#1-lsp-document-symbols-lsp_document_symbols_testrs">1. LSP Document Symbols (<code>lsp_document_symbols_test.rs</code>)</a></h4>
<p><strong>Symptom</strong>: Occasional BrokenPipe errors during teardown</p>
<p><strong>Root Cause</strong>: Race condition between:</p>
<ol>
<li>Test requesting document symbols</li>
<li>LSP server processing workspace index</li>
<li>Test harness initiating shutdown before response sent</li>
</ol>
<p><strong>Mitigation</strong>:</p>
<pre><code class="language-toml">[[profile.ci.overrides]]
filter = 'test(lsp_document_symbols)'
retries = 3
slow-timeout = { period = "120s", terminate-after = 3 }
</code></pre>
<p><strong>Workaround</strong>:</p>
<pre><code class="language-bash"># Run with serial execution for 100% reliability
RUST_TEST_THREADS=1 cargo test -p perl-lsp --test lsp_document_symbols_test
</code></pre>
<h4 id="2-lsp-document-links-lsp_document_links_testrs"><a class="header" href="#2-lsp-document-links-lsp_document_links_testrs">2. LSP Document Links (<code>lsp_document_links_test.rs</code>)</a></h4>
<p><strong>Symptom</strong>: BrokenPipe during cross-file navigation analysis</p>
<p><strong>Root Cause</strong>: Workspace indexing still in progress when test requests document links</p>
<p><strong>Mitigation</strong>:</p>
<pre><code class="language-toml">[[profile.ci.overrides]]
filter = 'test(lsp_document_links)'
retries = 3
</code></pre>
<p><strong>Workaround</strong>:</p>
<pre><code class="language-bash"># Use enhanced wait_for_idle with 3x multiplier
RUST_TEST_THREADS=2 cargo test -p perl-lsp --test lsp_document_links_test -- --test-threads=2
</code></pre>
<h4 id="3-lsp-encoding-edge-cases-lsp_encoding_edge_casesrs"><a class="header" href="#3-lsp-encoding-edge-cases-lsp_encoding_edge_casesrs">3. LSP Encoding Edge Cases (<code>lsp_encoding_edge_cases.rs</code>)</a></h4>
<p><strong>Symptom</strong>: Intermittent failures with UTF-16/UTF-8 position conversion</p>
<p><strong>Root Cause</strong>: Timing-sensitive Unicode boundary calculations during rapid message exchange</p>
<p><strong>Current Status</strong>: Tests pass reliably with RUST_TEST_THREADS=2. <code>#[ignore]</code> annotations removed during the Wave C cleanup (PR #261).</p>
<p><strong>Mitigation</strong>:</p>
<pre><code class="language-toml">[[profile.ci.overrides]]
filter = 'test(lsp_encoding)'
retries = 3
</code></pre>
<p><strong>Verification</strong>:</p>
<pre><code class="language-bash"># Remove #[ignore] and validate
cargo test -p perl-lsp --test lsp_encoding_edge_cases -- --nocapture
</code></pre>
<h3 id="brokenpipe-error-handling-diataxis-how-to"><a class="header" href="#brokenpipe-error-handling-diataxis-how-to">BrokenPipe Error Handling (<em>Diataxis: How-to</em>)</a></h3>
<p><strong>Understanding BrokenPipe Errors</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Connection closed - BrokenPipe or similar transport termination
pub enum LspErrorKind {
    ConnectionClosed, // Maps to ErrorCode::ConnectionClosed (-32050)
    // ...
}

/// BrokenPipe → CONNECTION_CLOSED (-32050)
impl From&lt;io::Error&gt; for LspError {
    fn from(e: io::Error) -&gt; Self {
        if e.kind() == io::ErrorKind::BrokenPipe {
            LspError::connection_closed("BrokenPipe during communication")
        } else {
            LspError::transport_failed(e.to_string())
        }
    }
}
<span class="boring">}</span></code></pre></pre>
<p><strong>Graceful Shutdown Pattern</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Ignore write errors during teardown - BrokenPipe is expected
let _ = writer.write_all(shutdown_request.as_bytes());
let _ = writer.flush();

// Allow time for graceful shutdown before forceful termination
std::thread::sleep(Duration::from_millis(100));
<span class="boring">}</span></code></pre></pre>
<p><strong>Testing BrokenPipe Resilience</strong>:</p>
<pre><code class="language-bash"># Torture test for connection handling
cargo test -p perl-lsp --test lsp_init_torture_test -- --nocapture
</code></pre>
<hr />
<h2 id="environment-variables"><a class="header" href="#environment-variables">Environment Variables</a></h2>
<h3 id="rust_test_threads-diataxis-reference"><a class="header" href="#rust_test_threads-diataxis-reference">RUST_TEST_THREADS (<em>Diataxis: Reference</em>)</a></h3>
<p><strong>Revolutionary Enhancement in PR #140</strong>: Adaptive threading achieving 5000x performance gains in CI.</p>
<p><strong>Purpose</strong>: Control test parallelism and trigger adaptive timeout scaling.</p>
<p><strong>Values</strong>:</p>
<ul>
<li><code>RUST_TEST_THREADS=1</code>: Serial execution (maximum reliability)</li>
<li><code>RUST_TEST_THREADS=2</code>: CI optimal (recommended for GitHub Actions)</li>
<li><code>RUST_TEST_THREADS=4</code>: Balanced development (default if unset)</li>
<li><code>RUST_TEST_THREADS=8+</code>: High-performance workstations</li>
</ul>
<p><strong>Examples</strong>:</p>
<pre><code class="language-bash"># CI configuration (GitHub Actions)
RUST_TEST_THREADS=2 cargo test -p perl-lsp -- --test-threads=2

# Development (fast iteration)
RUST_TEST_THREADS=4 cargo test --workspace

# Debugging (serial, full output)
RUST_TEST_THREADS=1 cargo test -p perl-lsp --test specific_test -- --nocapture
</code></pre>
<p><strong>Implementation</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn max_concurrent_threads() -&gt; usize {
    std::env::var("RUST_TEST_THREADS")
        .ok()
        .and_then(|s| s.parse::&lt;usize&gt;().ok())
        .unwrap_or_else(|| {
            std::thread::available_parallelism().map(|n| n.get()).unwrap_or(8)
        })
        .max(1)
}
<span class="boring">}</span></code></pre></pre>
<h3 id="lsp_test_fallbacks-diataxis-reference"><a class="header" href="#lsp_test_fallbacks-diataxis-reference">LSP_TEST_FALLBACKS (<em>Diataxis: Reference</em>)</a></h3>
<p><strong>NEW in v0.8.8</strong>: Fast testing mode reducing timeouts by 75% (2000ms → 500ms).</p>
<p><strong>Purpose</strong>: Enable rapid testing with mock responses for CI/development iteration.</p>
<p><strong>Values</strong>:</p>
<ul>
<li><code>LSP_TEST_FALLBACKS=1</code>: Enabled (fast mode)</li>
<li>Unset: Disabled (full validation mode)</li>
</ul>
<p><strong>Examples</strong>:</p>
<pre><code class="language-bash"># Fast workspace validation (&lt;10s total)
LSP_TEST_FALLBACKS=1 cargo test --workspace

# Combine with adaptive threading
RUST_TEST_THREADS=2 LSP_TEST_FALLBACKS=1 cargo test -p perl-lsp -- --test-threads=2

# Quick build verification
LSP_TEST_FALLBACKS=1 cargo check --workspace
</code></pre>
<p><strong>Behavior</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let use_fallback = std::env::var("LSP_TEST_FALLBACKS").is_ok();

if use_fallback {
    // Fast mode: 500ms timeout, mock responses
    Duration::from_millis(500)
} else {
    // Full mode: Adaptive timeout (5s-15s), real LSP server
    adaptive_timeout()
}
<span class="boring">}</span></code></pre></pre>
<p><strong>Use Cases</strong>:</p>
<ul>
<li>Pre-commit checks (fast feedback)</li>
<li>CI gate validation (2-5 min total)</li>
<li>Development iteration (rapid test cycles)</li>
</ul>
<h3 id="run_real_world-diataxis-reference"><a class="header" href="#run_real_world-diataxis-reference">RUN_REAL_WORLD (<em>Diataxis: Reference</em>)</a></h3>
<p><strong>Purpose</strong>: Enable expensive real-world corpus testing (disabled by default).</p>
<p><strong>Values</strong>:</p>
<ul>
<li><code>RUN_REAL_WORLD=1</code>: Run real-world corpus tests</li>
<li>Unset: Skip real-world tests (default)</li>
</ul>
<p><strong>Examples</strong>:</p>
<pre><code class="language-bash"># Run comprehensive corpus validation (15-30 min)
RUN_REAL_WORLD=1 cargo test -p perl-corpus

# Combine with threading for parallel corpus parsing
RUN_REAL_WORLD=1 RUST_TEST_THREADS=8 cargo test -p perl-corpus
</code></pre>
<p><strong>Corpus Size</strong>:</p>
<ul>
<li>~10,000+ Perl files from CPAN modules</li>
<li>~5MB+ of Perl source code</li>
<li>Edge case coverage: heredocs, Unicode, operator precedence</li>
</ul>
<h3 id="ci-diataxis-reference"><a class="header" href="#ci-diataxis-reference">CI (<em>Diataxis: Reference</em>)</a></h3>
<p><strong>Purpose</strong>: Detect CI environment and adjust test behavior.</p>
<p><strong>Values</strong>:</p>
<ul>
<li><code>CI=true</code>: Running in CI (GitHub Actions, GitLab CI)</li>
<li>Unset: Local development</li>
</ul>
<p><strong>Automatic Detection</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let is_ci = std::env::var("CI").is_ok();

if is_ci {
    // CI mode: Conservative timeouts, retry support
    adaptive_timeout() * 2
} else {
    // Local mode: Aggressive timeouts, fast feedback
    adaptive_timeout()
}
<span class="boring">}</span></code></pre></pre>
<p><strong>GitHub Actions Automatic Setting</strong>:</p>
<pre><code class="language-yaml"># Automatically set by GitHub Actions
env:
  CI: true
  RUST_TEST_THREADS: 2
</code></pre>
<h3 id="lsp_test_echo_stderr-diataxis-reference"><a class="header" href="#lsp_test_echo_stderr-diataxis-reference">LSP_TEST_ECHO_STDERR (<em>Diataxis: Reference</em>)</a></h3>
<p><strong>Purpose</strong>: Echo LSP server stderr to test output for debugging.</p>
<p><strong>Values</strong>:</p>
<ul>
<li><code>LSP_TEST_ECHO_STDERR=1</code>: Echo stderr</li>
<li>Unset: Silent stderr</li>
</ul>
<p><strong>Examples</strong>:</p>
<pre><code class="language-bash"># Debug LSP server communication
LSP_TEST_ECHO_STDERR=1 RUST_TEST_THREADS=2 cargo test -p perl-lsp -- --nocapture

# Combine with RUST_LOG for comprehensive debugging
RUST_LOG=debug LSP_TEST_ECHO_STDERR=1 cargo test -p perl-lsp --test specific_test -- --nocapture
</code></pre>
<h3 id="rust_log-diataxis-reference"><a class="header" href="#rust_log-diataxis-reference">RUST_LOG (<em>Diataxis: Reference</em>)</a></h3>
<p><strong>Purpose</strong>: Control tracing/logging output level.</p>
<p><strong>Values</strong>:</p>
<ul>
<li><code>RUST_LOG=error</code>: Errors only</li>
<li><code>RUST_LOG=warn</code>: Warnings and errors</li>
<li><code>RUST_LOG=info</code>: Informational messages</li>
<li><code>RUST_LOG=debug</code>: Detailed debugging</li>
<li><code>RUST_LOG=trace</code>: Verbose trace logging</li>
</ul>
<p><strong>Examples</strong>:</p>
<pre><code class="language-bash"># Debug test failures
RUST_LOG=debug cargo test -p perl-lsp --test failing_test -- --nocapture

# Trace LSP protocol messages
RUST_LOG=trace cargo test -p perl-lsp --test lsp_comprehensive_e2e_test -- --nocapture

# Module-specific logging
RUST_LOG=perl_parser::semantic=debug cargo test -p perl-parser
</code></pre>
<hr />
<h2 id="running-tests-locally-vs-ci"><a class="header" href="#running-tests-locally-vs-ci">Running Tests Locally vs CI</a></h2>
<h3 id="local-development-diataxis-how-to"><a class="header" href="#local-development-diataxis-how-to">Local Development (<em>Diataxis: How-to</em>)</a></h3>
<h4 id="quick-iteration-workflow"><a class="header" href="#quick-iteration-workflow">Quick Iteration Workflow</a></h4>
<pre><code class="language-bash"># 1. Fast unit tests (milliseconds)
cargo test --workspace --lib

# 2. Specific component testing
cargo test -p perl-parser --lib

# 3. Integration tests with fast mode
LSP_TEST_FALLBACKS=1 RUST_TEST_THREADS=4 cargo test -p perl-lsp

# 4. Full validation before commit
RUST_TEST_THREADS=2 cargo test -p perl-lsp -- --test-threads=2
</code></pre>
<h4 id="debugging-specific-test"><a class="header" href="#debugging-specific-test">Debugging Specific Test</a></h4>
<pre><code class="language-bash"># Serial execution with full output
RUST_TEST_THREADS=1 cargo test -p perl-lsp --test lsp_comprehensive_e2e_test \
    -- test_workspace_symbol_search --nocapture

# With debugging logs
RUST_LOG=debug RUST_TEST_THREADS=1 cargo test -p perl-lsp \
    --test semantic_definition -- --nocapture

# With LSP server stderr
LSP_TEST_ECHO_STDERR=1 RUST_LOG=debug cargo test -p perl-lsp \
    --test failing_test -- --nocapture
</code></pre>
<h4 id="performance-benchmarking"><a class="header" href="#performance-benchmarking">Performance Benchmarking</a></h4>
<pre><code class="language-bash"># Compare threading configurations
for threads in 1 2 4 8; do
    echo "Testing with $threads threads:"
    time RUST_TEST_THREADS=$threads cargo test -p perl-lsp
done

# Profile test execution
cargo nextest run --profile local-fast --workspace
</code></pre>
<h3 id="ci-environment-diataxis-how-to"><a class="header" href="#ci-environment-diataxis-how-to">CI Environment (<em>Diataxis: How-to</em>)</a></h3>
<h4 id="github-actions-configuration"><a class="header" href="#github-actions-configuration">GitHub Actions Configuration</a></h4>
<p><strong>Recommended Setup</strong>:</p>
<pre><code class="language-yaml">name: CI

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      RUST_TEST_THREADS: 2
      RUST_BACKTRACE: full
      CARGO_NET_RETRY: 4

    steps:
      # Supply-chain security: Pin third-party actions by commit SHA
      # Keep version tags in comments for readability; update SHAs on a schedule
      - uses: actions/checkout@&lt;COMMIT_SHA&gt; # v4
      - uses: dtolnay/rust-toolchain@&lt;COMMIT_SHA&gt; # stable
        with:
          toolchain: 1.90.0

      - uses: Swatinem/rust-cache@&lt;COMMIT_SHA&gt; # v2
        with:
          cache-on-failure: true

      # Fast gate: Unit tests (2-3 min)
      - name: Core tests
        run: cargo test --locked --workspace --lib

      # LSP integration tests (5-10 min)
      - name: LSP tests
        run: |
          RUST_TEST_THREADS=2 cargo test --locked -p perl-lsp -- --test-threads=2

      # Comprehensive E2E test (10-15 min)
      - name: E2E test
        run: |
          RUST_TEST_THREADS=2 cargo test -p perl-lsp \
            --test lsp_comprehensive_e2e_test -- --test-threads=2
</code></pre>
<h4 id="nextest-integration"><a class="header" href="#nextest-integration">Nextest Integration</a></h4>
<pre><code class="language-yaml">      - name: Install nextest
        run: cargo install cargo-nextest --locked

      - name: Run tests with nextest
        run: |
          cargo nextest run --profile ci --workspace \
            --junit target/nextest/ci/junit.xml

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@&lt;COMMIT_SHA&gt; # v2
        if: always()
        with:
          junit_files: target/nextest/ci/junit.xml
</code></pre>
<h4 id="gitlab-ci-configuration"><a class="header" href="#gitlab-ci-configuration">GitLab CI Configuration</a></h4>
<pre><code class="language-yaml">test:
  stage: test
  image: rust:1.90
  variables:
    RUST_TEST_THREADS: "2"
    CARGO_NET_RETRY: "4"
  script:
    - cargo test --locked --workspace --lib
    - RUST_TEST_THREADS=2 cargo test -p perl-lsp -- --test-threads=2
  artifacts:
    reports:
      junit: target/nextest/ci/junit.xml
</code></pre>
<h3 id="justfile-recipes-diataxis-how-to"><a class="header" href="#justfile-recipes-diataxis-how-to">Justfile Recipes (<em>Diataxis: How-to</em>)</a></h3>
<p>The project provides <strong>justfile</strong> recipes for standardized test execution:</p>
<pre><code class="language-bash"># Install just
cargo install just

# Fast merge gate (~2-5 min) - REQUIRED for all merges
just ci-gate

# Full CI pipeline (~10-20 min) - RECOMMENDED for large changes
just ci-full

# Individual gates
just ci-format          # Format check
just ci-clippy-lib      # Clippy (libraries only)
just ci-test-lib        # Library tests
just ci-lsp-def         # LSP semantic definition tests

# Development commands
just build              # Build all workspace crates
just test               # Run all tests
just fmt                # Format code
just health             # Show codebase health metrics
</code></pre>
<p><strong>Fast Merge Gate</strong> (<code>just ci-gate</code>):</p>
<pre><code class="language-bash"># Runs in 2-5 minutes
cargo fmt --check --all
cargo clippy --workspace --lib --locked -- -D warnings -A missing_docs
cargo test --workspace --lib --locked
RUSTC_WRAPPER="" RUST_TEST_THREADS=1 CARGO_BUILD_JOBS=1 \
    cargo test -p perl-lsp --test semantic_definition -- --test-threads=1
</code></pre>
<p><strong>Full CI Pipeline</strong> (<code>just ci-full</code>):</p>
<pre><code class="language-bash"># Runs in 10-20 minutes
cargo fmt --check --all
cargo clippy --workspace --all-targets -- -D warnings -A missing_docs
cargo test --workspace --lib --bins
RUST_TEST_THREADS=2 cargo test -p perl-lsp --test lsp_comprehensive_e2e_test -- --test-threads=2
cargo doc -p perl-parser -p perl-lsp --no-deps
</code></pre>
<hr />
<h2 id="test-quality-assurance"><a class="header" href="#test-quality-assurance">Test Quality Assurance</a></h2>
<h3 id="mutation-testing-diataxis-tutorial"><a class="header" href="#mutation-testing-diataxis-tutorial">Mutation Testing (<em>Diataxis: Tutorial</em>)</a></h3>
<p><strong>Purpose</strong>: Validate test effectiveness by introducing code mutations and ensuring tests fail.</p>
<p><strong>Installation</strong>:</p>
<pre><code class="language-bash">cargo install cargo-mutants
</code></pre>
<p><strong>Examples</strong>:</p>
<pre><code class="language-bash"># Run mutation tests on parser
cargo mutants --package perl-parser --timeout 300

# Specific mutation test suite
cargo test -p perl-parser --test mutation_hardening_tests

# With adaptive threading
RUST_TEST_THREADS=2 cargo test -p perl-parser --test mutation_hardening_tests
</code></pre>
<p><strong>Quality Metrics</strong>:</p>
<ul>
<li><strong>Mutation Score</strong>: 87% (improved from ~70% in PR #153)</li>
<li><strong>Test Suites</strong>: 7 mutation hardening test files</li>
<li><strong>Coverage</strong>: 147 tests for comprehensive edge case coverage</li>
</ul>
<p><strong>Key Test Files</strong>:</p>
<ul>
<li><code>mutation_hardening_tests.rs</code>: Core parser mutations (60%+ score improvement)</li>
<li><code>quote_parser_mutation_hardening.rs</code>: Quote operator edge cases</li>
<li><code>cancellation_atomic_operations_hardening.rs</code>: Concurrency mutations</li>
<li><code>documentation_validation_mutation_hardening.rs</code>: API documentation mutations</li>
</ul>
<h3 id="fuzz-testing-diataxis-tutorial"><a class="header" href="#fuzz-testing-diataxis-tutorial">Fuzz Testing (<em>Diataxis: Tutorial</em>)</a></h3>
<p><strong>Purpose</strong>: Property-based testing with crash detection and AST invariant validation.</p>
<p><strong>Examples</strong>:</p>
<pre><code class="language-bash"># Comprehensive quote parser fuzzing
cargo test -p perl-parser --test fuzz_quote_parser_comprehensive

# Incremental parsing stress testing
cargo test -p perl-parser --test fuzz_incremental_parsing

# Substitution operator fuzzing
cargo test -p perl-parser --test substitution_fuzz_tests
</code></pre>
<p><strong>Quality Metrics</strong>:</p>
<ul>
<li><strong>Test Suites</strong>: 12 fuzz testing files</li>
<li><strong>Coverage</strong>: Property-based testing, crash detection, AST invariants</li>
<li><strong>Regression Files</strong>: <code>.proptest-regressions/</code> directories track discovered issues</li>
</ul>
<p><strong>Key Test Files</strong>:</p>
<ul>
<li><code>fuzz_quote_parser_*.rs</code>: Quote operator fuzzing with delimiter handling</li>
<li><code>fuzz_incremental_parsing.rs</code>: Incremental parser stress testing</li>
<li><code>fuzz_documentation_infrastructure_pr159.rs</code>: Documentation infrastructure fuzzing</li>
</ul>
<h3 id="test-coverage-tracking-diataxis-how-to"><a class="header" href="#test-coverage-tracking-diataxis-how-to">Test Coverage Tracking (<em>Diataxis: How-to</em>)</a></h3>
<p><strong>Installation</strong>:</p>
<pre><code class="language-bash">cargo install cargo-tarpaulin
</code></pre>
<p><strong>Generate Coverage Report</strong>:</p>
<pre><code class="language-bash"># Full workspace coverage
cargo tarpaulin --workspace --out Html --output-dir target/coverage

# LSP-specific coverage
cargo tarpaulin -p perl-lsp --out Lcov --output-dir target/coverage/lsp

# Exclude property tests (reduce noise)
cargo tarpaulin --workspace --exclude-files '**/prop_*.rs' --out Html
</code></pre>
<p><strong>Expected Coverage</strong>:</p>
<ul>
<li><strong>Parser core</strong>: 85-90% line coverage</li>
<li><strong>LSP providers</strong>: 80-85% line coverage</li>
<li><strong>Integration tests</strong>: 70-75% feature coverage</li>
<li><strong>Property tests</strong>: 95%+ invariant coverage</li>
</ul>
<h3 id="test-hygiene-metrics-diataxis-reference"><a class="header" href="#test-hygiene-metrics-diataxis-reference">Test Hygiene Metrics (<em>Diataxis: Reference</em>)</a></h3>
<p><strong>Health Scoreboard</strong> (<code>just health</code>):</p>
<pre><code class="language-bash">📊 Codebase Health Scoreboard
==============================

📝 Ignored Tests by Crate:
  perl-parser: 45
  perl-lsp:    720 (87% BrokenPipe candidates for removal)
  perl-lexer:  3
  perl-dap:    0

⚠️  Unwrap/Expect Count (potential panic sites):
  .unwrap():  234
  .expect(:   89

🖨️  Debug Print Count (should use tracing):
  println!:   12
  eprintln!:  45
</code></pre>
<p><strong>Detailed Metrics</strong> (<code>just health-detail</code>):</p>
<pre><code class="language-bash">🔴 Top 10 files with most .unwrap() calls:
  crates/perl-parser/src/lsp_server.rs: 67
  crates/perl-parser/src/semantic.rs: 23
  ...

🟡 Top 10 files with most eprintln! calls:
  crates/perl-lsp/tests/common/mod.rs: 12
  ...
</code></pre>
<h3 id="test-documentation-standards-diataxis-reference"><a class="header" href="#test-documentation-standards-diataxis-reference">Test Documentation Standards (<em>Diataxis: Reference</em>)</a></h3>
<p><strong>Acceptance Criteria Validation</strong>:</p>
<pre><code class="language-bash"># Validate documentation acceptance criteria
cargo test -p perl-parser --test missing_docs_ac_tests

# Detailed validation output
cargo test -p perl-parser --test missing_docs_ac_tests -- --nocapture
</code></pre>
<p><strong>12 Acceptance Criteria</strong>:</p>
<ol>
<li>✅ Missing docs warning compilation enabled</li>
<li>⏳ Public functions documentation presence (Phase 1 target)</li>
<li>⏳ Public structs documentation presence (Phase 1 target)</li>
<li>⏳ Performance documentation presence (Phase 1 target)</li>
<li>⏳ Module-level documentation presence (Phase 1 target)</li>
<li>⏳ Usage examples in complex APIs (Phase 2 target)</li>
<li>✅ Doctests presence and execution validated</li>
<li>⏳ Error types documentation (Phase 1 target)</li>
<li>Cross-references using proper Rust linking</li>
<li>LSP workflow integration documentation</li>
<li>Enterprise-grade quality standards</li>
<li>CI integration and automated quality gates</li>
</ol>
<hr />
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<h3 id="quick-reference-card-diataxis-reference"><a class="header" href="#quick-reference-card-diataxis-reference">Quick Reference Card (<em>Diataxis: Reference</em>)</a></h3>
<pre><code class="language-bash"># Fastest validation (2-5 min)
just ci-gate

# Full CI validation (10-20 min)
just ci-full

# Local development (fast iteration)
LSP_TEST_FALLBACKS=1 RUST_TEST_THREADS=4 cargo test --workspace --lib

# Debug specific test
RUST_LOG=debug RUST_TEST_THREADS=1 cargo test -p perl-lsp --test failing_test -- --nocapture

# CI configuration
RUST_TEST_THREADS=2 cargo test -p perl-lsp -- --test-threads=2
</code></pre>
<h3 id="key-principles"><a class="header" href="#key-principles">Key Principles</a></h3>
<ol>
<li><strong>Adaptive Threading</strong>: Use <code>RUST_TEST_THREADS=2</code> for CI, <code>4+</code> for local development</li>
<li><strong>Fast Feedback</strong>: Enable <code>LSP_TEST_FALLBACKS=1</code> for rapid iteration</li>
<li><strong>Nextest Profiles</strong>: Use <code>--profile ci</code> for retry support and slow test detection</li>
<li><strong>Test Count Monitoring</strong>: Enforce 5% drop threshold (720 → 684 tests)</li>
<li><strong>Graceful Degradation</strong>: BrokenPipe errors are expected during teardown, not failures</li>
</ol>
<h3 id="test-execution-time-budget"><a class="header" href="#test-execution-time-budget">Test Execution Time Budget</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Category</th><th>Local Dev</th><th>CI (RUST_TEST_THREADS=2)</th></tr></thead><tbody>
<tr><td>Unit tests</td><td>&lt;1s</td><td>&lt;3s</td></tr>
<tr><td>Integration tests</td><td>5-10s</td><td>30-60s</td></tr>
<tr><td>E2E tests</td><td>10-20s</td><td>60-120s</td></tr>
<tr><td>Property tests</td><td>10-30s</td><td>60-180s</td></tr>
<tr><td><strong>Total</strong></td><td><strong>~30s</strong></td><td><strong>~5-10 min</strong></td></tr>
</tbody></table>
</div>
<hr />
<h2 id="related-documentation"><a class="header" href="#related-documentation">Related Documentation</a></h2>
<ul>
<li><strong><a href="THREADING_CONFIGURATION_GUIDE.html">Threading Configuration Guide</a></strong>: Adaptive threading deep dive</li>
<li><strong><a href="COMMANDS_REFERENCE.html">Commands Reference</a></strong>: Comprehensive build/test commands</li>
<li><strong><a href="CI.html">CI Documentation</a></strong>: CI/CD pipeline architecture</li>
<li><strong><a href="LSP_IMPLEMENTATION_GUIDE.html">LSP Implementation Guide</a></strong>: LSP testing patterns</li>
<li><strong><a href="ci/IGNORED_TESTS_INDEX.html">Ignored Tests Index</a></strong>: BrokenPipe test tracking</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../developer/testing-guide.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../developer/api-documentation-standards.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../developer/testing-guide.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../developer/api-documentation-standards.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
