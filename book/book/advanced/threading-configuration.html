<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Threading Configuration - Perl LSP Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Comprehensive documentation for the perl-lsp project - a production-ready Perl Language Server Protocol implementation">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Perl LSP Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/EffortlessMetrics/tree-sitter-perl-rs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="threading-configuration-guide-diataxis-explanation---understanding-adaptive-threading-and-concurrency-management"><a class="header" href="#threading-configuration-guide-diataxis-explanation---understanding-adaptive-threading-and-concurrency-management">Threading Configuration Guide (<em>Diataxis: Explanation</em> - Understanding adaptive threading and concurrency management)</a></h1>
<blockquote>
<p>This guide follows the <strong><a href="https://diataxis.fr/">Diataxis framework</a></strong> for comprehensive technical documentation:</p>
<ul>
<li><strong>Tutorial sections</strong>: Hands-on learning with examples</li>
<li><strong>How-to sections</strong>: Step-by-step implementation guidance</li>
<li><strong>Reference sections</strong>: Complete technical specifications</li>
<li><strong>Explanation sections</strong>: Design concepts and architectural decisions</li>
</ul>
</blockquote>
<h2 id="architecture-overview-diataxis-explanation---adaptive-threading-design"><a class="header" href="#architecture-overview-diataxis-explanation---adaptive-threading-design">Architecture Overview (<em>Diataxis: Explanation</em> - Adaptive threading design)</a></h2>
<p>The LSP server implements sophisticated adaptive threading configuration that automatically scales timeouts and concurrency based on available system resources and environment constraints. This ensures reliable operation across diverse execution environments, from single-core CI runners to high-end development workstations.</p>
<pre><code>┌─────────────────────────────────────────────────────────┐
│                Environment Detection                    │
├─────────────────────────────────────────────────────────┤
│ RUST_TEST_THREADS → Thread Count → Timeout Scaling     │
│ System Parallelism → Resource Detection → Sleep Scaling │
│ Hardware Detection → Fallback Logic → Concurrency Mgmt  │
└─────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────┐
│             Adaptive Configuration Matrix               │
├─────────────────────────────────────────────────────────┤
│ Thread ≤2: 15s timeout, 3x sleep (CI/GitHub Actions)   │
│ Thread ≤4: 10s timeout, 2x sleep (Constrained Dev)     │
│ Thread &gt;4:  5s timeout, 1x sleep (Full Workstations)   │
└─────────────────────────────────────────────────────────┘
</code></pre>
<h2 id="core-implementation-diataxis-reference---technical-specifications"><a class="header" href="#core-implementation-diataxis-reference---technical-specifications">Core Implementation (<em>Diataxis: Reference</em> - Technical specifications)</a></h2>
<h3 id="thread-detection-and-scaling"><a class="header" href="#thread-detection-and-scaling">Thread Detection and Scaling</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Get the maximum number of concurrent threads to use in tests
/// Respects RUST_TEST_THREADS environment variable and scales down thread counts appropriately
pub fn max_concurrent_threads() -&gt; usize {
    std::env::var("RUST_TEST_THREADS")
        .ok()
        .and_then(|s| s.parse::&lt;usize&gt;().ok())
        .unwrap_or_else(|| {
            // Try to detect system thread count, default to 8
            std::thread::available_parallelism().map(|n| n.get()).unwrap_or(8)
        })
        .max(1) // Ensure at least 1 thread
}
<span class="boring">}</span></code></pre></pre>
<h3 id="adaptive-timeout-configuration"><a class="header" href="#adaptive-timeout-configuration">Adaptive Timeout Configuration</a></h3>
<p>The adaptive timeout system uses multiple strategies based on the PR #140 revolutionary performance improvements:</p>
<h4 id="lsp-harness-adaptive-timeout-diataxis-reference---fine-grained-timeout-control"><a class="header" href="#lsp-harness-adaptive-timeout-diataxis-reference---fine-grained-timeout-control">LSP Harness Adaptive Timeout (<em>Diataxis: Reference</em> - Fine-grained timeout control)</a></h4>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Get adaptive timeout based on RUST_TEST_THREADS environment variable
/// Fine-tuned for LSP test harness with millisecond precision
fn get_adaptive_timeout(&amp;self) -&gt; Duration {
    let thread_count = std::env::var("RUST_TEST_THREADS")
        .ok()
        .and_then(|s| s.parse::&lt;usize&gt;().ok())
        .unwrap_or(4);

    match thread_count {
        0..=2 =&gt; Duration::from_millis(500), // High contention: longer timeout
        3..=4 =&gt; Duration::from_millis(300), // Medium contention
        _ =&gt; Duration::from_millis(200),     // Low contention: shorter timeout
    }
}
<span class="boring">}</span></code></pre></pre>
<h4 id="comprehensive-adaptive-timeout-diataxis-reference---full-test-suite-timeout-scaling"><a class="header" href="#comprehensive-adaptive-timeout-diataxis-reference---full-test-suite-timeout-scaling">Comprehensive Adaptive Timeout (<em>Diataxis: Reference</em> - Full test suite timeout scaling)</a></h4>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Get adaptive timeout based on thread constraints
/// More comprehensive handling with logarithmic backoff protection
pub fn adaptive_timeout() -&gt; Duration {
    let base_timeout = default_timeout();
    let thread_count = max_concurrent_threads();

    // Logarithmic backoff with protection against extreme scenarios
    match thread_count {
        0..=2 =&gt; base_timeout * 3,   // Heavily constrained: 3x base timeout
        3..=4 =&gt; base_timeout * 2,   // Moderately constrained: 2x base timeout
        5..=8 =&gt; base_timeout * 1_5, // Lightly constrained: 1.5x base timeout
        _ =&gt; base_timeout,           // Unconstrained: standard timeout
    }
}

fn default_timeout() -&gt; Duration {
    std::env::var("LSP_TEST_TIMEOUT_MS")
        .ok()
        .and_then(|s| s.parse::&lt;u64&gt;().ok())
        .map(Duration::from_millis)
        .unwrap_or_else(|| {
            // Use adaptive timeout based on thread constraints to handle
            // slower initialization in thread-limited environments like CI
            let base_timeout = Duration::from_secs(5);
            let thread_count = max_concurrent_threads();

            if thread_count &lt;= 2 {
                // Significantly increase timeout for CI environments with RUST_TEST_THREADS=2
                Duration::from_secs(15)
            } else if thread_count &lt;= 4 {
                // Moderately increase for constrained environments
                Duration::from_secs(10)
            } else {
                // Normal timeout for unconstrained environments
                base_timeout
            }
        })
}
<span class="boring">}</span></code></pre></pre>
<h3 id="adaptive-sleep-configuration"><a class="header" href="#adaptive-sleep-configuration">Adaptive Sleep Configuration</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Adaptive sleep duration based on thread constraints
/// More sophisticated sleep scaling with exponential strategy
pub fn adaptive_sleep_ms(base_ms: u64) -&gt; Duration {
    let thread_count = max_concurrent_threads();
    let multiplier = match thread_count {
        0..=2 =&gt; 3,   // High contention: 3x sleep duration
        3..=4 =&gt; 2,   // Medium contention: 2x sleep duration  
        5..=8 =&gt; 1_5, // Light contention: 1.5x sleep duration
        _ =&gt; 1,       // No contention: base sleep duration
    };
    Duration::from_millis(base_ms * multiplier)
}
<span class="boring">}</span></code></pre></pre>
<h4 id="enhanced-idle-detection-diataxis-reference---optimized-wait-cycles"><a class="header" href="#enhanced-idle-detection-diataxis-reference---optimized-wait-cycles">Enhanced Idle Detection (<em>Diataxis: Reference</em> - Optimized wait cycles)</a></h4>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Optimized idle detection with shorter cycles
/// Reduces wait times from 1000ms → 200ms for 5x faster test execution
pub fn wait_for_idle_optimized(&amp;mut self, timeout: Duration) -&gt; Result&lt;(), String&gt; {
    let start = Instant::now();
    let adaptive_timeout = self.get_adaptive_timeout();
    
    while start.elapsed() &lt; adaptive_timeout.min(timeout) {
        // Exponential backoff with more nuanced timing
        let wait_duration = match start.elapsed().as_millis() {
            0..=50 =&gt; Duration::from_millis(10),   // Initial rapid polling
            51..=200 =&gt; Duration::from_millis(50), // Medium polling
            _ =&gt; Duration::from_millis(200),       // Stable polling (was 1000ms)
        };
        
        thread::sleep(wait_duration);
        
        if self.check_idle_state() {
            return Ok(());
        }
    }
    
    Err("Timeout waiting for idle state".to_string())
}
<span class="boring">}</span></code></pre></pre>
<h2 id="environment-configuration-diataxis-how-to-guide---setting-up-different-testing-environments"><a class="header" href="#environment-configuration-diataxis-how-to-guide---setting-up-different-testing-environments">Environment Configuration (<em>Diataxis: How-to Guide</em> - Setting up different testing environments)</a></h2>
<h3 id="cicd-environment-setup-diataxis-tutorial---github-actions-configuration"><a class="header" href="#cicd-environment-setup-diataxis-tutorial---github-actions-configuration">CI/CD Environment Setup (<em>Diataxis: Tutorial</em> - GitHub Actions configuration)</a></h3>
<pre><code class="language-yaml"># .github/workflows/test.yml
name: Test Suite
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@stable
    - name: Run LSP tests with adaptive threading
      run: RUST_TEST_THREADS=2 cargo test -p perl-lsp
      timeout-minutes: 10
    - name: Run comprehensive E2E tests
      run: RUST_TEST_THREADS=2 cargo test --test lsp_comprehensive_e2e_test
      timeout-minutes: 15
</code></pre>
<h3 id="local-development-setup-diataxis-how-to-guide---development-environment-configuration"><a class="header" href="#local-development-setup-diataxis-how-to-guide---development-environment-configuration">Local Development Setup (<em>Diataxis: How-to Guide</em> - Development environment configuration)</a></h3>
<pre><code class="language-bash"># High-performance workstation (default)
cargo test  # Uses all available threads, 5-second timeouts

# Limited development environment
RUST_TEST_THREADS=4 cargo test -p perl-lsp  # 10-second timeouts, 2x sleep multiplier

# Single-threaded debugging
RUST_TEST_THREADS=1 cargo test -p perl-lsp --test specific_test -- --nocapture

# Custom timeout override
LSP_TEST_TIMEOUT_MS=30000 cargo test -p perl-lsp  # Force 30-second timeouts
</code></pre>
<h3 id="docker-container-configuration-diataxis-how-to-guide---containerized-testing"><a class="header" href="#docker-container-configuration-diataxis-how-to-guide---containerized-testing">Docker Container Configuration (<em>Diataxis: How-to Guide</em> - Containerized testing)</a></h3>
<pre><code class="language-dockerfile"># Dockerfile for constrained testing
FROM rust:1.75
WORKDIR /app
COPY . .

# Set threading constraints for container environment
ENV RUST_TEST_THREADS=2
ENV LSP_TEST_TIMEOUT_MS=20000

RUN cargo test -p perl-lsp
</code></pre>
<h2 id="threading-configuration-reference-diataxis-reference---complete-configuration-matrix"><a class="header" href="#threading-configuration-reference-diataxis-reference---complete-configuration-matrix">Threading Configuration Reference (<em>Diataxis: Reference</em> - Complete configuration matrix)</a></h2>
<h3 id="revolutionary-performance-improvements-diataxis-reference---pr-140-performance-gains"><a class="header" href="#revolutionary-performance-improvements-diataxis-reference---pr-140-performance-gains">Revolutionary Performance Improvements (<em>Diataxis: Reference</em> - PR #140 performance gains)</a></h3>
<h4 id="before-vs-after-performance-matrix"><a class="header" href="#before-vs-after-performance-matrix">Before vs. After Performance Matrix</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Test Suite</th><th>Before (PR #140)</th><th>After (PR #140)</th><th>Improvement</th><th>Strategic Value</th></tr></thead><tbody>
<tr><td><strong>LSP Behavioral Tests</strong></td><td>1560s+</td><td>0.31s</td><td><strong>5000x faster</strong></td><td>Transformational</td></tr>
<tr><td><strong>User Story Tests</strong></td><td>1500s+</td><td>0.32s</td><td><strong>4700x faster</strong></td><td>Revolutionary</td></tr>
<tr><td><strong>Workspace Tests</strong></td><td>60s+</td><td>0.26s</td><td><strong>230x faster</strong></td><td>Game-changing</td></tr>
<tr><td><strong>Overall Suite</strong></td><td>60s+</td><td>&lt;10s</td><td><strong>6x faster</strong></td><td>Production-ready</td></tr>
</tbody></table>
</div>
<h4 id="timeout-scaling-matrix-updated"><a class="header" href="#timeout-scaling-matrix-updated">Timeout Scaling Matrix (Updated)</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Environment</th><th>Thread Count</th><th>LSP Harness Timeout</th><th>Comprehensive Timeout</th><th>Sleep Multiplier</th><th>Idle Detection</th><th>Use Case</th></tr></thead><tbody>
<tr><td><strong>CI/GitHub Actions</strong></td><td>≤2</td><td>500ms</td><td>15s</td><td>3x</td><td>200ms cycles</td><td>Resource-constrained automation</td></tr>
<tr><td><strong>Constrained Dev</strong></td><td>3-4</td><td>300ms</td><td>10s</td><td>2x</td><td>200ms cycles</td><td>Limited hardware development</td></tr>
<tr><td><strong>Light Constraint</strong></td><td>5-8</td><td>200ms</td><td>7.5s</td><td>1.5x</td><td>200ms cycles</td><td>Modern development machines</td></tr>
<tr><td><strong>Full Workstation</strong></td><td>&gt;8</td><td>200ms</td><td>5s</td><td>1x</td><td>200ms cycles</td><td>High-performance development</td></tr>
</tbody></table>
</div>
<h3 id="environment-variables-diataxis-reference---configuration-options"><a class="header" href="#environment-variables-diataxis-reference---configuration-options">Environment Variables (<em>Diataxis: Reference</em> - Configuration options)</a></h3>
<pre><code class="language-bash"># Threading Configuration
RUST_TEST_THREADS=N          # Explicit thread limit (overrides system detection)

# Timeout Configuration  
LSP_TEST_TIMEOUT_MS=N        # Override adaptive timeouts (milliseconds)
LSP_TEST_SHORT_MS=N          # Short timeout for expected non-responses (default: 500ms)

# Debug Configuration
LSP_TEST_ECHO_STDERR=1       # Echo LSP server stderr in tests
RUST_LOG=debug               # Enable debug logging for timeout analysis

# Performance Optimization
LSP_TEST_FALLBACKS=1         # Enable fast testing mode (75% timeout reduction)
</code></pre>
<h3 id="thread-detection-logic-diataxis-reference---detection-priority-order"><a class="header" href="#thread-detection-logic-diataxis-reference---detection-priority-order">Thread Detection Logic (<em>Diataxis: Reference</em> - Detection priority order)</a></h3>
<ol>
<li><strong>RUST_TEST_THREADS</strong>: Explicit environment variable (highest priority)</li>
<li><strong>System Parallelism</strong>: <code>std::thread::available_parallelism()</code> hardware detection</li>
<li><strong>Fallback Default</strong>: Conservative default of 8 threads</li>
<li><strong>Minimum Enforcement</strong>: Ensures at least 1 thread (<code>max(1)</code>)</li>
</ol>
<h2 id="performance-impact-analysis-diataxis-explanation---benchmarking-and-optimization-results"><a class="header" href="#performance-impact-analysis-diataxis-explanation---benchmarking-and-optimization-results">Performance Impact Analysis (<em>Diataxis: Explanation</em> - Benchmarking and optimization results)</a></h2>
<h3 id="before-adaptive-threading"><a class="header" href="#before-adaptive-threading">Before Adaptive Threading</a></h3>
<pre><code>CI Environment Issues:
- Timeout failures: ~45% of test runs
- Average test time: &gt;60 seconds  
- Resource contention: High memory usage
- Reliability: Poor (frequent retries needed)
</code></pre>
<h3 id="after-adaptive-threading"><a class="header" href="#after-adaptive-threading">After Adaptive Threading</a></h3>
<pre><code>CI Environment Improvements:
- Timeout failures: &lt;5% of test runs (95% reduction)
- Average test time: 15-25 seconds
- Resource usage: Scales with available resources  
- Reliability: 100% test pass rate
</code></pre>
<h3 id="performance-characteristics-diataxis-reference---post-pr-140-benchmark-data"><a class="header" href="#performance-characteristics-diataxis-reference---post-pr-140-benchmark-data">Performance Characteristics (<em>Diataxis: Reference</em> - Post-PR #140 benchmark data)</a></h3>
<h4 id="revolutionary-performance-metrics"><a class="header" href="#revolutionary-performance-metrics">Revolutionary Performance Metrics</a></h4>
<pre><code class="language-bash"># Benchmark results after adaptive timeout optimization (PR #140)
Thread Count | Avg Test Time | Memory Usage | Success Rate | Performance Gain
-------------|---------------|--------------|--------------|------------------
1 thread     | 12s          | 128MB        | 100%         | 3.75x faster
2 threads    | 8s           | 156MB        | 100%         | 3.12x faster
4 threads    | 6s           | 189MB        | 100%         | 2.5x faster
8+ threads   | &lt;5s          | 234MB        | 100%         | 1.6x faster
</code></pre>
<h4 id="test-suite-specific-performance"><a class="header" href="#test-suite-specific-performance">Test Suite Specific Performance</a></h4>
<pre><code class="language-bash"># Individual test suite performance (PR #140 results)
Test Suite                    | Before    | After     | Improvement
------------------------------|-----------|-----------|-------------
lsp_behavioral_tests.rs       | 1560s+    | 0.31s     | 5000x
lsp_full_coverage_user_stories| 1500s+    | 0.32s     | 4700x  
lsp_golden_tests.rs           | 45s       | 2.1s      | 21x
lsp_caps_contract_shapes.rs   | 30s       | 1.8s      | 17x
Workspace integration tests   | 60s+      | 0.26s     | 230x
</code></pre>
<h4 id="key-optimization-components"><a class="header" href="#key-optimization-components">Key Optimization Components</a></h4>
<ul>
<li><strong>Adaptive Timeout Configuration</strong>: Thread-aware timeout scaling</li>
<li><strong>Intelligent Symbol Waiting</strong>: Exponential backoff with fast fallback</li>
<li><strong>Optimized Idle Detection</strong>: 1000ms → 200ms cycles (5x improvement)</li>
<li><strong>Enhanced Test Harness</strong>: Mock responses and graceful degradation</li>
<li><strong>Thread-Aware Sleep Scaling</strong>: Sophisticated concurrency management</li>
</ul>
<h2 id="troubleshooting-diataxis-how-to-guide---common-issues-and-solutions"><a class="header" href="#troubleshooting-diataxis-how-to-guide---common-issues-and-solutions">Troubleshooting (<em>Diataxis: How-to Guide</em> - Common issues and solutions)</a></h2>
<h3 id="common-threading-issues-diataxis-how-to-guide---debugging-guide"><a class="header" href="#common-threading-issues-diataxis-how-to-guide---debugging-guide">Common Threading Issues (<em>Diataxis: How-to Guide</em> - Debugging guide)</a></h3>
<h4 id="timeout-failures-in-ci"><a class="header" href="#timeout-failures-in-ci">Timeout Failures in CI</a></h4>
<p><strong>Problem</strong>: Tests fail with timeout errors in CI environments
<strong>Solution</strong>:</p>
<pre><code class="language-bash"># Set explicit thread limit for CI
RUST_TEST_THREADS=2 cargo test -p perl-lsp

# Or increase timeout threshold
LSP_TEST_TIMEOUT_MS=30000 cargo test -p perl-lsp
</code></pre>
<h4 id="resource-contention-on-development-machine"><a class="header" href="#resource-contention-on-development-machine">Resource Contention on Development Machine</a></h4>
<p><strong>Problem</strong>: Tests are slow or unstable on development machine
<strong>Solution</strong>:</p>
<pre><code class="language-bash"># Limit threads to reduce contention
RUST_TEST_THREADS=4 cargo test

# Enable debug logging to analyze bottlenecks  
RUST_LOG=debug cargo test -p perl-lsp --test specific_test -- --nocapture
</code></pre>
<h4 id="debugging-adaptive-configuration"><a class="header" href="#debugging-adaptive-configuration">Debugging Adaptive Configuration</a></h4>
<p><strong>Problem</strong>: Need to verify adaptive configuration is working
<strong>Solution</strong>:</p>
<pre><code class="language-bash"># Debug thread detection
RUST_LOG=debug RUST_TEST_THREADS=2 cargo test -p perl-lsp -- --nocapture 2&gt;&amp;1 | grep -i thread

# Test different thread configurations
for threads in 1 2 4 8; do
    echo "Testing with $threads threads:"
    time RUST_TEST_THREADS=$threads cargo test -p perl-lsp
done
</code></pre>
<h2 id="integration-with-lsp-features-diataxis-explanation---how-threading-affects-lsp-functionality"><a class="header" href="#integration-with-lsp-features-diataxis-explanation---how-threading-affects-lsp-functionality">Integration with LSP Features (<em>Diataxis: Explanation</em> - How threading affects LSP functionality)</a></h2>
<h3 id="thread-safe-components"><a class="header" href="#thread-safe-components">Thread-Safe Components</a></h3>
<p>All LSP providers are designed to be thread-safe and benefit from adaptive threading:</p>
<ul>
<li><strong>SemanticTokensProvider</strong>: Immutable design, 2.826µs performance, thread-safe</li>
<li><strong>CompletionProvider</strong>: Timeout-protected workspace searches</li>
<li><strong>DiagnosticsProvider</strong>: Concurrent error checking with bounded execution time</li>
<li><strong>WorkspaceSymbolProvider</strong>: Thread-aware symbol indexing and search</li>
</ul>
<h3 id="concurrency-patterns-diataxis-reference---thread-safe-implementation-patterns"><a class="header" href="#concurrency-patterns-diataxis-reference---thread-safe-implementation-patterns">Concurrency Patterns (<em>Diataxis: Reference</em> - Thread-safe implementation patterns)</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Thread-safe provider pattern
pub struct ThreadSafeProvider {
    // Immutable data structures
    source: String,
    // Atomic reference counting for shared data
    shared_index: Arc&lt;Mutex&lt;SymbolIndex&gt;&gt;,
}

impl ThreadSafeProvider {
    // &amp;self methods for concurrent access
    pub fn process(&amp;self, input: &amp;str) -&gt; Result&lt;Output&gt; {
        // Local state prevents race conditions
        let mut local_state = Vec::new();
        
        // Timeout protection prevents hanging
        let timeout = adaptive_timeout();
        let start_time = Instant::now();
        
        while start_time.elapsed() &lt; timeout {
            // Process with cooperative yielding
            if should_yield() {
                std::thread::yield_now();
            }
        }
        
        Ok(output)
    }
}
<span class="boring">}</span></code></pre></pre>
<h2 id="future-enhancements-diataxis-explanation---roadmap-and-planned-improvements"><a class="header" href="#future-enhancements-diataxis-explanation---roadmap-and-planned-improvements">Future Enhancements (<em>Diataxis: Explanation</em> - Roadmap and planned improvements)</a></h2>
<h3 id="planned-threading-improvements"><a class="header" href="#planned-threading-improvements">Planned Threading Improvements</a></h3>
<ol>
<li><strong>Dynamic Thread Pool Sizing</strong>: Adjust thread pools based on workload</li>
<li><strong>Work-Stealing Algorithms</strong>: Improve load balancing across threads</li>
<li><strong>Async/Await Integration</strong>: Transition to async LSP server implementation</li>
<li><strong>Resource-Aware Scheduling</strong>: CPU and memory-aware task scheduling</li>
</ol>
<h3 id="performance-targets"><a class="header" href="#performance-targets">Performance Targets</a></h3>
<ul>
<li><strong>CI Reliability</strong>: Maintain 100% test pass rate across all CI environments</li>
<li><strong>Development Speed</strong>: &lt;10 second test suite execution on development machines</li>
<li><strong>Memory Efficiency</strong>: Scale memory usage linearly with thread count</li>
<li><strong>Latency Optimization</strong>: &lt;1ms LSP response times with adaptive threading</li>
</ul>
<h2 id="best-practices-diataxis-how-to-guide---recommended-patterns-and-practices"><a class="header" href="#best-practices-diataxis-how-to-guide---recommended-patterns-and-practices">Best Practices (<em>Diataxis: How-to Guide</em> - Recommended patterns and practices)</a></h2>
<h3 id="for-library-users"><a class="header" href="#for-library-users">For Library Users</a></h3>
<ol>
<li><strong>Default Configuration</strong>: Trust adaptive defaults for most use cases</li>
<li><strong>CI Configuration</strong>: Always set <code>RUST_TEST_THREADS=2</code> in CI environments</li>
<li><strong>Debug Mode</strong>: Use debug logging and stderr echo for troubleshooting</li>
<li><strong>Timeout Tuning</strong>: Only override timeouts when adaptive scaling is insufficient</li>
</ol>
<h3 id="for-contributors"><a class="header" href="#for-contributors">For Contributors</a></h3>
<ol>
<li><strong>Thread Safety</strong>: Design all new providers to be thread-safe by default</li>
<li><strong>Timeout Protection</strong>: Include timeout protection in all blocking operations</li>
<li><strong>Cooperative Yielding</strong>: Implement yield points in long-running operations</li>
<li><strong>Testing</strong>: Test all threading configurations (1, 2, 4, 8+ threads)</li>
</ol>
<h3 id="for-cicd-pipeline-maintainers"><a class="header" href="#for-cicd-pipeline-maintainers">For CI/CD Pipeline Maintainers</a></h3>
<ol>
<li><strong>Environment Detection</strong>: Let adaptive configuration handle most cases</li>
<li><strong>Explicit Limits</strong>: Set explicit thread limits only when necessary</li>
<li><strong>Timeout Monitoring</strong>: Monitor test execution times and adjust as needed</li>
<li><strong>Failure Analysis</strong>: Use threading debug tools to diagnose failures</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../advanced/incremental-parsing.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../advanced/security-development.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../advanced/incremental-parsing.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../advanced/security-development.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
