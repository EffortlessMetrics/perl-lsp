<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>DAP Security - Perl LSP Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Comprehensive documentation for the perl-lsp project - a production-ready Perl Language Server Protocol implementation">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>‚Üê</kbd> or <kbd>‚Üí</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Perl LSP Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/EffortlessMetrics/tree-sitter-perl-rs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="dap-security-specification"><a class="header" href="#dap-security-specification">DAP Security Specification</a></h1>
<!-- Labels: security:enterprise, validation:comprehensive, compliance:maintained -->
<p><strong>Issue</strong>: #207 - Debug Adapter Protocol Support
<strong>Status</strong>: Security Requirements Complete
<strong>Version</strong>: 1.0.0
<strong>Date</strong>: 2025-10-04</p>
<hr />
<h2 id="executive-summary"><a class="header" href="#executive-summary">Executive Summary</a></h2>
<p>This specification defines comprehensive security requirements for the DAP implementation, aligned with existing enterprise security framework (<code>docs/SECURITY_DEVELOPMENT_GUIDE.md</code>). All security measures are testable via AC16 validation suite.</p>
<p><strong>Key Security Domains</strong>:</p>
<ol>
<li><strong>Path Traversal Prevention</strong>: Canonical path validation within workspace boundaries</li>
<li><strong>Safe Evaluation</strong>: Non-mutating eval default with explicit opt-in for side effects</li>
<li><strong>Timeout Enforcement</strong>: Hard timeouts preventing DoS from infinite loops</li>
<li><strong>Unicode Boundary Safety</strong>: Symmetric UTF-16 ‚Üî UTF-8 conversion (PR #153 infrastructure)</li>
<li><strong>Input Validation</strong>: Expression sanitization and code injection prevention</li>
</ol>
<p><strong>Compliance Target</strong>: Zero security findings in CI/CD security scanner gate (AC16)</p>
<hr />
<h2 id="1-path-traversal-prevention"><a class="header" href="#1-path-traversal-prevention">1. Path Traversal Prevention</a></h2>
<h3 id="11-threat-model"><a class="header" href="#11-threat-model">1.1 Threat Model</a></h3>
<p><strong>Attack Vector</strong>: Malicious breakpoint paths attempting directory traversal</p>
<p><strong>Examples</strong>:</p>
<ul>
<li><code>file:///workspace/../../../etc/passwd</code></li>
<li><code>file:///workspace/lib/../../sensitive_data.pl</code></li>
<li><code>\\server\share\..\..\..\etc\passwd</code> (Windows UNC)</li>
</ul>
<p><strong>Impact</strong>: Unauthorized file access, information disclosure</p>
<h3 id="12-defense-implementation"><a class="header" href="#12-defense-implementation">1.2 Defense Implementation</a></h3>
<h4 id="121-canonical-path-validation"><a class="header" href="#121-canonical-path-validation">1.2.1 Canonical Path Validation</a></h4>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/perl-dap/src/security/path_validator.rs
use std::path::{Path, PathBuf, Component};
use anyhow::{Result, bail};

/// Validate breakpoint path is within workspace boundaries
/// Aligned with docs/SECURITY_DEVELOPMENT_GUIDE.md
pub fn validate_breakpoint_path(uri: &amp;str, workspace_root: &amp;Path) -&gt; Result&lt;PathBuf&gt; {
    // Convert URI to filesystem path
    let path = uri_to_path(uri)?;

    // Canonicalize path (resolves symlinks, normalizes separators)
    let canonical = path.canonicalize()
        .map_err(|e| SecurityError::InvalidPath(format!("Cannot canonicalize {}: {}", uri, e)))?;

    // Ensure path is within workspace boundaries
    if !canonical.starts_with(workspace_root) {
        bail!(SecurityError::PathTraversalAttempt {
            requested: uri.to_string(),
            canonical: canonical.display().to_string(),
            workspace: workspace_root.display().to_string(),
        });
    }

    // Prevent directory traversal components
    if canonical.components().any(|c| c == Component::ParentDir) {
        bail!(SecurityError::PathTraversalAttempt {
            requested: uri.to_string(),
            canonical: canonical.display().to_string(),
            workspace: workspace_root.display().to_string(),
        });
    }

    Ok(canonical)
}

fn uri_to_path(uri: &amp;str) -&gt; Result&lt;PathBuf&gt; {
    // Parse file:// URI to filesystem path
    if let Some(path) = uri.strip_prefix("file://") {
        Ok(PathBuf::from(path))
    } else {
        bail!(SecurityError::InvalidUri(uri.to_string()))
    }
}

#[derive(Debug, thiserror::Error)]
pub enum SecurityError {
    #[error("Path traversal attempt: requested={requested}, canonical={canonical}, workspace={workspace}")]
    PathTraversalAttempt {
        requested: String,
        canonical: String,
        workspace: String,
    },

    #[error("Invalid URI: {0}")]
    InvalidUri(String),

    #[error("Invalid path: {0}")]
    InvalidPath(String),
}
<span class="boring">}</span></code></pre></pre>
<h4 id="122-platform-specific-validation"><a class="header" href="#122-platform-specific-validation">1.2.2 Platform-Specific Validation</a></h4>
<p><strong>Windows</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[cfg(windows)]
pub fn validate_windows_path(path: &amp;Path) -&gt; Result&lt;()&gt; {
    let path_str = path.to_str().ok_or(SecurityError::InvalidPath("Non-UTF8 path".to_string()))?;

    // Reject UNC paths with traversal
    if path_str.starts_with("\\\\") {
        if path_str.contains("..") {
            bail!(SecurityError::PathTraversalAttempt {
                requested: path_str.to_string(),
                canonical: "UNC path with traversal".to_string(),
                workspace: "N/A".to_string(),
            });
        }
    }

    // Normalize drive letter to uppercase
    if let Some((drive, rest)) = path_str.split_once(':') {
        if drive.len() != 1 || !drive.chars().next().unwrap().is_ascii_alphabetic() {
            bail!(SecurityError::InvalidPath(format!("Invalid drive letter: {}", drive)));
        }
    }

    Ok(())
}
<span class="boring">}</span></code></pre></pre>
<p><strong>Unix</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[cfg(unix)]
pub fn validate_unix_path(path: &amp;Path) -&gt; Result&lt;()&gt; {
    // Resolve symlinks
    let canonical = path.canonicalize()?;

    // Detect symlink pointing outside workspace
    if canonical != path &amp;&amp; !canonical.starts_with(workspace_root) {
        bail!(SecurityError::PathTraversalAttempt {
            requested: path.display().to_string(),
            canonical: canonical.display().to_string(),
            workspace: workspace_root.display().to_string(),
        });
    }

    Ok(())
}
<span class="boring">}</span></code></pre></pre>
<h3 id="13-test-coverage-ac16"><a class="header" href="#13-test-coverage-ac16">1.3 Test Coverage (AC16)</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/perl-dap/tests/security_validation.rs

#[test] // AC16
fn test_path_traversal_prevention() {
    let workspace = PathBuf::from("/workspace");
    let validator = PathValidator::new(workspace.clone());

    // Valid workspace paths
    assert!(validator.validate("file:///workspace/lib/Module.pm").is_ok());
    assert!(validator.validate("file:///workspace/script.pl").is_ok());

    // Path traversal attempts
    assert!(validator.validate("file:///workspace/../../../etc/passwd").is_err());
    assert!(validator.validate("file:///workspace/lib/../../sensitive.pl").is_err());
    assert!(validator.validate("file:///../workspace/script.pl").is_err());
}

#[test] // AC16 - Windows-specific
#[cfg(windows)]
fn test_windows_unc_path_validation() {
    let validator = PathValidator::new(PathBuf::from("C:\\workspace"));

    // Valid UNC path
    assert!(validator.validate("file://C:\\workspace\\lib\\Module.pm").is_ok());

    // UNC traversal attack
    assert!(validator.validate("file://\\\\server\\share\\..\\..\\sensitive").is_err());
}

#[test] // AC16 - Unix-specific
#[cfg(unix)]
fn test_unix_symlink_validation() {
    let workspace = PathBuf::from("/workspace");
    let validator = PathValidator::new(workspace.clone());

    // Create symlink pointing outside workspace
    std::fs::create_dir_all("/workspace/lib").unwrap();
    std::os::unix::fs::symlink("/etc/passwd", "/workspace/lib/passwd").unwrap();

    // Should reject symlink to /etc/passwd
    assert!(validator.validate("file:///workspace/lib/passwd").is_err());
}
<span class="boring">}</span></code></pre></pre>
<hr />
<h2 id="2-safe-evaluation"><a class="header" href="#2-safe-evaluation">2. Safe Evaluation</a></h2>
<h3 id="21-threat-model"><a class="header" href="#21-threat-model">2.1 Threat Model</a></h3>
<p><strong>Attack Vector</strong>: Malicious evaluate requests with side effects</p>
<p><strong>Examples</strong>:</p>
<ul>
<li><code>$var = 42</code> (assignment without opt-in)</li>
<li><code>system("rm -rf /")</code> (command injection)</li>
<li><code>eval { require 'dangerous.pm' }</code> (code loading)</li>
</ul>
<p><strong>Impact</strong>: Unintended state modification, code injection, privilege escalation</p>
<h3 id="22-defense-implementation"><a class="header" href="#22-defense-implementation">2.2 Defense Implementation</a></h3>
<h4 id="221-safe-evaluation-mode-default"><a class="header" href="#221-safe-evaluation-mode-default">2.2.1 Safe Evaluation Mode (Default)</a></h4>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/perl-dap/src/eval/safe_eval.rs
use anyhow::{Result, bail};
use tokio::time::timeout;
use std::time::Duration;

/// Evaluate expression with safety constraints (AC10)
/// Performance: &lt;5s timeout (default), configurable
pub async fn evaluate_expression(
    expr: &amp;str,
    context: &amp;StackFrame,
    allow_side_effects: bool,
    timeout_secs: u64,
) -&gt; Result&lt;EvaluationResult&gt; {
    // 1. Input validation
    validate_expression_safety(expr, allow_side_effects)?;

    // 2. Timeout enforcement (DoS prevention)
    let timeout_duration = Duration::from_secs(timeout_secs);

    let result = timeout(timeout_duration, async {
        if allow_side_effects {
            // Full evaluation with write access
            context.eval_with_side_effects(expr).await
        } else {
            // Safe evaluation: read-only mode
            context.eval_readonly(expr).await
        }
    }).await;

    match result {
        Ok(Ok(value)) =&gt; Ok(EvaluationResult::Success(value)),
        Ok(Err(e)) =&gt; Ok(EvaluationResult::Error(e.to_string())),
        Err(_) =&gt; bail!(SecurityError::EvaluationTimeout {
            expression: expr.to_string(),
            timeout_secs,
        }),
    }
}

/// Validate expression for side effects and injection attacks
fn validate_expression_safety(expr: &amp;str, allow_side_effects: bool) -&gt; Result&lt;()&gt; {
    // Check for assignment operators (side effects)
    if !allow_side_effects {
        let assignment_patterns = [
            "=(?![=~])",  // Assignment (not == or =~)
            r"\+=",        // Addition assignment
            r"-=",         // Subtraction assignment
            r"\*=",        // Multiplication assignment
            r"/=",         // Division assignment
            r"\.=",        // Concatenation assignment
        ];

        for pattern in &amp;assignment_patterns {
            if regex::Regex::new(pattern)?.is_match(expr) {
                bail!(SecurityError::SideEffectsNotAllowed {
                    expression: expr.to_string(),
                });
            }
        }
    }

    // Check for dangerous function calls
    let dangerous_patterns = [
        r"\bsystem\b",    // System command execution
        r"\bexec\b",      // Process replacement
        r"\beval\b",      // Dynamic code evaluation
        r"\brequire\b",   // Module loading
        r"\bdo\b",        // File evaluation
        r"\bopen\b",      // File opening (if not read-only)
    ];

    for pattern in &amp;dangerous_patterns {
        if regex::Regex::new(pattern)?.is_match(expr) {
            // Allow if explicit opt-in
            if !allow_side_effects {
                bail!(SecurityError::DangerousFunctionCall {
                    expression: expr.to_string(),
                    function: pattern.to_string(),
                });
            }
        }
    }

    Ok(())
}

#[derive(Debug, thiserror::Error)]
pub enum SecurityError {
    #[error("Side effects not allowed without allowSideEffects flag: {expression}")]
    SideEffectsNotAllowed { expression: String },

    #[error("Evaluation timeout after {timeout_secs}s: {expression}")]
    EvaluationTimeout { expression: String, timeout_secs: u64 },

    #[error("Dangerous function call not allowed: {function} in {expression}")]
    DangerousFunctionCall { expression: String, function: String },
}
<span class="boring">}</span></code></pre></pre>
<h4 id="222-perl-shim-safe-evaluation"><a class="header" href="#222-perl-shim-safe-evaluation">2.2.2 Perl Shim Safe Evaluation</a></h4>
<pre><code class="language-perl"># Devel/TSPerlDAP.pm
sub evaluate_expression {
    my ($args) = @_;
    my $expr = $args-&gt;{expression};
    my $frame_id = $args-&gt;{frameId};
    my $allow_side_effects = $args-&gt;{allowSideEffects} // 0;

    # Safe evaluation wrapper
    my $result;
    eval {
        # Timeout enforcement
        local $SIG{ALRM} = sub { die "Evaluation timeout\n" };
        alarm(5);  # 5 second default

        if ($allow_side_effects) {
            # Full evaluation with write access
            $result = eval $expr;
        } else {
            # Safe evaluation: check for assignment
            if ($expr =~ /=(?![=~])/) {
                die "Side effects not allowed without allowSideEffects flag\n";
            }

            # Safe.pm compartment (future enhancement)
            # my $cpt = Safe-&gt;new;
            # $result = $cpt-&gt;reval($expr);

            $result = eval $expr;
        }

        alarm(0);
    };

    if ($@) {
        return {
            success =&gt; 0,
            message =&gt; "Evaluation failed: $@",
        };
    }

    return {
        success =&gt; 1,
        result =&gt; render_value($result),
        type =&gt; ref($result) || 'scalar',
        variablesReference =&gt; is_expandable($result) ? allocate_ref($result) : 0,
    };
}
</code></pre>
<h3 id="23-test-coverage-ac16"><a class="header" href="#23-test-coverage-ac16">2.3 Test Coverage (AC16)</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/perl-dap/tests/security_validation.rs

#[test] // AC16
fn test_safe_eval_prevents_side_effects() {
    let frame = create_test_frame();

    // Read-only expressions (should succeed)
    assert!(evaluate_expression("$var + 10", &amp;frame, false, 5).await.is_ok());
    assert!(evaluate_expression("@array[0..2]", &amp;frame, false, 5).await.is_ok());
    assert!(evaluate_expression("$x == 42", &amp;frame, false, 5).await.is_ok());

    // Side effects without opt-in (should fail)
    assert!(evaluate_expression("$var = 42", &amp;frame, false, 5).await.is_err());
    assert!(evaluate_expression("$var += 10", &amp;frame, false, 5).await.is_err());
    assert!(evaluate_expression("system('ls')", &amp;frame, false, 5).await.is_err());

    // Explicit opt-in (should succeed)
    assert!(evaluate_expression("$var = 42", &amp;frame, true, 5).await.is_ok());
}

#[test] // AC16
fn test_eval_timeout_prevents_dos() {
    let frame = create_test_frame();

    // Infinite loop should timeout
    let result = evaluate_expression("while(1) {}", &amp;frame, true, 5).await;
    assert!(result.is_err());
    assert!(result.unwrap_err().to_string().contains("timeout"));

    // Recursive function should timeout
    let result = evaluate_expression("sub f { f() } f()", &amp;frame, true, 5).await;
    assert!(result.is_err());
}
<span class="boring">}</span></code></pre></pre>
<hr />
<h2 id="3-timeout-enforcement"><a class="header" href="#3-timeout-enforcement">3. Timeout Enforcement</a></h2>
<h3 id="31-configuration"><a class="header" href="#31-configuration">3.1 Configuration</a></h3>
<pre><code class="language-json">// VS Code settings.json
{
  "perl.dap.evaluateTimeout": 5,        // seconds (default: 5)
  "perl.dap.evaluateMaxDepth": 10,      // recursion depth limit
  "perl.dap.stepTimeout": 30,           // step operation timeout
  "perl.dap.continueTimeout": 300       // continue timeout (5 minutes)
}
</code></pre>
<h3 id="32-implementation"><a class="header" href="#32-implementation">3.2 Implementation</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/perl-dap/src/session.rs
pub struct DapSession {
    config: DapConfig,
    // ...
}

pub struct DapConfig {
    pub evaluate_timeout: u64,        // seconds
    pub evaluate_max_depth: u32,
    pub step_timeout: u64,
    pub continue_timeout: u64,
}

impl Default for DapConfig {
    fn default() -&gt; Self {
        Self {
            evaluate_timeout: 5,
            evaluate_max_depth: 10,
            step_timeout: 30,
            continue_timeout: 300,
        }
    }
}
<span class="boring">}</span></code></pre></pre>
<hr />
<h2 id="4-unicode-boundary-safety"><a class="header" href="#4-unicode-boundary-safety">4. Unicode Boundary Safety</a></h2>
<h3 id="41-threat-model"><a class="header" href="#41-threat-model">4.1 Threat Model</a></h3>
<p><strong>Attack Vector</strong>: UTF-16 boundary arithmetic overflow in variable rendering</p>
<p><strong>Example</strong>: Truncating multi-byte emoji at surrogate pair boundary</p>
<p><strong>Impact</strong>: Invalid UTF-8 output, potential crashes, information disclosure</p>
<h3 id="42-defense-implementation"><a class="header" href="#42-defense-implementation">4.2 Defense Implementation</a></h3>
<h4 id="421-symmetric-position-conversion-pr-153-reuse"><a class="header" href="#421-symmetric-position-conversion-pr-153-reuse">4.2.1 Symmetric Position Conversion (PR #153 Reuse)</a></h4>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/perl-dap/src/variables/renderer.rs
use ropey::Rope;
use lsp_types::Position;

/// Render variable value with UTF-16 safe truncation (AC8, AC16)
///
/// Implementation Note: UTF-16 boundary validation follows PR #153 symmetric conversion
/// patterns. The ensure_utf16_boundary utility will be implemented in perl-dap crate
/// using Rope's char_to_byte and byte_to_char methods to ensure valid UTF-16 code units.
pub fn render_variable_value(value: &amp;str, rope: &amp;Rope) -&gt; String {
    // Truncate large values (1KB preview max)
    if value.len() &gt; 1024 {
        // UTF-16 safe truncation - find nearest char boundary before 1024 bytes
        let safe_truncate = ensure_utf16_safe_truncation(value, 1024);
        format!("{}‚Ä¶", safe_truncate)
    } else {
        value.to_string()
    }
}

/// Ensure string truncation at UTF-16 code unit boundary (DAP-specific utility)
///
/// This function implements the symmetric position conversion strategy from PR #153
/// to prevent UTF-16 boundary arithmetic issues. It ensures the truncated string
/// ends at a valid UTF-16 code unit boundary, avoiding split surrogate pairs.
fn ensure_utf16_safe_truncation(s: &amp;str, max_bytes: usize) -&gt; &amp;str {
    if s.len() &lt;= max_bytes {
        return s;
    }

    // Find the largest char boundary &lt;= max_bytes
    let mut boundary = max_bytes;
    while boundary &gt; 0 &amp;&amp; !s.is_char_boundary(boundary) {
        boundary -= 1;
    }

    // Ensure we're not splitting a surrogate pair (UTF-16 consideration)
    // A surrogate pair in UTF-8 is represented as a 4-byte sequence
    let truncated = &amp;s[..boundary];

    // Check if the last char is a high surrogate (would be split)
    if let Some(last_char) = truncated.chars().last() {
        // High surrogates: U+D800 to U+DBFF
        // If last char requires &gt;3 bytes in UTF-8, it's part of a surrogate pair
        if last_char.len_utf8() == 4 {
            // Back up to the previous char boundary to avoid split
            let mut safe_boundary = boundary;
            while safe_boundary &gt; 0 {
                safe_boundary -= 1;
                if s.is_char_boundary(safe_boundary) {
                    return &amp;s[..safe_boundary];
                }
            }
        }
    }

    truncated
}

// Reuse existing position mapper for breakpoint positions
use perl_lsp::textdoc::{lsp_pos_to_byte, byte_to_lsp_pos, PosEnc};

pub fn dap_position_to_byte(rope: &amp;Rope, line: u32, column: u32) -&gt; Result&lt;usize&gt; {
    let pos = Position { line, character: column };
    lsp_pos_to_byte(rope, pos, PosEnc::Utf16)
}
<span class="boring">}</span></code></pre></pre>
<p><strong>Implementation Notes</strong>:</p>
<ul>
<li>UTF-16 safe truncation implemented directly in perl-dap crate (not in perl-parser)</li>
<li>Follows PR #153 symmetric conversion patterns for boundary validation</li>
<li>Prevents UTF-16 surrogate pair splitting during variable value truncation</li>
<li>Uses Rust‚Äôs <code>is_char_boundary()</code> for UTF-8 correctness</li>
<li>Additional surrogate pair check prevents high/low surrogate splits</li>
</ul>
<h3 id="43-test-coverage-ac16"><a class="header" href="#43-test-coverage-ac16">4.3 Test Coverage (AC16)</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/perl-dap/tests/security_validation.rs

#[test] // AC16
fn test_unicode_boundary_safety() {
    let rope = Rope::from_str("my $emoji = 'üòÄüë®‚Äçüë©‚Äçüëß‚Äçüë¶üéâ';");

    // Large unicode value should truncate safely
    let large_value = "üòÄ".repeat(500); // 2000 bytes (emoji are 4-byte UTF-8)
    let rendered = render_variable_value(&amp;large_value, &amp;rope);

    // Should not panic on UTF-16 boundary
    assert!(rendered.len() &lt;= 1024 + 1); // +1 for '‚Ä¶'
    assert!(rendered.ends_with('‚Ä¶'));
    assert!(is_valid_utf8(&amp;rendered));

    // Should not break emoji (surrogate pairs)
    assert!(!rendered.contains('\u{FFFD}')); // No replacement character
}

#[test] // AC16
fn test_position_conversion_symmetry() {
    let rope = Rope::from_str("sub emoji { return 'üòÄüéâ' }");

    // Test symmetric conversion
    let line = 0;
    let column = 10;

    let byte_offset = dap_position_to_byte(&amp;rope, line, column).unwrap();
    let (line2, column2) = byte_offset_to_dap_position(&amp;rope, byte_offset).unwrap();

    assert_eq!(line, line2);
    assert_eq!(column, column2);
}

fn is_valid_utf8(s: &amp;str) -&gt; bool {
    std::str::from_utf8(s.as_bytes()).is_ok()
}
<span class="boring">}</span></code></pre></pre>
<hr />
<h2 id="5-input-validation"><a class="header" href="#5-input-validation">5. Input Validation</a></h2>
<h3 id="51-expression-sanitization"><a class="header" href="#51-expression-sanitization">5.1 Expression Sanitization</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/perl-dap/src/eval/sanitizer.rs

/// Sanitize user input to prevent code injection
pub fn sanitize_expression(expr: &amp;str) -&gt; Result&lt;String&gt; {
    // 1. Trim whitespace
    let expr = expr.trim();

    // 2. Check maximum length (prevent memory exhaustion)
    if expr.len() &gt; 10_000 {
        bail!(SecurityError::ExpressionTooLong {
            length: expr.len(),
            max_length: 10_000,
        });
    }

    // 3. Validate balanced delimiters
    validate_balanced_delimiters(expr)?;

    Ok(expr.to_string())
}

fn validate_balanced_delimiters(expr: &amp;str) -&gt; Result&lt;()&gt; {
    let mut stack = Vec::new();

    for ch in expr.chars() {
        match ch {
            '(' | '[' | '{' =&gt; stack.push(ch),
            ')' =&gt; {
                if stack.pop() != Some('(') {
                    bail!(SecurityError::UnbalancedDelimiters);
                }
            },
            ']' =&gt; {
                if stack.pop() != Some('[') {
                    bail!(SecurityError::UnbalancedDelimiters);
                }
            },
            '}' =&gt; {
                if stack.pop() != Some('{') {
                    bail!(SecurityError::UnbalancedDelimiters);
                }
            },
            _ =&gt; {},
        }
    }

    if !stack.is_empty() {
        bail!(SecurityError::UnbalancedDelimiters);
    }

    Ok(())
}
<span class="boring">}</span></code></pre></pre>
<hr />
<h2 id="6-security-audit-checklist"><a class="header" href="#6-security-audit-checklist">6. Security Audit Checklist</a></h2>
<h3 id="61-pre-release-validation"><a class="header" href="#61-pre-release-validation">6.1 Pre-Release Validation</a></h3>
<p><strong>Path Security</strong> (AC16):</p>
<ul>
<li><input disabled="" type="checkbox"/>
All file paths canonicalized before use</li>
<li><input disabled="" type="checkbox"/>
Path traversal attempts rejected with error</li>
<li><input disabled="" type="checkbox"/>
Symlink resolution within workspace boundaries</li>
<li><input disabled="" type="checkbox"/>
UNC path validation (Windows)</li>
<li><input disabled="" type="checkbox"/>
WSL path translation validated</li>
</ul>
<p><strong>Evaluation Security</strong> (AC16):</p>
<ul>
<li><input disabled="" type="checkbox"/>
Default safe evaluation mode (no side effects)</li>
<li><input disabled="" type="checkbox"/>
Explicit <code>allowSideEffects</code> opt-in required</li>
<li><input disabled="" type="checkbox"/>
Timeout enforcement (&lt;5s default)</li>
<li><input disabled="" type="checkbox"/>
Dangerous function detection (system, exec, eval)</li>
<li><input disabled="" type="checkbox"/>
Input sanitization (delimiter balancing, length limits)</li>
</ul>
<p><strong>Unicode Security</strong> (AC16):</p>
<ul>
<li><input disabled="" type="checkbox"/>
UTF-16 ‚Üî UTF-8 conversion symmetric (PR #153)</li>
<li><input disabled="" type="checkbox"/>
Emoji and multi-byte character truncation safe</li>
<li><input disabled="" type="checkbox"/>
No surrogate pair splitting</li>
<li><input disabled="" type="checkbox"/>
Valid UTF-8 output always</li>
</ul>
<p><strong>DoS Prevention</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"/>
Evaluation timeout configurable</li>
<li><input disabled="" type="checkbox"/>
Recursion depth limits enforced</li>
<li><input disabled="" type="checkbox"/>
Memory limits for variable expansion</li>
<li><input disabled="" type="checkbox"/>
Large file handling (&gt;100K LOC)</li>
</ul>
<h3 id="62-continuous-validation"><a class="header" href="#62-continuous-validation">6.2 Continuous Validation</a></h3>
<p><strong>CI/CD Security Scanner</strong> (AC16):</p>
<pre><code class="language-bash"># Zero security findings requirement
cargo test -p perl-dap --test security_validation

# Expected: All tests passing
# - test_path_traversal_prevention: PASSED
# - test_safe_eval_prevents_side_effects: PASSED
# - test_eval_timeout_prevents_dos: PASSED
# - test_unicode_boundary_safety: PASSED
# - test_windows_unc_path_validation: PASSED (Windows)
# - test_unix_symlink_validation: PASSED (Unix)
</code></pre>
<p><strong>Dependency Auditing</strong>:</p>
<pre><code class="language-bash"># Check for known vulnerabilities
cargo audit -p perl-dap

# Expected: 0 vulnerabilities found
</code></pre>
<hr />
<h2 id="7-security-incident-response"><a class="header" href="#7-security-incident-response">7. Security Incident Response</a></h2>
<h3 id="71-vulnerability-reporting"><a class="header" href="#71-vulnerability-reporting">7.1 Vulnerability Reporting</a></h3>
<p><strong>Contact</strong>: security@tree-sitter-perl.org
<strong>Response Time</strong>: 72 hours
<strong>Disclosure Timeline</strong>: 90 days coordinated disclosure</p>
<h3 id="72-security-patch-process"><a class="header" href="#72-security-patch-process">7.2 Security Patch Process</a></h3>
<ol>
<li><strong>Triage</strong>: Assess severity (CVSS score)</li>
<li><strong>Fix Development</strong>: Implement patch with regression tests</li>
<li><strong>Validation</strong>: Security team review + penetration testing</li>
<li><strong>Release</strong>: Coordinated disclosure with CVE assignment</li>
<li><strong>Notification</strong>: Security advisory via GitHub Security Advisories</li>
</ol>
<hr />
<h2 id="8-compliance-summary"><a class="header" href="#8-compliance-summary">8. Compliance Summary</a></h2>
<h3 id="81-security-standards-alignment"><a class="header" href="#81-security-standards-alignment">8.1 Security Standards Alignment</a></h3>
<p><strong>Enterprise Security Framework</strong> (<code>docs/SECURITY_DEVELOPMENT_GUIDE.md</code>):</p>
<ul>
<li>‚úÖ Path traversal prevention (canonical path validation)</li>
<li>‚úÖ UTF-16 position security (PR #153 symmetric conversion)</li>
<li>‚úÖ LSP error recovery patterns (safe logging)</li>
<li>‚úÖ Secure defaults (safe evaluation mode)</li>
</ul>
<p><strong>OWASP Top 10 Coverage</strong>:</p>
<ul>
<li>‚úÖ A01:2021 - Broken Access Control (path traversal prevention)</li>
<li>‚úÖ A03:2021 - Injection (expression sanitization, safe eval)</li>
<li>‚úÖ A04:2021 - Insecure Design (secure defaults, timeout enforcement)</li>
</ul>
<h3 id="82-test-coverage-metrics-ac16"><a class="header" href="#82-test-coverage-metrics-ac16">8.2 Test Coverage Metrics (AC16)</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Security Domain</th><th>Test Coverage</th><th>Validation Command</th></tr></thead><tbody>
<tr><td>Path Traversal</td><td>100%</td><td><code>cargo test --test security_validation -- test_path_traversal</code></td></tr>
<tr><td>Safe Evaluation</td><td>100%</td><td><code>cargo test --test security_validation -- test_safe_eval</code></td></tr>
<tr><td>Timeout Enforcement</td><td>100%</td><td><code>cargo test --test security_validation -- test_eval_timeout</code></td></tr>
<tr><td>Unicode Safety</td><td>100%</td><td><code>cargo test --test security_validation -- test_unicode</code></td></tr>
<tr><td>Platform-Specific</td><td>100%</td><td><code>cargo test --test security_validation -- test_windows test_unix</code></td></tr>
</tbody></table>
</div>
<p><strong>Target</strong>: Zero security findings in CI/CD gate (AC16)</p>
<hr />
<h2 id="9-references"><a class="header" href="#9-references">9. References</a></h2>
<ul>
<li><a href="SECURITY_DEVELOPMENT_GUIDE.html">Security Development Guide</a>: Enterprise security framework</li>
<li><a href="POSITION_TRACKING_GUIDE.html">Position Tracking Guide</a>: UTF-16 ‚Üî UTF-8 conversion (PR #153)</li>
<li><a href="DAP_IMPLEMENTATION_SPECIFICATION.html">DAP Implementation Specification</a>: Primary technical specification</li>
<li><a href="DAP_PROTOCOL_SCHEMA.html">DAP Protocol Schema</a>: JSON-RPC message schemas</li>
<li><a href="https://owasp.org/www-project-top-ten/">OWASP Top 10 2021</a></li>
</ul>
<hr />
<p><strong>End of DAP Security Specification</strong></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../dap/implementation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../dap/bridge-setup.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../dap/implementation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../dap/bridge-setup.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
