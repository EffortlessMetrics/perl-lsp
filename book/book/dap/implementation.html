<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>DAP Implementation - Perl LSP Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Comprehensive documentation for the perl-lsp project - a production-ready Perl Language Server Protocol implementation">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Perl LSP Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/EffortlessMetrics/tree-sitter-perl-rs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="dap-implementation-specification"><a class="header" href="#dap-implementation-specification">DAP Implementation Specification</a></h1>
<!-- Labels: spec:dap, implementation:greenfield, phase:bridge-to-native -->
<p><strong>Issue</strong>: #207 - Debug Adapter Protocol Support
<strong>Status</strong>: Specification Complete
<strong>Version</strong>: 1.0.0
<strong>Date</strong>: 2025-10-04</p>
<hr />
<h2 id="executive-summary"><a class="header" href="#executive-summary">Executive Summary</a></h2>
<p>This specification defines the comprehensive implementation strategy for adding Debug Adapter Protocol (DAP) support to the Perl LSP ecosystem. The implementation follows a <strong>phased Bridge-to-Native approach</strong> delivering immediate user value while building production-grade infrastructure.</p>
<p><strong>Implementation Strategy</strong>: Greenfield implementation leveraging existing Perl LSP infrastructure (AST integration, incremental parsing, workspace navigation, security framework).</p>
<p><strong>Key Deliverables</strong>:</p>
<ul>
<li>Phase 1 (Week 1-2): Bridge to Perl::LanguageServer for immediate debugging capability</li>
<li>Phase 2 (Week 3-6): Native Rust adapter (perl-dap) + CPAN Perl shim (Devel::TSPerlDAP)</li>
<li>Phase 3 (Week 7-8): Production hardening with comprehensive testing and security validation</li>
</ul>
<p><strong>Performance Targets</strong>:</p>
<ul>
<li>Breakpoint operations: &lt;50ms latency</li>
<li>Step/continue: &lt;100ms p95 response time</li>
<li>Variable expansion: &lt;200ms initial + &lt;100ms per child</li>
<li>Incremental breakpoint updates: &lt;1ms (leveraging existing parser)</li>
</ul>
<p><strong>Success Metrics</strong>:</p>
<ul>
<li>19/19 acceptance criteria validated</li>
<li>
<blockquote>
<p>95% test coverage for DAP adapter</p>
</blockquote>
</li>
<li>
<blockquote>
<p>80% test coverage for Perl shim</p>
</blockquote>
</li>
<li>Zero security findings</li>
<li>100% LSP test pass rate with DAP active</li>
</ul>
<hr />
<h2 id="1-architecture-overview"><a class="header" href="#1-architecture-overview">1. Architecture Overview</a></h2>
<h3 id="11-system-architecture"><a class="header" href="#11-system-architecture">1.1 System Architecture</a></h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    VS Code Extension                        │
│  - contributes.debuggers configuration                      │
│  - Launch.json snippet management                           │
│  - Platform binary distribution (6 targets)                 │
└───────────────────────────┬─────────────────────────────────┘
                            │ DAP over stdio (JSON-RPC 2.0)
                            ↓
┌─────────────────────────────────────────────────────────────┐
│              perl-dap Rust Adapter (NEW CRATE)              │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ Protocol Layer                                        │  │
│  │  - JSON-RPC DAP server (tokio async)                 │  │
│  │  - Request routing: initialize, launch, attach, etc. │  │
│  │  - Session state management (Arc&lt;Mutex&lt;&gt;&gt;)           │  │
│  └───────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ Integration Layer                                     │  │
│  │  - Breakpoint Manager (AST-based validation)         │  │
│  │  - Position Mapper (UTF-16 ↔ UTF-8 conversion)      │  │
│  │  - Workspace Navigator (dual indexing strategy)      │  │
│  │  - Security Manager (path validation, safe eval)     │  │
│  └───────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ Shim Communication Layer                              │  │
│  │  - JSON protocol over stdio/TCP                      │  │
│  │  - Process lifecycle management                      │  │
│  │  - Error handling and recovery                       │  │
│  └───────────────────────────────────────────────────────┘  │
└───────────────────────────┬─────────────────────────────────┘
                            │ JSON over stdio/TCP
                            ↓
┌─────────────────────────────────────────────────────────────┐
│         Devel::TSPerlDAP Perl Shim (NEW CPAN MODULE)        │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ Protocol Server                                       │  │
│  │  - JSON-RPC server (stdio or TCP configurable)       │  │
│  │  - Command routing: set_breakpoints, continue, etc.  │  │
│  └───────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ Debugger Integration                                  │  │
│  │  - Breakpoint management ($DB::single hooks)         │  │
│  │  - Stack introspection (caller() + %DB::sub)         │  │
│  │  - Variable inspection (PadWalker for lexicals)      │  │
│  │  - Code evaluation (safe eval wrapper)               │  │
│  └───────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ Rendering Layer                                       │  │
│  │  - Variable serialization (B::Deparse for coderefs)  │  │
│  │  - Lazy expansion (large arrays/hashes)              │  │
│  │  - Truncation (1KB preview max)                      │  │
│  └───────────────────────────────────────────────────────┘  │
└───────────────────────────┬─────────────────────────────────┘
                            │ Perl Debugger API
                            ↓
┌─────────────────────────────────────────────────────────────┐
│              perl -d (Perl Debugger Runtime)                │
│  - $DB::single, $DB::trace, $DB::sub hooks                  │
│  - caller() stack introspection                             │
│  - Package symbol table access (%::)                        │
│  - PadWalker lexical inspection                             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h3 id="12-component-responsibilities"><a class="header" href="#12-component-responsibilities">1.2 Component Responsibilities</a></h3>
<h4 id="perl-dap-rust-adapter"><a class="header" href="#perl-dap-rust-adapter">perl-dap Rust Adapter</a></h4>
<p><strong>Location</strong>: <code>/crates/perl-dap/</code>
<strong>Purpose</strong>: Production-grade DAP protocol implementation with LSP infrastructure integration</p>
<p><strong>Responsibilities</strong>:</p>
<ul>
<li>DAP 1.x protocol compliance (JSON-RPC 2.0)</li>
<li>AST-based breakpoint validation (reuse perl-parser)</li>
<li>Position mapping (UTF-16 ↔ UTF-8 symmetric conversion)</li>
<li>Workspace navigation (dual indexing for stack frames)</li>
<li>Security enforcement (path traversal, safe eval, timeouts)</li>
<li>Shim lifecycle management (spawn, monitor, restart)</li>
<li>Performance optimization (&lt;50ms breakpoints, &lt;100ms step/continue)</li>
</ul>
<h4 id="develtsperldap-perl-shim"><a class="header" href="#develtsperldap-perl-shim">Devel::TSPerlDAP Perl Shim</a></h4>
<p><strong>Location</strong>: CPAN module (bundled fallback in extension)
<strong>Purpose</strong>: Machine-readable JSON bridge to Perl debugger runtime</p>
<p><strong>Responsibilities</strong>:</p>
<ul>
<li>Debugger integration ($DB::single, caller(), %DB::sub)</li>
<li>Variable inspection (PadWalker for lexicals, symbol table for package vars)</li>
<li>Code evaluation (safe eval wrapper with timeout enforcement)</li>
<li>Variable rendering (B::Deparse for coderefs, lazy expansion)</li>
<li>JSON protocol server (stdio or TCP configurable)</li>
<li>Cross-platform compatibility (Perl 5.16+ required, 5.30+ recommended)</li>
</ul>
<h4 id="vs-code-extension-integration"><a class="header" href="#vs-code-extension-integration">VS Code Extension Integration</a></h4>
<p><strong>Location</strong>: <code>/vscode-extension/</code>
<strong>Purpose</strong>: DAP debugger contribution and platform binary management</p>
<p><strong>Responsibilities</strong>:</p>
<ul>
<li><code>contributes.debuggers</code> configuration (types: “perl”, “perl-rs”)</li>
<li>Launch.json snippet generation (launch and attach configurations)</li>
<li>Platform binary selection (6 targets: Linux/macOS/Windows x86_64/aarch64)</li>
<li>Auto-download fallback (GitHub Releases integration)</li>
<li>First-time setup (&lt;30 seconds target for shim installation)</li>
</ul>
<hr />
<h2 id="2-dap-protocol-specification"><a class="header" href="#2-dap-protocol-specification">2. DAP Protocol Specification</a></h2>
<h3 id="21-protocol-overview"><a class="header" href="#21-protocol-overview">2.1 Protocol Overview</a></h3>
<p><strong>Standard</strong>: Debug Adapter Protocol 1.x
<strong>Transport</strong>: JSON-RPC 2.0 over stdio (Content-Length headers)
<strong>Message Types</strong>: Request, Response, Event</p>
<p><strong>Core Request Types Implemented</strong>:</p>
<ul>
<li><code>initialize</code>: Capability negotiation</li>
<li><code>launch</code>: Start debugging session (program execution)</li>
<li><code>attach</code>: Attach to running Perl process</li>
<li><code>setBreakpoints</code>: Manage source breakpoints</li>
<li><code>continue</code>: Resume execution until next breakpoint</li>
<li><code>next</code>: Step over (execute next line)</li>
<li><code>stepIn</code>: Step into subroutine</li>
<li><code>stepOut</code>: Step out of subroutine</li>
<li><code>pause</code>: Interrupt execution</li>
<li><code>threads</code>: List debugger threads (single “Main Thread” for Perl)</li>
<li><code>stackTrace</code>: Retrieve call stack</li>
<li><code>scopes</code>: Get variable scopes (Locals, Package, Globals)</li>
<li><code>variables</code>: Retrieve variable values with lazy expansion</li>
<li><code>evaluate</code>: Evaluate expression in stack frame context</li>
<li><code>disconnect</code>: Terminate debugging session</li>
</ul>
<h3 id="22-requestresponse-sequencing"><a class="header" href="#22-requestresponse-sequencing">2.2 Request/Response Sequencing</a></h3>
<h4 id="221-initialization-sequence"><a class="header" href="#221-initialization-sequence">2.2.1 Initialization Sequence</a></h4>
<pre><code class="language-json">// Client → Adapter
{
  "seq": 1,
  "type": "request",
  "command": "initialize",
  "arguments": {
    "clientID": "vscode",
    "adapterID": "perl-rs",
    "linesStartAt1": true,
    "columnsStartAt1": true,
    "pathFormat": "path",
    "supportsVariableType": true,
    "supportsVariablePaging": false
  }
}

// Adapter → Client
{
  "seq": 1,
  "type": "response",
  "request_seq": 1,
  "success": true,
  "command": "initialize",
  "body": {
    "supportsConfigurationDoneRequest": true,
    "supportsEvaluateForHovers": true,
    "supportsStepInTargetsRequest": false,
    "supportsSetVariable": false,
    "supportsConditionalBreakpoints": false,  // Phase 2 enhancement
    "supportsExceptionBreakpoints": false     // Post-MVP
  }
}

// Adapter → Client (Event)
{
  "seq": 2,
  "type": "event",
  "event": "initialized"
}
</code></pre>
<h4 id="222-launch-sequence"><a class="header" href="#222-launch-sequence">2.2.2 Launch Sequence</a></h4>
<pre><code class="language-json">// Client → Adapter
{
  "seq": 3,
  "type": "request",
  "command": "launch",
  "arguments": {
    "program": "/workspace/script.pl",
    "args": ["--verbose", "input.txt"],
    "perlPath": "/usr/bin/perl",
    "includePaths": ["/workspace/lib"],
    "env": { "PERL5LIB": "/custom/lib" },
    "cwd": "/workspace",
    "stopOnEntry": false
  }
}

// Adapter → Client
{
  "seq": 3,
  "type": "response",
  "request_seq": 3,
  "success": true,
  "command": "launch"
}

// Adapter spawns: perl -d:TSPerlDAP script.pl --verbose input.txt
// With environment: PERL5LIB=/workspace/lib:/custom/lib
</code></pre>
<h4 id="223-breakpoint-management-sequence"><a class="header" href="#223-breakpoint-management-sequence">2.2.3 Breakpoint Management Sequence</a></h4>
<pre><code class="language-json">// Client → Adapter
{
  "seq": 4,
  "type": "request",
  "command": "setBreakpoints",
  "arguments": {
    "source": {
      "path": "/workspace/lib/Module.pm",
      "name": "Module.pm"
    },
    "breakpoints": [
      { "line": 10 },
      { "line": 25 },
      { "line": 100 }
    ]
  }
}

// Adapter validates breakpoints using AST (&lt;50ms target)
// Adapter → Client
{
  "seq": 4,
  "type": "response",
  "request_seq": 4,
  "success": true,
  "command": "setBreakpoints",
  "body": {
    "breakpoints": [
      { "id": 1, "verified": true, "line": 10 },
      { "id": 2, "verified": true, "line": 25 },
      { "id": 3, "verified": false, "line": 100, "message": "Line contains only comments" }
    ]
  }
}
</code></pre>
<h4 id="224-execution-control-sequence"><a class="header" href="#224-execution-control-sequence">2.2.4 Execution Control Sequence</a></h4>
<pre><code class="language-json">// Client → Adapter
{
  "seq": 5,
  "type": "request",
  "command": "continue",
  "arguments": {
    "threadId": 1
  }
}

// Adapter → Client (Response &lt;100ms p95)
{
  "seq": 5,
  "type": "response",
  "request_seq": 5,
  "success": true,
  "command": "continue",
  "body": {
    "allThreadsContinued": true
  }
}

// Adapter → Client (Event when breakpoint hit)
{
  "seq": 6,
  "type": "event",
  "event": "stopped",
  "body": {
    "reason": "breakpoint",
    "threadId": 1,
    "preserveFocusHint": false,
    "allThreadsStopped": true
  }
}
</code></pre>
<h4 id="225-variable-inspection-sequence"><a class="header" href="#225-variable-inspection-sequence">2.2.5 Variable Inspection Sequence</a></h4>
<pre><code class="language-json">// Client → Adapter: Get stack trace
{
  "seq": 7,
  "type": "request",
  "command": "stackTrace",
  "arguments": {
    "threadId": 1,
    "startFrame": 0,
    "levels": 20
  }
}

// Adapter → Client
{
  "seq": 7,
  "type": "response",
  "request_seq": 7,
  "success": true,
  "command": "stackTrace",
  "body": {
    "stackFrames": [
      {
        "id": 1001,
        "name": "Package::subroutine",
        "source": { "path": "/workspace/lib/Package.pm", "name": "Package.pm" },
        "line": 42,
        "column": 0
      },
      {
        "id": 1002,
        "name": "main::run",
        "source": { "path": "/workspace/script.pl", "name": "script.pl" },
        "line": 10,
        "column": 0
      }
    ],
    "totalFrames": 2
  }
}

// Client → Adapter: Get scopes for frame
{
  "seq": 8,
  "type": "request",
  "command": "scopes",
  "arguments": {
    "frameId": 1001
  }
}

// Adapter → Client
{
  "seq": 8,
  "type": "response",
  "request_seq": 8,
  "success": true,
  "command": "scopes",
  "body": {
    "scopes": [
      {
        "name": "Locals",
        "variablesReference": 2001,
        "expensive": false
      },
      {
        "name": "Package",
        "variablesReference": 2002,
        "expensive": false
      }
    ]
  }
}

// Client → Adapter: Get variables
{
  "seq": 9,
  "type": "request",
  "command": "variables",
  "arguments": {
    "variablesReference": 2001,
    "start": 0,
    "count": 100
  }
}

// Adapter → Client (&lt;200ms initial expansion)
{
  "seq": 9,
  "type": "response",
  "request_seq": 9,
  "success": true,
  "command": "variables",
  "body": {
    "variables": [
      {
        "name": "$x",
        "value": "42",
        "type": "scalar",
        "variablesReference": 0
      },
      {
        "name": "@array",
        "value": "[10 items]",
        "type": "array",
        "variablesReference": 3001
      },
      {
        "name": "%hash",
        "value": "{5 keys}",
        "type": "hash",
        "variablesReference": 3002
      }
    ]
  }
}
</code></pre>
<h3 id="23-error-handling"><a class="header" href="#23-error-handling">2.3 Error Handling</a></h3>
<h4 id="231-structured-error-responses"><a class="header" href="#231-structured-error-responses">2.3.1 Structured Error Responses</a></h4>
<pre><code class="language-json">// Breakpoint validation failure
{
  "seq": 10,
  "type": "response",
  "request_seq": 10,
  "success": false,
  "command": "setBreakpoints",
  "message": "Path traversal detected in breakpoint path",
  "body": {
    "error": {
      "id": 1001,
      "format": "Security violation: attempted path traversal in '{path}'",
      "variables": {
        "path": "/workspace/../../../etc/passwd"
      },
      "showUser": true
    }
  }
}

// Evaluation timeout
{
  "seq": 11,
  "type": "response",
  "request_seq": 11,
  "success": false,
  "command": "evaluate",
  "message": "Evaluation timed out after 5 seconds",
  "body": {
    "error": {
      "id": 1002,
      "format": "Expression evaluation exceeded {timeout}s timeout",
      "variables": {
        "timeout": "5"
      },
      "showUser": true
    }
  }
}
</code></pre>
<h4 id="232-event-sequencing-for-errors"><a class="header" href="#232-event-sequencing-for-errors">2.3.2 Event Sequencing for Errors</a></h4>
<pre><code class="language-json">// Output event for stderr
{
  "seq": 12,
  "type": "event",
  "event": "output",
  "body": {
    "category": "stderr",
    "output": "Global symbol \"$undefined\" requires explicit package name at script.pl line 10.\n",
    "source": { "path": "/workspace/script.pl" },
    "line": 10,
    "column": 0
  }
}

// Terminated event on fatal error
{
  "seq": 13,
  "type": "event",
  "event": "terminated"
}
</code></pre>
<hr />
<h2 id="3-lsp-integration-points"><a class="header" href="#3-lsp-integration-points">3. LSP Integration Points</a></h2>
<h3 id="31-ast-based-breakpoint-validation"><a class="header" href="#31-ast-based-breakpoint-validation">3.1 AST-Based Breakpoint Validation</a></h3>
<p><strong>Requirement</strong>: Leverage existing ~100% Perl syntax coverage for accurate breakpoint placement</p>
<p><strong>Integration Pattern</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/perl-dap/src/breakpoints.rs
use perl_parser::{Parser, ast::Node};
use ropey::Rope;

pub struct BreakpointManager {
    parser: Arc&lt;Parser&gt;,
    workspace: Arc&lt;WorkspaceIndex&gt;,
}

impl BreakpointManager {
    pub fn verify_breakpoint(&amp;self, uri: &amp;str, line: u32, rope: &amp;Rope) -&gt; BreakpointVerification {
        // Parse source text (using existing parser infrastructure)
        // NOTE: Parser::parse() returns AST Node, not file-based parsing
        let source = rope.to_string();
        let mut parser = Parser::new(&amp;source);
        let ast = parser.parse()?;

        // Get byte offset for the line (using Rope)
        let line_start = rope.line_to_byte(line as usize);
        let line_end = if (line as usize) &lt; rope.len_lines() - 1 {
            rope.line_to_byte(line as usize + 1)
        } else {
            rope.len_bytes()
        };

        // Validate line contains executable code using AST traversal
        // These helper functions will be implemented in perl-dap crate (see DAP_BREAKPOINT_VALIDATION_GUIDE.md)
        if is_comment_or_blank_line(&amp;ast, line_start, line_end, &amp;source) {
            return BreakpointVerification::Invalid {
                reason: "Line contains only comments or whitespace"
            };
        }

        // Validate not inside string literal or heredoc using AST node type analysis
        if is_inside_string_literal(&amp;ast, line_start) {
            return BreakpointVerification::Invalid {
                reason: "Line is inside string literal or heredoc"
            };
        }

        // Validate not inside POD documentation using AST traversal
        if is_inside_pod(&amp;source, line_start) {
            return BreakpointVerification::Invalid {
                reason: "Line is inside POD documentation"
            };
        }

        BreakpointVerification::Verified {
            line: self.adjust_to_executable_line(&amp;ast, line, rope)
        }
    }

    // Adjust breakpoint to nearest executable line
    fn adjust_to_executable_line(&amp;self, ast: &amp;Node, line: u32, rope: &amp;Rope) -&gt; u32 {
        // Search forward for next executable line (max 5 lines)
        for offset in 0..5 {
            let candidate = line + offset;
            if (candidate as usize) &gt;= rope.len_lines() {
                break;
            }

            let line_start = rope.line_to_byte(candidate as usize);
            let line_end = rope.line_to_byte(candidate as usize + 1);

            if is_executable_line(ast, line_start, line_end) {
                return candidate;
            }
        }

        line // Fallback to original line
    }
}

// DAP-specific AST validation utilities (crates/perl-dap/src/breakpoints/ast_utils.rs)
// These functions analyze the AST Node structure from perl_parser::ast::Node

fn is_comment_or_blank_line(ast: &amp;Node, line_start: usize, line_end: usize, source: &amp;str) -&gt; bool {
    // Extract line text
    let line_text = &amp;source[line_start..line_end.min(source.len())];

    // Check if blank (only whitespace)
    if line_text.trim().is_empty() {
        return true;
    }

    // Check if comment (starts with # after whitespace)
    if line_text.trim_start().starts_with('#') {
        return true;
    }

    // TODO AC7: Implement AST-based comment detection by traversing nodes
    // and checking NodeKind for comment types
    false
}

fn is_inside_string_literal(ast: &amp;Node, byte_offset: usize) -&gt; bool {
    // TODO AC7: Traverse AST to find node containing byte_offset
    // Check if NodeKind is StringLiteral or Heredoc
    // This will be implemented using perl_parser::ast::Node traversal
    false
}

fn is_inside_pod(source: &amp;str, byte_offset: usize) -&gt; bool {
    // POD detection via text scanning (POD markers: =pod, =head1, etc.)
    // Scan backwards from byte_offset to detect POD block markers
    let before = &amp;source[..byte_offset];
    let after = &amp;source[byte_offset..];

    // Check if we're between =pod and =cut markers
    let in_pod = before.rfind("=pod").is_some() &amp;&amp;
                 after.find("=cut").is_some() &amp;&amp;
                 before.rfind("=cut").map_or(true, |cut| before.rfind("=pod").unwrap() &gt; cut);

    in_pod
}

fn is_executable_line(ast: &amp;Node, line_start: usize, line_end: usize) -&gt; bool {
    // TODO AC7: Check if line range contains executable AST nodes
    // (statements, expressions, not just comments/POD/whitespace)
    true // Conservative default - will be refined in implementation
}
<span class="boring">}</span></code></pre></pre>
<p><strong>Performance Target</strong>: &lt;50ms breakpoint verification leveraging Rope and AST analysis</p>
<p><strong>Implementation Notes</strong>:</p>
<ul>
<li>AST validation utilities will be implemented in <code>perl-dap</code> crate (not in <code>perl-parser</code>)</li>
<li>See <code>docs/DAP_BREAKPOINT_VALIDATION_GUIDE.md</code> for detailed AST traversal patterns</li>
<li>Uses existing <code>Parser::parse()</code> API which returns <code>ast::Node</code> structure</li>
<li>Rope-based line-to-byte conversion for efficient position mapping</li>
</ul>
<h3 id="32-incremental-parsing-integration"><a class="header" href="#32-incremental-parsing-integration">3.2 Incremental Parsing Integration</a></h3>
<p><strong>Requirement</strong>: Live breakpoint adjustment as code changes without full re-parse</p>
<p><strong>Integration Pattern</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/perl-dap/src/session.rs
use perl_parser::incremental_v2::IncrementalParserV2;

pub struct DapSession {
    parser: IncrementalParserV2,
    breakpoints: HashMap&lt;String, Vec&lt;Breakpoint&gt;&gt;,
    active_session: bool,
}

impl DapSession {
    pub fn on_text_change(&amp;mut self, uri: &amp;str, changes: Vec&lt;TextEdit&gt;) -&gt; Result&lt;()&gt; {
        // Apply incremental parsing (&lt;1ms target)
        self.parser.apply_edits(uri, &amp;changes)?;

        // Calculate affected line range
        let affected_lines = self.calculate_affected_lines(&amp;changes);

        // Re-verify breakpoints in affected range
        let breakpoints = self.breakpoints.get(uri).cloned().unwrap_or_default();
        for bp in breakpoints {
            if affected_lines.contains(&amp;bp.line) {
                let verification = self.breakpoint_manager.verify_breakpoint(uri, bp.line)?;

                // Send breakpoint event if verification status changed
                if verification != bp.verification {
                    self.send_breakpoint_event(bp.id, verification)?;
                }
            }
        }

        Ok(())
    }

    fn calculate_affected_lines(&amp;self, changes: &amp;[TextEdit]) -&gt; Range&lt;u32&gt; {
        let mut min_line = u32::MAX;
        let mut max_line = 0;

        for change in changes {
            min_line = min_line.min(change.range.start.line);
            max_line = max_line.max(change.range.end.line);
        }

        // Add buffer for multi-line statements
        min_line.saturating_sub(5)..max_line.saturating_add(5)
    }
}
<span class="boring">}</span></code></pre></pre>
<p><strong>Performance Target</strong>: &lt;1ms incremental breakpoint updates</p>
<h3 id="33-workspace-navigation-for-stack-frames"><a class="header" href="#33-workspace-navigation-for-stack-frames">3.3 Workspace Navigation for Stack Frames</a></h3>
<p><strong>Requirement</strong>: Dual indexing strategy for accurate stack frame source resolution</p>
<p><strong>Integration Pattern</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/perl-dap/src/stack.rs
use perl_parser::workspace_index::WorkspaceIndex;

pub struct StackTraceProvider {
    workspace: Arc&lt;WorkspaceIndex&gt;,
}

impl StackTraceProvider {
    pub fn resolve_frame_location(
        &amp;self,
        package: &amp;str,
        subroutine: &amp;str
    ) -&gt; Option&lt;Location&gt; {
        // Use dual pattern matching (98% reference coverage)
        let qualified = format!("{}::{}", package, subroutine);

        // Search exact qualified match first
        if let Some(def) = self.workspace.get_definition(&amp;qualified) {
            return Some(def.location);
        }

        // Fallback to bare name search (dual indexing)
        if let Some(def) = self.workspace.get_definition(subroutine) {
            return Some(def.location);
        }

        // Fallback to text search across workspace
        self.workspace.text_search(&amp;qualified)
            .or_else(|| self.workspace.text_search(subroutine))
    }

    pub fn build_stack_frames(&amp;self, perl_stack: Vec&lt;PerlFrame&gt;) -&gt; Vec&lt;DapStackFrame&gt; {
        perl_stack.iter().enumerate().map(|(idx, frame)| {
            let location = self.resolve_frame_location(&amp;frame.package, &amp;frame.subroutine);

            DapStackFrame {
                id: 1000 + idx as i64,
                name: format!("{}::{}", frame.package, frame.subroutine),
                source: location.as_ref().map(|loc| DapSource {
                    path: loc.uri.to_file_path().ok(),
                    name: loc.uri.path().split('/').last().map(String::from),
                }),
                line: location.as_ref().map(|loc| loc.range.start.line).unwrap_or(0),
                column: location.as_ref().map(|loc| loc.range.start.character).unwrap_or(0),
                presentationHint: Some("normal"),
            }
        }).collect()
    }
}
<span class="boring">}</span></code></pre></pre>
<p><strong>Coverage Target</strong>: 98% stack frame resolution success rate via dual indexing</p>
<h3 id="34-utf-16-position-mapping"><a class="header" href="#34-utf-16-position-mapping">3.4 UTF-16 Position Mapping</a></h3>
<p><strong>Requirement</strong>: Symmetric position conversion for accurate breakpoint placement</p>
<p><strong>Integration Pattern</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/perl-dap/src/protocol.rs
use perl_lsp::textdoc::{lsp_pos_to_byte, byte_to_lsp_pos, PosEnc};

pub fn dap_breakpoint_to_byte_offset(
    rope: &amp;Rope,
    line: u32,
    column: u32,
) -&gt; Result&lt;usize&gt; {
    // DAP uses 0-based line/column (same as LSP)
    let pos = Position { line, character: column };

    // Reuse LSP infrastructure (PR #153 symmetric conversion)
    lsp_pos_to_byte(rope, pos, PosEnc::Utf16)
}

pub fn byte_offset_to_dap_position(
    rope: &amp;Rope,
    byte_offset: usize,
) -&gt; Result&lt;(u32, u32)&gt; {
    // Convert byte offset to LSP position
    let pos = byte_to_lsp_pos(rope, byte_offset, PosEnc::Utf16)?;

    Ok((pos.line, pos.character))
}

// Variable rendering with UTF-16 safety
pub fn render_variable_value(value: &amp;str, rope: &amp;Rope) -&gt; String {
    // Truncate large values (security: prevent memory exhaustion)
    if value.len() &gt; 1024 {
        let truncated = &amp;value[..1024];

        // UTF-16 safe truncation (reuse PR #153 infrastructure)
        let safe_truncate = ensure_utf16_boundary(truncated, rope);
        format!("{}…", safe_truncate)
    } else {
        value.to_string()
    }
}
<span class="boring">}</span></code></pre></pre>
<p><strong>Security Requirement</strong>: Symmetric conversion prevents UTF-16 boundary vulnerabilities</p>
<hr />
<h2 id="4-phased-implementation-plan"><a class="header" href="#4-phased-implementation-plan">4. Phased Implementation Plan</a></h2>
<h3 id="41-phase-1-bridge-implementation-week-1-2"><a class="header" href="#41-phase-1-bridge-implementation-week-1-2">4.1 Phase 1: Bridge Implementation (Week 1-2)</a></h3>
<p><strong>Goal</strong>: Deliver immediate debugging capability for users</p>
<p><strong>Deliverables</strong>: AC1-AC4</p>
<ul>
<li>AC1: VS Code extension contributes “perl” debugger type</li>
<li>AC2: Launch.json snippets (launch and attach configurations)</li>
<li>AC3: Bridge setup documentation</li>
<li>AC4: Basic debugging workflow (set breakpoints, step, inspect variables)</li>
</ul>
<p><strong>Implementation Tasks</strong>:</p>
<h4 id="task-11-vs-code-extension-configuration-ac1"><a class="header" href="#task-11-vs-code-extension-configuration-ac1">Task 1.1: VS Code Extension Configuration (AC1)</a></h4>
<p><strong>Duration</strong>: 0.5 days
<strong>Files Modified</strong>:</p>
<ul>
<li><code>vscode-extension/package.json</code>: Add <code>contributes.debuggers</code> section</li>
<li><code>vscode-extension/src/debugAdapter.ts</code>: Implement bridge proxy to Perl::LanguageServer</li>
</ul>
<p><strong>Code Template</strong>:</p>
<pre><code class="language-json">{
  "contributes": {
    "debuggers": [
      {
        "type": "perl",
        "label": "Perl Debug (Bridge)",
        "program": "./out/debugAdapter.js",
        "runtime": "node",
        "configurationAttributes": {
          "launch": {
            "required": ["program"],
            "properties": {
              "program": {
                "type": "string",
                "description": "Absolute path to Perl script"
              },
              "args": {
                "type": "array",
                "description": "Command line arguments",
                "default": []
              },
              "perlPath": {
                "type": "string",
                "description": "Path to Perl executable",
                "default": "perl"
              },
              "includePaths": {
                "type": "array",
                "description": "Additional @INC paths",
                "default": []
              }
            }
          }
        }
      }
    ]
  }
}
</code></pre>
<p><strong>Test Validation</strong>: <code>cd vscode-extension &amp;&amp; npm test</code></p>
<h4 id="task-12-launchjson-snippets-ac2"><a class="header" href="#task-12-launchjson-snippets-ac2">Task 1.2: Launch.json Snippets (AC2)</a></h4>
<p><strong>Duration</strong>: 0.5 days
<strong>Files Created</strong>: <code>vscode-extension/snippets/launch.json</code></p>
<p><strong>Test Validation</strong>: <code>cargo test --test dap_launch_snippets -- windows macos linux</code></p>
<h4 id="task-13-bridge-documentation-ac3"><a class="header" href="#task-13-bridge-documentation-ac3">Task 1.3: Bridge Documentation (AC3)</a></h4>
<p><strong>Duration</strong>: 0.5 days
<strong>Files Created</strong>: <code>docs/DAP_BRIDGE_SETUP_GUIDE.md</code></p>
<p><strong>Content Requirements</strong>:</p>
<ul>
<li>Perl::LanguageServer installation instructions</li>
<li>Configuration examples</li>
<li>Platform-specific troubleshooting (Windows UNC paths, macOS symlinks, WSL)</li>
</ul>
<h4 id="task-14-basic-workflow-validation-ac4"><a class="header" href="#task-14-basic-workflow-validation-ac4">Task 1.4: Basic Workflow Validation (AC4)</a></h4>
<p><strong>Duration</strong>: 0.5 days
<strong>Files Created</strong>: <code>crates/perl-dap/tests/fixtures/bridge_basic.pl</code></p>
<p><strong>Test Suite</strong>: Golden transcript validation for bridge protocol</p>
<p><strong>Success Criteria</strong>: All Phase 1 ACs passing, users can debug Perl code via bridge</p>
<hr />
<h3 id="42-phase-2-native-infrastructure-week-3-6"><a class="header" href="#42-phase-2-native-infrastructure-week-3-6">4.2 Phase 2: Native Infrastructure (Week 3-6)</a></h3>
<p><strong>Goal</strong>: Production-grade DAP adapter owned by perl-lsp</p>
<p><strong>Deliverables</strong>: AC5-AC12</p>
<ul>
<li>AC5: perl-dap Rust crate scaffolding</li>
<li>AC6: Devel::TSPerlDAP CPAN module</li>
<li>AC7: Breakpoint management with AST validation</li>
<li>AC8: Stack traces, scopes, variables with lazy expansion</li>
<li>AC9: Stepping and control flow (&lt;100ms p95)</li>
<li>AC10: Evaluate and REPL with safe eval</li>
<li>AC11: VS Code native integration</li>
<li>AC12: Cross-platform compatibility (6 platforms)</li>
</ul>
<p><strong>Critical Path</strong>: AC6 (Perl shim) requires 2 weeks</p>
<h4 id="task-21-perl-dap-crate-scaffolding-ac5"><a class="header" href="#task-21-perl-dap-crate-scaffolding-ac5">Task 2.1: perl-dap Crate Scaffolding (AC5)</a></h4>
<p><strong>Duration</strong>: 1 week
<strong>Files Created</strong>:</p>
<ul>
<li><code>crates/perl-dap/Cargo.toml</code>: Dependencies (tokio, serde_json, anyhow, tracing)</li>
<li><code>crates/perl-dap/src/main.rs</code>: Adapter entry point</li>
<li><code>crates/perl-dap/src/protocol.rs</code>: DAP message types</li>
<li><code>crates/perl-dap/src/session.rs</code>: Session state management</li>
</ul>
<p><strong>Code Template</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/perl-dap/src/protocol.rs
use serde::{Deserialize, Serialize};

#[derive(Debug, Serialize, Deserialize)]
pub struct DapRequest {
    pub seq: i64,
    #[serde(rename = "type")]
    pub type_: String,
    pub command: String,
    pub arguments: Option&lt;serde_json::Value&gt;,
}

#[derive(Debug, Serialize, Deserialize)]
pub struct DapResponse {
    pub seq: i64,
    #[serde(rename = "type")]
    pub type_: String,
    pub request_seq: i64,
    pub success: bool,
    pub command: String,
    pub message: Option&lt;String&gt;,
    pub body: Option&lt;serde_json::Value&gt;,
}

pub struct DapServer {
    seq: AtomicI64,
    session: Arc&lt;Mutex&lt;Option&lt;DapSession&gt;&gt;&gt;,
}

impl DapServer {
    pub async fn handle_request(&amp;self, request: DapRequest) -&gt; DapResponse {
        match request.command.as_str() {
            "initialize" =&gt; self.handle_initialize(request).await,
            "launch" =&gt; self.handle_launch(request).await,
            "setBreakpoints" =&gt; self.handle_set_breakpoints(request).await,
            "continue" =&gt; self.handle_continue(request).await,
            // ... other commands
            _ =&gt; self.handle_unknown_command(request),
        }
    }
}
<span class="boring">}</span></code></pre></pre>
<p><strong>Test Validation</strong>: <code>cargo test -p perl-dap --test protocol_compliance</code></p>
<h4 id="task-22-develtsperldap-cpan-module-ac6---critical-path"><a class="header" href="#task-22-develtsperldap-cpan-module-ac6---critical-path">Task 2.2: Devel::TSPerlDAP CPAN Module (AC6) - <strong>CRITICAL PATH</strong></a></h4>
<p><strong>Duration</strong>: 2 weeks
<strong>Files Created</strong>:</p>
<ul>
<li><code>Devel-TSPerlDAP/lib/Devel/TSPerlDAP.pm</code>: Core shim implementation</li>
<li><code>Devel-TSPerlDAP/t/*.t</code>: Test suite (&gt;80% coverage)</li>
<li><code>Devel-TSPerlDAP/META.json</code>: CPAN metadata</li>
</ul>
<p><strong>Perl Shim Architecture</strong>:</p>
<pre><code class="language-perl"># Devel/TSPerlDAP.pm
package Devel::TSPerlDAP;
use strict;
use warnings;
use JSON::PP;
use PadWalker qw(peek_my);
use B::Deparse;

our $VERSION = '0.1.0';

sub import {
    my ($class, %opts) = @_;

    my $daemon = $opts{daemon} // 0;

    if ($daemon) {
        start_tcp_server($opts{host}, $opts{port});
    } else {
        start_stdio_server();
    }
}

sub handle_command {
    my ($request) = @_;

    my $command = $request-&gt;{command};

    return set_breakpoints($request-&gt;{arguments})   if $command eq 'set_breakpoints';
    return continue_execution()                     if $command eq 'continue';
    return step_next()                              if $command eq 'next';
    return step_in()                                if $command eq 'step_in';
    return step_out()                               if $command eq 'step_out';
    return get_stack_trace()                        if $command eq 'stack';
    return get_scopes($request-&gt;{arguments})        if $command eq 'scopes';
    return get_variables($request-&gt;{arguments})     if $command eq 'variables';
    return evaluate_expression($request-&gt;{arguments}) if $command eq 'evaluate';

    return { success =&gt; 0, message =&gt; "Unknown command: $command" };
}

sub set_breakpoints {
    my ($args) = @_;
    my $file = $args-&gt;{source}{path};
    my @breakpoints = @{$args-&gt;{breakpoints}};

    foreach my $bp (@breakpoints) {
        my $line = $bp-&gt;{line};
        $DB::single{$file}{$line} = 1;
    }

    return { success =&gt; 1, breakpoints =&gt; \@breakpoints };
}

sub get_stack_trace {
    my @frames;
    my $i = 0;

    while (my ($package, $file, $line, $sub) = caller($i++)) {
        push @frames, {
            name =&gt; $sub,
            source =&gt; { path =&gt; $file },
            line =&gt; $line,
            column =&gt; 0,
        };
    }

    return { stackFrames =&gt; \@frames };
}

sub get_variables {
    my ($args) = @_;
    my $frame_id = $args-&gt;{frameId};

    # Use PadWalker to inspect lexical variables
    my $vars = peek_my($frame_id);

    my @variables;
    foreach my $name (sort keys %$vars) {
        my $value = $vars-&gt;{$name};

        push @variables, {
            name =&gt; $name,
            value =&gt; render_value($value),
            type =&gt; ref($value) || 'scalar',
            variablesReference =&gt; is_expandable($value) ? allocate_ref($value) : 0,
        };
    }

    return { variables =&gt; \@variables };
}

sub render_value {
    my ($value) = @_;

    if (ref($value) eq 'CODE') {
        my $deparse = B::Deparse-&gt;new();
        return $deparse-&gt;coderef2text($value);
    } elsif (ref($value) eq 'ARRAY') {
        return "[" . @$value . " items]";
    } elsif (ref($value) eq 'HASH') {
        return "{" . (scalar keys %$value) . " keys}";
    } else {
        my $str = "$value";
        return length($str) &gt; 1024 ? substr($str, 0, 1024) . "…" : $str;
    }
}

1;
</code></pre>
<p><strong>Test Validation</strong>: <code>cd Devel-TSPerlDAP &amp;&amp; prove -lv t/</code></p>
<p><strong>CPAN Publication Requirements</strong>:</p>
<ul>
<li>
<blockquote>
<p>80% test coverage</p>
</blockquote>
</li>
<li>Perl 5.16+ compatibility</li>
<li>Dependencies: JSON::PP, PadWalker, B::Deparse</li>
<li>Documentation: POD for all public functions</li>
</ul>
<h4 id="task-23-breakpoint-management-ac7"><a class="header" href="#task-23-breakpoint-management-ac7">Task 2.3: Breakpoint Management (AC7)</a></h4>
<p><strong>Duration</strong>: 0.5 weeks
<strong>Integration</strong>: AST-based validation + path mapping</p>
<p><strong>Test Validation</strong>: <code>cargo test -p perl-dap --test breakpoint_validation</code></p>
<h4 id="task-24-stackscopesvariables-ac8"><a class="header" href="#task-24-stackscopesvariables-ac8">Task 2.4: Stack/Scopes/Variables (AC8)</a></h4>
<p><strong>Duration</strong>: 1 week
<strong>Features</strong>: Lazy expansion, variable rendering, Unicode safety</p>
<p><strong>Test Validation</strong>: <code>cargo test -p perl-dap --test variable_rendering</code></p>
<h4 id="task-25-stepping-and-control-flow-ac9"><a class="header" href="#task-25-stepping-and-control-flow-ac9">Task 2.5: Stepping and Control Flow (AC9)</a></h4>
<p><strong>Duration</strong>: 0.5 weeks
<strong>Performance Target</strong>: &lt;100ms p95 latency</p>
<p><strong>Test Validation</strong>: <code>cargo test -p perl-dap --test control_flow_performance</code></p>
<h4 id="task-26-evaluate-and-repl-ac10"><a class="header" href="#task-26-evaluate-and-repl-ac10">Task 2.6: Evaluate and REPL (AC10)</a></h4>
<p><strong>Duration</strong>: 0.5 weeks
<strong>Security</strong>: Safe eval default, timeout enforcement</p>
<p><strong>Test Validation</strong>: <code>cargo test -p perl-dap --test eval_security</code></p>
<h4 id="task-27-vs-code-native-integration-ac11"><a class="header" href="#task-27-vs-code-native-integration-ac11">Task 2.7: VS Code Native Integration (AC11)</a></h4>
<p><strong>Duration</strong>: 0.5 weeks
<strong>Deliverable</strong>: “perl-rs” debugger type with native adapter</p>
<p><strong>Test Validation</strong>: <code>cd vscode-extension &amp;&amp; npm test -- native</code></p>
<h4 id="task-28-cross-platform-compatibility-ac12"><a class="header" href="#task-28-cross-platform-compatibility-ac12">Task 2.8: Cross-Platform Compatibility (AC12)</a></h4>
<p><strong>Duration</strong>: 0.5 weeks
<strong>Platforms</strong>: Linux/macOS/Windows x86_64/aarch64</p>
<p><strong>Test Validation</strong>: <code>cargo test -p perl-dap --test cross_platform_validation</code></p>
<p><strong>Success Criteria</strong>: All Phase 2 ACs passing, native adapter functional</p>
<hr />
<h3 id="43-phase-3-production-hardening-week-7-8"><a class="header" href="#43-phase-3-production-hardening-week-7-8">4.3 Phase 3: Production Hardening (Week 7-8)</a></h3>
<p><strong>Goal</strong>: Enterprise-ready debugging with comprehensive testing</p>
<p><strong>Deliverables</strong>: AC13-AC19</p>
<ul>
<li>AC13: Comprehensive integration tests (golden transcripts, breakpoint matrix, variable rendering)</li>
<li>AC14: Performance benchmarks with regression detection</li>
<li>AC15: Documentation complete (Tutorial, Reference, Architecture, Troubleshooting)</li>
<li>AC16: Security validation (path traversal, safe eval, timeout, Unicode safety)</li>
<li>AC17: LSP integration non-regression (100% LSP test pass rate)</li>
<li>AC18: Dependency management (auto-install, bundled fallback, versioning)</li>
<li>AC19: Binary packaging (6 platforms, GitHub Releases, auto-download)</li>
</ul>
<h4 id="task-31-comprehensive-integration-tests-ac13"><a class="header" href="#task-31-comprehensive-integration-tests-ac13">Task 3.1: Comprehensive Integration Tests (AC13)</a></h4>
<p><strong>Duration</strong>: 0.5 weeks
<strong>Files Created</strong>:</p>
<ul>
<li><code>crates/perl-dap/tests/integration_tests.rs</code>: Golden transcript validation</li>
<li><code>crates/perl-dap/tests/fixtures/*.pl</code>: Test scripts (hello, args, eval, loops)</li>
</ul>
<p><strong>Test Coverage Target</strong>: &gt;95% for DAP adapter</p>
<p><strong>Test Validation</strong>: <code>cargo test -p perl-dap --test integration_tests</code></p>
<h4 id="task-32-performance-benchmarks-ac14"><a class="header" href="#task-32-performance-benchmarks-ac14">Task 3.2: Performance Benchmarks (AC14)</a></h4>
<p><strong>Duration</strong>: 0.5 weeks
<strong>Files Created</strong>: <code>crates/perl-dap/benches/dap_benchmarks.rs</code></p>
<p><strong>Baselines</strong>:</p>
<ul>
<li>Breakpoint verification: &lt;50ms</li>
<li>Step/continue: &lt;100ms p95</li>
<li>Variable expansion: &lt;200ms initial + &lt;100ms per child</li>
<li>Memory overhead: &lt;1MB adapter state</li>
</ul>
<p><strong>Test Validation</strong>: <code>cargo bench -p perl-dap</code></p>
<h4 id="task-33-documentation-complete-ac15"><a class="header" href="#task-33-documentation-complete-ac15">Task 3.3: Documentation Complete (AC15)</a></h4>
<p><strong>Duration</strong>: 0.5 weeks
<strong>Files Created</strong>:</p>
<ul>
<li><code>docs/DAP_GETTING_STARTED_TUTORIAL.md</code>: Step-by-step tutorial with screenshots</li>
<li><code>docs/DAP_CONFIGURATION_REFERENCE.md</code>: All launch.json parameters documented</li>
<li><code>docs/DAP_TROUBLESHOOTING_GUIDE.md</code>: Common issues and solutions</li>
</ul>
<p><strong>Diátaxis Framework Compliance</strong>: Tutorial, How-to, Reference, Explanation</p>
<p><strong>Test Validation</strong>: <code>cargo test --test dap_documentation_complete</code></p>
<h4 id="task-34-security-validation-ac16"><a class="header" href="#task-34-security-validation-ac16">Task 3.4: Security Validation (AC16)</a></h4>
<p><strong>Duration</strong>: 0.5 weeks
<strong>Files Created</strong>: <code>crates/perl-dap/tests/security_validation.rs</code></p>
<p><strong>Security Requirements</strong>:</p>
<ul>
<li>Path traversal prevention (reuse enterprise framework)</li>
<li>Safe eval enforcement (non-mutating default)</li>
<li>Timeout enforcement (5s default)</li>
<li>Unicode boundary safety (PR #153 symmetric conversion)</li>
</ul>
<p><strong>Test Validation</strong>: <code>cargo test -p perl-dap --test security_validation</code></p>
<h4 id="task-35-lsp-non-regression-ac17"><a class="header" href="#task-35-lsp-non-regression-ac17">Task 3.5: LSP Non-Regression (AC17)</a></h4>
<p><strong>Duration</strong>: 0.5 weeks
<strong>Files Created</strong>: <code>crates/perl-lsp/tests/lsp_dap_non_regression.rs</code></p>
<p><strong>Requirements</strong>:</p>
<ul>
<li>100% LSP test pass rate with DAP active</li>
<li>&lt;50ms LSP response time maintained</li>
<li>No memory leaks or resource contention</li>
</ul>
<p><strong>Test Validation</strong>: <code>cargo test -p perl-lsp --test lsp_dap_non_regression</code></p>
<h4 id="task-36-dependency-management-ac18"><a class="header" href="#task-36-dependency-management-ac18">Task 3.6: Dependency Management (AC18)</a></h4>
<p><strong>Duration</strong>: 0.5 weeks
<strong>Files Created</strong>: <code>docs/DAP_DEPENDENCY_MANAGEMENT.md</code></p>
<p><strong>Installation Strategies</strong>:</p>
<ol>
<li>Auto-install via cpanm (recommended)</li>
<li>Bundled fallback (extension bundles Perl shim)</li>
<li>System package (future enhancement)</li>
</ol>
<p><strong>Versioning Strategy</strong>: Adapter ↔ shim protocol versioning with feature detection</p>
<p><strong>Test Validation</strong>: <code>cargo test --test dap_dependency_installation</code></p>
<h4 id="task-37-binary-packaging-ac19"><a class="header" href="#task-37-binary-packaging-ac19">Task 3.7: Binary Packaging (AC19)</a></h4>
<p><strong>Duration</strong>: 0.5 weeks
<strong>Deliverable</strong>: Platform binaries for 6 targets</p>
<p><strong>Platforms</strong>:</p>
<ul>
<li><code>x86_64-unknown-linux-gnu</code></li>
<li><code>aarch64-unknown-linux-gnu</code></li>
<li><code>x86_64-apple-darwin</code></li>
<li><code>aarch64-apple-darwin</code></li>
<li><code>x86_64-pc-windows-msvc</code></li>
<li><code>aarch64-pc-windows-msvc</code></li>
</ul>
<p><strong>Distribution</strong>: GitHub Releases with auto-download fallback</p>
<p><strong>Test Validation</strong>: <code>cargo test --test dap_binary_packaging</code></p>
<p><strong>Success Criteria</strong>: All Phase 3 ACs passing, production-ready DAP adapter</p>
<hr />
<h2 id="5-performance-specifications"><a class="header" href="#5-performance-specifications">5. Performance Specifications</a></h2>
<h3 id="51-latency-targets"><a class="header" href="#51-latency-targets">5.1 Latency Targets</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Operation</th><th>Target Latency</th><th>Measurement Method</th></tr></thead><tbody>
<tr><td>Breakpoint verification</td><td>&lt;50ms</td><td><code>cargo bench -p perl-dap -- verify_breakpoint</code></td></tr>
<tr><td>setBreakpoints request</td><td>&lt;100ms p95</td><td>Golden transcript timing validation</td></tr>
<tr><td>continue/next/stepIn/stepOut</td><td>&lt;100ms p95</td><td>Control flow performance benchmark</td></tr>
<tr><td>Variable scope retrieval</td><td>&lt;200ms initial</td><td>Variable rendering benchmark</td></tr>
<tr><td>Child variable expansion</td><td>&lt;100ms per child</td><td>Lazy expansion benchmark</td></tr>
<tr><td>Incremental breakpoint update</td><td>&lt;1ms</td><td>Incremental parsing integration test</td></tr>
</tbody></table>
</div>
<h3 id="52-memory-targets"><a class="header" href="#52-memory-targets">5.2 Memory Targets</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Component</th><th>Target</th><th>Measurement Method</th></tr></thead><tbody>
<tr><td>Adapter state overhead</td><td>&lt;1MB per session</td><td>Memory profiling in integration tests</td></tr>
<tr><td>Perl shim process</td><td>&lt;5MB</td><td>Process memory monitoring</td></tr>
<tr><td>Variable rendering buffer</td><td>&lt;1KB preview</td><td>Truncation enforcement test</td></tr>
<tr><td>Total session overhead</td><td>&lt;10MB</td><td>End-to-end memory validation</td></tr>
</tbody></table>
</div>
<h3 id="53-scalability-targets"><a class="header" href="#53-scalability-targets">5.3 Scalability Targets</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Scenario</th><th>Target</th><th>Validation</th></tr></thead><tbody>
<tr><td>Large codebase (100K LOC)</td><td>&lt;50ms breakpoint verification</td><td>Large file benchmark</td></tr>
<tr><td>Deep call stack (50+ frames)</td><td>&lt;200ms stack trace retrieval</td><td>Stack depth stress test</td></tr>
<tr><td>Large variable (10MB+ array)</td><td>Lazy expansion only</td><td>Variable truncation test</td></tr>
<tr><td>Concurrent sessions</td><td>No resource contention</td><td>Multi-session isolation test</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="6-security-specifications"><a class="header" href="#6-security-specifications">6. Security Specifications</a></h2>
<h3 id="61-path-traversal-prevention"><a class="header" href="#61-path-traversal-prevention">6.1 Path Traversal Prevention</a></h3>
<p><strong>Requirement</strong>: All file paths validated through existing enterprise security framework</p>
<p><strong>Implementation</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/perl-dap/src/security.rs
use perl_parser::security::validate_workspace_path;

pub fn validate_breakpoint_path(uri: &amp;str, workspace_root: &amp;Path) -&gt; Result&lt;PathBuf&gt; {
    // Convert URI to filesystem path
    let path = uri_to_path(uri)?;

    // Validate path is within workspace boundaries
    let canonical = validate_workspace_path(&amp;path, workspace_root)?;

    // Prevent directory traversal attacks
    if canonical.components().any(|c| c == Component::ParentDir) {
        return Err(SecurityError::PathTraversalAttempt(uri.to_string()));
    }

    Ok(canonical)
}
<span class="boring">}</span></code></pre></pre>
<p><strong>Test Coverage</strong>:</p>
<ul>
<li>Valid workspace paths</li>
<li>Path traversal attempts (<code>../../../etc/passwd</code>)</li>
<li>UNC path validation (Windows)</li>
<li>Symlink resolution (macOS/Linux)</li>
</ul>
<h3 id="62-safe-evaluation-mode"><a class="header" href="#62-safe-evaluation-mode">6.2 Safe Evaluation Mode</a></h3>
<p><strong>Requirement</strong>: Non-mutating eval default with explicit opt-in for side effects</p>
<p><strong>Implementation</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/perl-dap/src/eval.rs
pub async fn evaluate_expression(
    expr: &amp;str,
    context: &amp;StackFrame,
    allow_side_effects: bool,
) -&gt; Result&lt;Value&gt; {
    // Input validation: prevent code injection
    validate_expression_safety(expr)?;

    // Timeout enforcement: prevent DoS (5s default, configurable)
    let timeout = Duration::from_secs(5);

    let result = tokio::time::timeout(timeout, async {
        if allow_side_effects {
            // Full evaluation with write access
            context.eval_with_side_effects(expr).await
        } else {
            // Safe evaluation: read-only mode
            context.eval_readonly(expr).await
        }
    }).await??;

    Ok(result)
}
<span class="boring">}</span></code></pre></pre>
<p><strong>Test Coverage</strong>:</p>
<ul>
<li>Read-only expressions (no opt-in)</li>
<li>Side effect prevention ($var = 42 fails without opt-in)</li>
<li>Explicit opt-in validation</li>
<li>Timeout enforcement (infinite loops)</li>
</ul>
<h3 id="63-timeout-enforcement"><a class="header" href="#63-timeout-enforcement">6.3 Timeout Enforcement</a></h3>
<p><strong>Requirement</strong>: Hard timeouts on evaluate requests (&lt;5s default) to prevent DoS</p>
<p><strong>Configuration</strong>:</p>
<pre><code class="language-json">{
  "perl.dap.evaluateTimeout": 5,  // seconds
  "perl.dap.evaluateMaxDepth": 10  // recursion depth limit
}
</code></pre>
<p><strong>Test Coverage</strong>:</p>
<ul>
<li>Infinite loop detection</li>
<li>Recursive function timeout</li>
<li>Configurable timeout override</li>
</ul>
<h3 id="64-unicode-boundary-safety"><a class="header" href="#64-unicode-boundary-safety">6.4 Unicode Boundary Safety</a></h3>
<p><strong>Requirement</strong>: Reuse PR #153 symmetric position conversion for variable rendering</p>
<p><strong>Implementation</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/perl-dap/src/variables.rs
use perl_lsp::textdoc::ensure_utf16_boundary;

pub fn render_variable_value(value: &amp;str, rope: &amp;Rope) -&gt; String {
    if value.len() &gt; 1024 {
        let truncated = &amp;value[..1024];

        // UTF-16 safe truncation (PR #153 infrastructure)
        let safe_truncate = ensure_utf16_boundary(truncated, rope);
        format!("{}…", safe_truncate)
    } else {
        value.to_string()
    }
}
<span class="boring">}</span></code></pre></pre>
<p><strong>Test Coverage</strong>:</p>
<ul>
<li>Multi-byte character truncation (emoji, CJK)</li>
<li>UTF-16 surrogate pair safety</li>
<li>Variable rendering with Unicode content</li>
</ul>
<hr />
<h2 id="7-cross-platform-strategy"><a class="header" href="#7-cross-platform-strategy">7. Cross-Platform Strategy</a></h2>
<h3 id="71-platform-specific-binaries"><a class="header" href="#71-platform-specific-binaries">7.1 Platform-Specific Binaries</a></h3>
<p><strong>Targets</strong>:</p>
<ol>
<li><code>x86_64-unknown-linux-gnu</code> (Linux x86_64)</li>
<li><code>aarch64-unknown-linux-gnu</code> (Linux ARM64)</li>
<li><code>x86_64-apple-darwin</code> (macOS Intel)</li>
<li><code>aarch64-apple-darwin</code> (macOS Apple Silicon)</li>
<li><code>x86_64-pc-windows-msvc</code> (Windows x86_64)</li>
<li><code>aarch64-pc-windows-msvc</code> (Windows ARM64)</li>
</ol>
<p><strong>Build Strategy</strong>:</p>
<pre><code class="language-yaml"># .github/workflows/release-dap-binaries.yml
name: Release DAP Binaries

on:
  release:
    types: [created]

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: windows-latest
            target: aarch64-pc-windows-msvc

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}

      - name: Build perl-dap binary
        run: cargo build -p perl-dap --release --target ${{ matrix.target }}

      - name: Upload artifact
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: target/${{ matrix.target }}/release/perl-dap${{ matrix.os == 'windows-latest' &amp;&amp; '.exe' || '' }}
          asset_name: perl-dap-${{ matrix.target }}${{ matrix.os == 'windows-latest' &amp;&amp; '.exe' || '' }}
</code></pre>
<h3 id="72-wsl-support-requirements"><a class="header" href="#72-wsl-support-requirements">7.2 WSL Support Requirements</a></h3>
<p><strong>Challenges</strong>:</p>
<ul>
<li>WSL1 vs WSL2 path translation differences</li>
<li>Windows ↔ Linux path mapping (<code>/mnt/c</code> vs <code>C:\</code>)</li>
<li>Performance implications of WSL filesystem access</li>
</ul>
<p><strong>Implementation</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/perl-dap/src/platform.rs
#[cfg(target_os = "linux")]
pub fn normalize_wsl_path(path: &amp;Path) -&gt; Result&lt;PathBuf&gt; {
    let path_str = path.to_str().ok_or(PathError::InvalidUtf8)?;

    // Detect WSL mount point (/mnt/c, /mnt/d, etc.)
    if let Some(drive) = path_str.strip_prefix("/mnt/") {
        let drive_letter = drive.chars().next().ok_or(PathError::InvalidPath)?;
        let rest = &amp;drive[1..];

        // Convert /mnt/c/Users/... to C:\Users\...
        let windows_path = format!("{}:{}", drive_letter.to_uppercase(), rest.replace('/', "\\"));
        return Ok(PathBuf::from(windows_path));
    }

    Ok(path.to_path_buf())
}
<span class="boring">}</span></code></pre></pre>
<p><strong>Test Coverage</strong>:</p>
<ul>
<li>WSL1 path translation</li>
<li>WSL2 path translation</li>
<li>Performance benchmarks for WSL filesystem access</li>
</ul>
<h3 id="73-path-normalization"><a class="header" href="#73-path-normalization">7.3 Path Normalization</a></h3>
<p><strong>Windows-Specific</strong>:</p>
<ul>
<li>Drive letter normalization (<code>C:</code> vs <code>c:</code>)</li>
<li>UNC path support (<code>\\server\share\file.pl</code>)</li>
<li>CRLF line ending handling</li>
</ul>
<p><strong>macOS/Linux-Specific</strong>:</p>
<ul>
<li>Symlink resolution (<code>/tmp</code>, <code>~/Library</code>)</li>
<li>Case-sensitive filesystem handling</li>
<li>UNIX signal handling (SIGINT for pause)</li>
</ul>
<p><strong>Implementation</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/perl-dap/src/platform.rs
pub fn normalize_path(path: &amp;Path) -&gt; Result&lt;PathBuf&gt; {
    #[cfg(windows)]
    {
        // Normalize drive letter to uppercase
        let path_str = path.to_str().ok_or(PathError::InvalidUtf8)?;
        if let Some((drive, rest)) = path_str.split_once(':') {
            let normalized = format!("{}:{}", drive.to_uppercase(), rest);
            return Ok(PathBuf::from(normalized));
        }
    }

    // Canonicalize path (resolves symlinks, normalizes separators)
    path.canonicalize().map_err(|e| PathError::Canonicalization(e))
}
<span class="boring">}</span></code></pre></pre>
<hr />
<h2 id="8-test-strategy"><a class="header" href="#8-test-strategy">8. Test Strategy</a></h2>
<h3 id="81-golden-transcript-tests"><a class="header" href="#81-golden-transcript-tests">8.1 Golden Transcript Tests</a></h3>
<p><strong>Purpose</strong>: Validate DAP protocol compliance with expected message sequences</p>
<p><strong>Test Structure</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/perl-dap/tests/integration_tests.rs
#[test] // AC13
fn test_hello_world_golden_transcript() {
    let transcript = load_golden_transcript("hello.json");
    let adapter = DapAdapter::new();

    for message in transcript.messages {
        if message.type_ == "request" {
            let response = adapter.handle_request(message.request)?;
            assert_eq!(response, message.expected_response,
                       "Transcript mismatch at seq {}", message.seq);
        }
    }
}
<span class="boring">}</span></code></pre></pre>
<p><strong>Golden Transcript Files</strong>:</p>
<ul>
<li><code>hello.json</code>: Basic launch → breakpoint → continue → terminate</li>
<li><code>args.json</code>: Command-line argument passing</li>
<li><code>eval.json</code>: Expression evaluation with side effects</li>
<li><code>loops.json</code>: Step through loop iterations</li>
</ul>
<h3 id="82-breakpoint-matrix-tests"><a class="header" href="#82-breakpoint-matrix-tests">8.2 Breakpoint Matrix Tests</a></h3>
<p><strong>Purpose</strong>: Validate breakpoint verification edge cases</p>
<p><strong>Test Matrix</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[test] // AC13
fn test_breakpoint_edge_cases() {
    let fixtures = vec![
        ("file_start.pl", 1, true),       // First line
        ("file_end.pl", 100, true),       // Last line
        ("blank_line.pl", 10, false),     // Blank line
        ("comment_line.pl", 5, false),    // Comment line
        ("heredoc.pl", 15, false),        // Inside heredoc
        ("pod_doc.pl", 20, false),        // Inside POD
        ("begin_block.pl", 3, true),      // BEGIN block
        ("end_block.pl", 50, true),       // END block
        ("multiline_stmt.pl", 12, true),  // Multi-line statement
    ];

    for (fixture, line, should_verify) in fixtures {
        let result = verify_breakpoint(fixture, line);
        assert_eq!(result.verified, should_verify,
                   "Breakpoint verification mismatch for {}:{}",
                   fixture, line);
    }
}
<span class="boring">}</span></code></pre></pre>
<h3 id="83-variable-rendering-tests"><a class="header" href="#83-variable-rendering-tests">8.3 Variable Rendering Tests</a></h3>
<p><strong>Purpose</strong>: Validate variable serialization and truncation</p>
<p><strong>Test Cases</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[test] // AC13
fn test_variable_rendering_edge_cases() {
    let test_cases = vec![
        ("$scalar", "42", "scalar", 0),
        ("@array", "[10 items]", "array", 3001),  // variablesReference for expansion
        ("%hash", "{5 keys}", "hash", 3002),
        ("$unicode", "Hello 😀 World", "scalar", 0),
        ("$large", "data…", "scalar", 0),  // &gt;1KB truncated
        ("&amp;coderef", "sub { ... }", "code", 0),
    ];

    for (name, expected_value, expected_type, expected_ref) in test_cases {
        let var = render_variable(name)?;
        assert_eq!(var.value, expected_value);
        assert_eq!(var.type_, expected_type);
        assert_eq!(var.variablesReference, expected_ref);
    }
}
<span class="boring">}</span></code></pre></pre>
<h3 id="84-security-validation-tests"><a class="header" href="#84-security-validation-tests">8.4 Security Validation Tests</a></h3>
<p><strong>Purpose</strong>: Validate enterprise security framework compliance</p>
<p><strong>Test Coverage</strong>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/perl-dap/tests/security_validation.rs

#[test] // AC16
fn test_path_traversal_prevention() {
    let adapter = DapAdapter::new();

    // Valid workspace path
    let result = adapter.set_breakpoints("file:///workspace/lib/Module.pm", vec![]);
    assert!(result.is_ok());

    // Path traversal attack
    let result = adapter.set_breakpoints("file:///workspace/../../../etc/passwd", vec![]);
    assert!(result.is_err());
    assert!(result.unwrap_err().to_string().contains("traversal"));
}

#[test] // AC16
fn test_safe_eval_prevents_side_effects() {
    let frame = create_test_frame();

    // Read-only expression OK
    let result = evaluate_expression("$var + 10", &amp;frame, false);
    assert!(result.is_ok());

    // Side effect without opt-in fails
    let result = evaluate_expression("$var = 42", &amp;frame, false);
    assert!(result.is_err());
    assert!(result.unwrap_err().to_string().contains("side effect"));

    // Explicit opt-in succeeds
    let result = evaluate_expression("$var = 42", &amp;frame, true);
    assert!(result.is_ok());
}

#[test] // AC16
fn test_eval_timeout_prevents_dos() {
    let frame = create_test_frame();

    // Infinite loop should timeout
    let result = evaluate_expression("while(1) {}", &amp;frame, true);
    assert!(result.is_err());
    assert!(result.unwrap_err().to_string().contains("timeout"));
}

#[test] // AC16
fn test_unicode_boundary_safety() {
    let rope = Rope::from_str("my $emoji = '😀👨‍👩‍👧‍👦🎉';");

    // Large unicode value should truncate safely
    let large_value = "😀".repeat(500); // 2000 bytes
    let rendered = render_variable_value(&amp;large_value, &amp;rope);

    assert!(rendered.len() &lt;= 1024 + 1); // +1 for '…'
    assert!(rendered.ends_with('…'));
    assert!(is_valid_utf8(&amp;rendered));
}
<span class="boring">}</span></code></pre></pre>
<h3 id="85-cross-platform-ci-validation"><a class="header" href="#85-cross-platform-ci-validation">8.5 Cross-Platform CI Validation</a></h3>
<p><strong>Purpose</strong>: Ensure compatibility across all 6 platform targets</p>
<p><strong>GitHub Actions</strong>:</p>
<pre><code class="language-yaml">name: DAP Cross-Platform Tests

on: [push, pull_request]

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        perl: ['5.16', '5.30', '5.38']

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v3
      - uses: shogo82148/actions-setup-perl@v1
        with:
          perl-version: ${{ matrix.perl }}

      - name: Install Devel::TSPerlDAP
        run: cpanm Devel::TSPerlDAP

      - name: Build perl-dap
        run: cargo build -p perl-dap --release

      - name: Run DAP tests
        run: cargo test -p perl-dap

      - name: Run cross-platform validation
        run: cargo test -p perl-dap --test cross_platform_validation
</code></pre>
<hr />
<h2 id="9-documentation-requirements"><a class="header" href="#9-documentation-requirements">9. Documentation Requirements</a></h2>
<h3 id="91-diátaxis-framework-compliance"><a class="header" href="#91-diátaxis-framework-compliance">9.1 Diátaxis Framework Compliance</a></h3>
<p><strong>Tutorial</strong>: <code>docs/DAP_GETTING_STARTED_TUTORIAL.md</code></p>
<ul>
<li>Step-by-step debugging workflow with screenshots</li>
<li>VS Code setup and configuration</li>
<li>First debugging session walkthrough</li>
</ul>
<p><strong>How-To Guide</strong>: <code>docs/DAP_CONFIGURATION_REFERENCE.md</code></p>
<ul>
<li>Launch.json parameter reference</li>
<li>Attach configuration for remote debugging</li>
<li>Platform-specific setup (Windows, macOS, Linux, WSL)</li>
</ul>
<p><strong>Reference</strong>: <code>docs/DAP_PROTOCOL_SCHEMA.md</code> (this document)</p>
<ul>
<li>DAP protocol message schemas</li>
<li>Request/response formats</li>
<li>Error codes and handling</li>
</ul>
<p><strong>Explanation</strong>: <code>docs/CRATE_ARCHITECTURE_DAP.md</code></p>
<ul>
<li>Architecture decision rationale</li>
<li>Rust adapter + Perl shim design</li>
<li>LSP integration patterns</li>
</ul>
<h3 id="92-troubleshooting-guide"><a class="header" href="#92-troubleshooting-guide">9.2 Troubleshooting Guide</a></h3>
<p><strong>File</strong>: <code>docs/DAP_TROUBLESHOOTING_GUIDE.md</code></p>
<p><strong>Common Issues</strong>:</p>
<ol>
<li>
<p><strong>Breakpoints not hitting</strong></p>
<ul>
<li>Cause: Path mapping mismatch</li>
<li>Fix: Verify pathMapping in launch.json</li>
</ul>
</li>
<li>
<p><strong>Windows UNC path failures</strong></p>
<ul>
<li>Cause: Network share path normalization</li>
<li>Fix: Use drive letter mapping (Z:\ instead of \server\share)</li>
</ul>
</li>
<li>
<p><strong>WSL path translation errors</strong></p>
<ul>
<li>Cause: WSL1 vs WSL2 differences</li>
<li>Fix: Use WSL2 for best compatibility</li>
</ul>
</li>
<li>
<p><strong>Variable expansion timeout</strong></p>
<ul>
<li>Cause: Large data structure rendering</li>
<li>Fix: Increase evaluateTimeout configuration</li>
</ul>
</li>
</ol>
<hr />
<h2 id="10-success-metrics"><a class="header" href="#10-success-metrics">10. Success Metrics</a></h2>
<h3 id="101-functional-metrics"><a class="header" href="#101-functional-metrics">10.1 Functional Metrics</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Metric</th><th>Target</th><th>Validation</th></tr></thead><tbody>
<tr><td>Acceptance criteria passing</td><td>19/19 (100%)</td><td>All <code>// AC:ID</code> tests passing</td></tr>
<tr><td>DAP protocol compliance</td><td>100%</td><td>Golden transcript validation</td></tr>
<tr><td>Breakpoint verification accuracy</td><td>&gt;95%</td><td>Breakpoint matrix tests</td></tr>
<tr><td>Stack frame resolution</td><td>98%</td><td>Workspace navigation dual indexing</td></tr>
</tbody></table>
</div>
<h3 id="102-performance-metrics"><a class="header" href="#102-performance-metrics">10.2 Performance Metrics</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Metric</th><th>Target</th><th>Validation</th></tr></thead><tbody>
<tr><td>Breakpoint operations</td><td>&lt;50ms</td><td><code>cargo bench -p perl-dap -- verify_breakpoint</code></td></tr>
<tr><td>Step/continue operations</td><td>&lt;100ms p95</td><td>Control flow performance benchmark</td></tr>
<tr><td>Variable expansion</td><td>&lt;200ms initial, &lt;100ms per child</td><td>Variable rendering benchmark</td></tr>
<tr><td>Incremental breakpoint update</td><td>&lt;1ms</td><td>Incremental parsing integration test</td></tr>
<tr><td>Memory overhead</td><td>&lt;1MB adapter + &lt;5MB shim</td><td>Memory profiling tests</td></tr>
</tbody></table>
</div>
<h3 id="103-quality-metrics"><a class="header" href="#103-quality-metrics">10.3 Quality Metrics</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Metric</th><th>Target</th><th>Validation</th></tr></thead><tbody>
<tr><td>Test coverage (adapter)</td><td>&gt;95%</td><td><code>cargo tarpaulin -p perl-dap</code></td></tr>
<tr><td>Test coverage (shim)</td><td>&gt;80%</td><td><code>cover -test</code> (Devel::TSPerlDAP)</td></tr>
<tr><td>Security findings</td><td>0</td><td><code>cargo test -p perl-dap --test security_validation</code></td></tr>
<tr><td>LSP non-regression</td><td>100% pass rate</td><td><code>cargo test -p perl-lsp --test lsp_dap_non_regression</code></td></tr>
<tr><td>Documentation completeness</td><td>100%</td><td><code>cargo test --test dap_documentation_complete</code></td></tr>
</tbody></table>
</div>
<h3 id="104-cross-platform-metrics"><a class="header" href="#104-cross-platform-metrics">10.4 Cross-Platform Metrics</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Metric</th><th>Target</th><th>Validation</th></tr></thead><tbody>
<tr><td>Platform binaries</td><td>6 targets</td><td>GitHub Actions build matrix</td></tr>
<tr><td>Cross-platform tests</td><td>100% pass rate</td><td>CI validation on Linux/macOS/Windows</td></tr>
<tr><td>WSL compatibility</td><td>Full support</td><td>WSL-specific test suite</td></tr>
<tr><td>Perl version compatibility</td><td>5.16+</td><td>Test matrix with 5.16, 5.30, 5.38</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="11-references"><a class="header" href="#11-references">11. References</a></h2>
<h3 id="111-related-specifications"><a class="header" href="#111-related-specifications">11.1 Related Specifications</a></h3>
<ul>
<li><a href="DAP_PROTOCOL_SCHEMA.html">DAP Protocol Schema</a>: JSON-RPC message schemas</li>
<li><a href="CRATE_ARCHITECTURE_DAP.html">DAP Crate Architecture</a>: Component design</li>
<li><a href="DAP_SECURITY_SPECIFICATION.html">DAP Security Specification</a>: Security requirements</li>
</ul>
<h3 id="112-existing-perl-lsp-documentation"><a class="header" href="#112-existing-perl-lsp-documentation">11.2 Existing Perl LSP Documentation</a></h3>
<ul>
<li><a href="LSP_IMPLEMENTATION_GUIDE.html">LSP Implementation Guide</a>: LSP server architecture</li>
<li><a href="SECURITY_DEVELOPMENT_GUIDE.html">Security Development Guide</a>: Enterprise security practices</li>
<li><a href="INCREMENTAL_PARSING_GUIDE.html">Incremental Parsing Guide</a>: &lt;1ms parser updates</li>
<li><a href="WORKSPACE_NAVIGATION_GUIDE.html">Workspace Navigation Guide</a>: Dual indexing strategy</li>
<li><a href="POSITION_TRACKING_GUIDE.html">Position Tracking Guide</a>: UTF-16 ↔ UTF-8 conversion</li>
</ul>
<h3 id="113-external-standards"><a class="header" href="#113-external-standards">11.3 External Standards</a></h3>
<ul>
<li><a href="https://microsoft.github.io/debug-adapter-protocol/">Debug Adapter Protocol Specification</a></li>
<li><a href="https://www.jsonrpc.org/specification">JSON-RPC 2.0 Specification</a></li>
<li><a href="https://metacpan.org/pod/distribution/Module-Starter/lib/Module/Starter.pm">CPAN Module Best Practices</a></li>
</ul>
<hr />
<h2 id="12-appendix-validation-commands"><a class="header" href="#12-appendix-validation-commands">12. Appendix: Validation Commands</a></h2>
<h3 id="121-phase-1-bridge-commands"><a class="header" href="#121-phase-1-bridge-commands">12.1 Phase 1 (Bridge) Commands</a></h3>
<pre><code class="language-bash"># AC1: Extension debugger contribution
cd vscode-extension &amp;&amp; npm test

# AC2: Launch.json snippets
cargo test --test dap_launch_snippets -- windows macos linux

# AC3: Documentation completeness
cargo test --test dap_documentation_coverage -- AC3

# AC4: Basic workflow validation
cargo test --test bridge_workflow_tests
</code></pre>
<h3 id="122-phase-2-native-commands"><a class="header" href="#122-phase-2-native-commands">12.2 Phase 2 (Native) Commands</a></h3>
<pre><code class="language-bash"># AC5: Protocol scaffolding
cargo test -p perl-dap --test protocol_compliance

# AC6: Perl shim tests
cd Devel-TSPerlDAP &amp;&amp; prove -lv t/

# AC7: Breakpoint management
cargo test -p perl-dap --test breakpoint_validation

# AC8: Variables and scopes
cargo test -p perl-dap --test variable_rendering

# AC9: Stepping and control flow
cargo test -p perl-dap --test control_flow_performance

# AC10: Evaluate and REPL
cargo test -p perl-dap --test eval_security

# AC11: VS Code native integration
cd vscode-extension &amp;&amp; npm test -- native

# AC12: Cross-platform compatibility
cargo test -p perl-dap --test cross_platform_validation
</code></pre>
<h3 id="123-phase-3-hardening-commands"><a class="header" href="#123-phase-3-hardening-commands">12.3 Phase 3 (Hardening) Commands</a></h3>
<pre><code class="language-bash"># AC13: Integration tests
cargo test -p perl-dap --test integration_tests

# AC14: Performance benchmarks
cargo bench -p perl-dap

# AC15: Documentation completeness
cargo test --test dap_documentation_complete

# AC16: Security validation
cargo test -p perl-dap --test security_validation

# AC17: LSP non-regression
cargo test -p perl-lsp --test lsp_dap_non_regression

# AC18: Dependency management
cargo test --test dap_dependency_installation

# AC19: Binary packaging
cargo test --test dap_binary_packaging
</code></pre>
<hr />
<p><strong>End of DAP Implementation Specification</strong></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../dap/user-guide.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../dap/security.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../dap/user-guide.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../dap/security.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
