<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Cost Tracking - Perl LSP Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Comprehensive documentation for the perl-lsp project - a production-ready Perl Language Server Protocol implementation">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>‚Üê</kbd> or <kbd>‚Üí</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Perl LSP Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/EffortlessMetrics/tree-sitter-perl-rs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="ci-cost-tracking-and-budget-management"><a class="header" href="#ci-cost-tracking-and-budget-management">CI Cost Tracking and Budget Management</a></h1>
<p><em>Part of Issue #211: CI Pipeline Cleanup</em></p>
<p>This guide documents the cost model, budget goals, and optimization strategies for GitHub Actions CI in the perl-lsp project. The goal is to maintain efficient, cost-effective CI while ensuring comprehensive validation.</p>
<hr />
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<h3 id="why-cost-tracking-matters"><a class="header" href="#why-cost-tracking-matters">Why Cost Tracking Matters</a></h3>
<p>GitHub Actions is a metered service. Without careful monitoring, CI costs can spiral out of control through:</p>
<ul>
<li>Flaky tests requiring multiple reruns</li>
<li>Expensive jobs running on every PR</li>
<li>Missing concurrency cancellation (paying for abandoned runs)</li>
<li>Lack of caching (rebuilding from scratch each time)</li>
<li>Testing on expensive runners (macOS costs 10x more than Linux)</li>
</ul>
<p><strong>Issue #211 target</strong>: Save $720/year through CI optimization while maintaining quality.</p>
<hr />
<h2 id="cost-model"><a class="header" href="#cost-model">Cost Model</a></h2>
<h3 id="github-actions-pricing-2025"><a class="header" href="#github-actions-pricing-2025">GitHub Actions Pricing (2025)</a></h3>
<p>GitHub Actions charges by <strong>runner minutes</strong>:</p>
<div class="table-wrapper"><table><thead><tr><th>Runner Type</th><th>Per Minute Cost</th><th>Typical Use Case</th></tr></thead><tbody>
<tr><td><strong>Linux (Ubuntu)</strong></td><td>$0.008</td><td>Default for all tests</td></tr>
<tr><td><strong>Windows</strong></td><td>$0.016</td><td>Windows compatibility checks</td></tr>
<tr><td><strong>macOS</strong></td><td>$0.080</td><td>macOS-specific features (10x Linux!)</td></tr>
</tbody></table>
</div>
<p><strong>Free tier</strong>: 2,000 minutes/month for private repos, unlimited for public repos.</p>
<h3 id="per-pr-cost-estimates"><a class="header" href="#per-pr-cost-estimates">Per-PR Cost Estimates</a></h3>
<p>Based on typical perl-lsp CI runs:</p>
<h4 id="essential-jobs-every-pr"><a class="header" href="#essential-jobs-every-pr">Essential Jobs (Every PR)</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Job</th><th>Platform</th><th>Duration</th><th>Cost</th></tr></thead><tbody>
<tr><td>Format check</td><td>Linux</td><td>0.5 min</td><td>$0.004</td></tr>
<tr><td>Clippy (lib)</td><td>Linux</td><td>1.5 min</td><td>$0.012</td></tr>
<tr><td>Library tests</td><td>Linux</td><td>2.0 min</td><td>$0.016</td></tr>
<tr><td>Panic safety check</td><td>Linux</td><td>0.5 min</td><td>$0.004</td></tr>
<tr><td>LSP semantic tests</td><td>Linux</td><td>1.0 min</td><td>$0.008</td></tr>
<tr><td><strong>Total (Linux)</strong></td><td></td><td><strong>5.5 min</strong></td><td><strong>$0.044</strong></td></tr>
<tr><td>Windows validation</td><td>Windows</td><td>3.0 min</td><td>$0.048</td></tr>
<tr><td><strong>Total Essential</strong></td><td></td><td><strong>8.5 min</strong></td><td><strong>$0.092</strong></td></tr>
</tbody></table>
</div>
<h4 id="optional-jobs-label-gated"><a class="header" href="#optional-jobs-label-gated">Optional Jobs (Label-Gated)</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Job</th><th>Platform</th><th>Duration</th><th>Cost</th><th>Trigger</th></tr></thead><tbody>
<tr><td>Mutation testing</td><td>Linux</td><td>20 min</td><td>$0.160</td><td><code>ci:mutation</code></td></tr>
<tr><td>Benchmarks</td><td>Linux</td><td>5 min</td><td>$0.040</td><td><code>ci:bench</code></td></tr>
<tr><td>Coverage analysis</td><td>Linux</td><td>8 min</td><td>$0.064</td><td><code>ci:coverage</code></td></tr>
<tr><td>macOS validation</td><td>macOS</td><td>10 min</td><td>$0.800</td><td><code>ci:mac</code></td></tr>
<tr><td>Full LSP tests</td><td>Linux</td><td>4 min</td><td>$0.032</td><td>Code changes</td></tr>
<tr><td>Property tests</td><td>Linux</td><td>6 min</td><td>$0.048</td><td><code>ci:property</code></td></tr>
</tbody></table>
</div>
<h3 id="monthlyannual-projections"><a class="header" href="#monthlyannual-projections">Monthly/Annual Projections</a></h3>
<p><strong>Assumptions</strong>:</p>
<ul>
<li>Average 20 PRs/month</li>
<li>Average 3 pushes per PR (force-push iterations)</li>
<li>Essential jobs run on every push</li>
<li>Optional jobs run on 20% of PRs</li>
</ul>
<h4 id="without-concurrency-cancellation-baseline"><a class="header" href="#without-concurrency-cancellation-baseline">Without Concurrency Cancellation (Baseline)</a></h4>
<pre><code>Essential jobs:
  20 PRs √ó 3 pushes √ó $0.092 = $5.52/month
  Annual: $5.52 √ó 12 = $66.24/year

Optional jobs:
  20 PRs √ó 20% √ó $0.344 = $1.38/month
  Annual: $1.38 √ó 12 = $16.56/year

Total: $82.80/year (without cancellation)
</code></pre>
<h4 id="with-concurrency-cancellation-optimized"><a class="header" href="#with-concurrency-cancellation-optimized">With Concurrency Cancellation (Optimized)</a></h4>
<pre><code>Essential jobs (only last push pays):
  20 PRs √ó 1 push √ó $0.092 = $1.84/month
  Annual: $1.84 √ó 12 = $22.08/year

Optional jobs (same, label-gated):
  $16.56/year

Total: $38.64/year (with cancellation)
Savings: $44.16/year (53% reduction)
</code></pre>
<h4 id="additional-optimizations-target"><a class="header" href="#additional-optimizations-target">Additional Optimizations (Target)</a></h4>
<p>With path filters, caching, and local validation:</p>
<pre><code>Essential jobs (50% skip via path filters):
  20 PRs √ó 50% √ó $0.092 = $0.92/month
  Annual: $0.92 √ó 12 = $11.04/year

Optional jobs (20% of PRs, optimized):
  20 PRs √ó 20% √ó $0.200 = $0.80/month
  Annual: $0.80 √ó 12 = $9.60/year

Total: $20.64/year (target)
Savings from baseline: $62.16/year (75% reduction)
</code></pre>
<p><strong>Note</strong>: These are conservative estimates. With 50+ PRs/month during active development, savings scale proportionally.</p>
<hr />
<h2 id="budget-goals"><a class="header" href="#budget-goals">Budget Goals</a></h2>
<h3 id="issue-211-target-720year-savings"><a class="header" href="#issue-211-target-720year-savings">Issue #211 Target: $720/year Savings</a></h3>
<p>The $720/year target comes from preventing the following CI anti-patterns:</p>
<ol>
<li>
<p><strong>No Local Validation</strong> ($300/year)</p>
<ul>
<li>Problem: Every syntax error, formatting issue, clippy warning runs in CI</li>
<li>Solution: Pre-push hook runs <code>just ci-gate</code> locally</li>
<li>Savings: ~40 wasted CI runs/month √ó $0.092 √ó 12 = $44/year (conservative)</li>
</ul>
</li>
<li>
<p><strong>Missing Concurrency Cancellation</strong> ($200/year)</p>
<ul>
<li>Problem: Force-pushing triggers new CI, old CI keeps running</li>
<li>Solution: <code>concurrency: { group: ..., cancel-in-progress: true }</code></li>
<li>Savings: As calculated above, ~$44/year</li>
</ul>
</li>
<li>
<p><strong>Ungated Expensive Jobs</strong> ($150/year)</p>
<ul>
<li>Problem: Mutation tests, benchmarks run on every PR</li>
<li>Solution: Label gates (<code>ci:mutation</code>, <code>ci:bench</code>)</li>
<li>Savings: 20 PRs √ó $0.200 √ó 12 = $48/year</li>
</ul>
</li>
<li>
<p><strong>No Path Filters</strong> ($50/year)</p>
<ul>
<li>Problem: Documentation changes trigger full test suite</li>
<li>Solution: <code>paths-ignore: ['docs/**', '**/*.md']</code></li>
<li>Savings: ~5 docs-only PRs/month √ó $0.092 √ó 12 = $5.52/year</li>
</ul>
</li>
<li>
<p><strong>Missing Caching</strong> ($20/year)</p>
<ul>
<li>Problem: Every run rebuilds dependencies from scratch</li>
<li>Solution: Cache <code>~/.cargo</code> and <code>target/</code></li>
<li>Savings: Reduces job time by ~30%, saving $0.027/PR √ó 240 PRs = $6.48/year</li>
</ul>
</li>
</ol>
<p><strong>Realistic Total Savings</strong>: The $720/year figure assumes active development (100+ PRs/year) and accounts for:</p>
<ul>
<li>Preventing flaky test reruns</li>
<li>Avoiding accidental macOS runner usage</li>
<li>Reducing redundant matrix jobs</li>
<li>Optimizing test parallelization</li>
</ul>
<p><strong>Current vs Target</strong>:</p>
<ul>
<li><strong>Baseline</strong> (no optimization): ~$200-300/year for active repo</li>
<li><strong>Target</strong> (fully optimized): ~$20-40/year</li>
<li><strong>Delta</strong>: $180-280/year savings (conservative estimate)</li>
</ul>
<p>The $720/year figure in Issue #211 represents the <strong>ceiling</strong> of what poor CI hygiene could cost, not current spending.</p>
<h3 id="monthly-budget-allocation"><a class="header" href="#monthly-budget-allocation">Monthly Budget Allocation</a></h3>
<p><strong>Recommended budget</strong>: $5/month ($60/year) for sustainable open-source project</p>
<div class="table-wrapper"><table><thead><tr><th>Category</th><th>Monthly Budget</th><th>Use Case</th></tr></thead><tbody>
<tr><td>Essential PR validation</td><td>$2.00</td><td>Format, clippy, tests</td></tr>
<tr><td>Release testing</td><td>$1.00</td><td>Pre-release comprehensive validation</td></tr>
<tr><td>Optional quality gates</td><td>$1.50</td><td>Mutation, coverage (opt-in)</td></tr>
<tr><td>Buffer</td><td>$0.50</td><td>Flaky test reruns, experiments</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="cost-optimization-strategies"><a class="header" href="#cost-optimization-strategies">Cost Optimization Strategies</a></h2>
<h3 id="1-local-validation-first-primary-defense"><a class="header" href="#1-local-validation-first-primary-defense">1. Local Validation First (Primary Defense)</a></h3>
<p><strong>Impact</strong>: Prevents 80% of wasted CI runs</p>
<pre><code class="language-bash"># Install pre-push hook (one-time setup)
bash scripts/install-githooks.sh

# Hook runs automatically before every push
git push
</code></pre>
<p><strong>What it prevents</strong>:</p>
<ul>
<li>Formatting failures ($0.004/run √ó 10 catches/month = $0.04/month saved)</li>
<li>Clippy failures ($0.012/run √ó 15 catches/month = $0.18/month saved)</li>
<li>Test failures ($0.016/run √ó 20 catches/month = $0.32/month saved)</li>
</ul>
<p><strong>Monthly savings</strong>: ~$0.54 √ó 12 = $6.48/year (conservative)</p>
<h3 id="2-path-filters-skip-irrelevant-jobs"><a class="header" href="#2-path-filters-skip-irrelevant-jobs">2. Path Filters (Skip Irrelevant Jobs)</a></h3>
<p><strong>Impact</strong>: Reduces CI runs by 20-30%</p>
<p>Most workflows include:</p>
<pre><code class="language-yaml">on:
  pull_request:
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.claude/**'
      - 'LICENSE*'
      - '.gitignore'
</code></pre>
<p><strong>What it skips</strong>:</p>
<ul>
<li>Documentation updates (no need to rebuild parser)</li>
<li>README changes</li>
<li>License updates</li>
<li>CI configuration docs</li>
</ul>
<p><strong>Monthly savings</strong>: ~5 skipped runs √ó $0.092 √ó 12 = $5.52/year</p>
<h3 id="3-concurrency-groups-cancel-redundant-runs"><a class="header" href="#3-concurrency-groups-cancel-redundant-runs">3. Concurrency Groups (Cancel Redundant Runs)</a></h3>
<p><strong>Impact</strong>: Eliminates 60-70% of parallel runs</p>
<p>All workflows include:</p>
<pre><code class="language-yaml">concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
</code></pre>
<p><strong>Scenario</strong>: You push 5 commits in quick succession (force-push iterations)</p>
<div class="table-wrapper"><table><thead><tr><th>Without Cancellation</th><th>With Cancellation</th></tr></thead><tbody>
<tr><td>5 runs √ó $0.092 = $0.46</td><td>1 run √ó $0.092 = $0.092</td></tr>
<tr><td><strong>$0.46/PR</strong></td><td><strong>$0.092/PR</strong></td></tr>
</tbody></table>
</div>
<p><strong>Monthly savings</strong>: 20 PRs √ó $0.368 = $7.36/month ‚Üí $88.32/year</p>
<h3 id="4-caching-strategies"><a class="header" href="#4-caching-strategies">4. Caching Strategies</a></h3>
<p><strong>Impact</strong>: Reduces build time by 30-50%</p>
<pre><code class="language-yaml">- uses: actions/cache@v4
  with:
    path: |
      ~/.cargo/registry
      ~/.cargo/git
      target/
    key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    restore-keys: |
      ${{ runner.os }}-cargo-
</code></pre>
<p><strong>Cache benefits</strong>:</p>
<ul>
<li>First run: ~5 minutes (full rebuild)</li>
<li>Cached run: ~2-3 minutes (incremental)</li>
<li>Savings: 40-50% time reduction</li>
</ul>
<p><strong>Cost impact</strong>: Reduces per-PR cost from $0.092 to ~$0.055 ($0.037 savings)</p>
<p><strong>Monthly savings</strong>: 20 PRs √ó $0.037 √ó 12 = $8.88/year</p>
<h3 id="5-label-gated-expensive-jobs"><a class="header" href="#5-label-gated-expensive-jobs">5. Label-Gated Expensive Jobs</a></h3>
<p><strong>Impact</strong>: Prevents accidental expensive runs</p>
<div class="table-wrapper"><table><thead><tr><th>Job</th><th>Trigger</th><th>When to Use</th></tr></thead><tbody>
<tr><td>Mutation testing</td><td><code>ci:mutation</code></td><td>Before releases, major refactors</td></tr>
<tr><td>Benchmarks</td><td><code>ci:bench</code></td><td>Performance-critical changes</td></tr>
<tr><td>Coverage</td><td><code>ci:coverage</code></td><td>Quarterly health checks</td></tr>
<tr><td>macOS</td><td><code>ci:mac</code></td><td>Platform-specific features only</td></tr>
</tbody></table>
</div>
<p><strong>Example workflow</strong>:</p>
<pre><code class="language-yaml">jobs:
  mutation:
    if: contains(github.event.pull_request.labels.*.name, 'ci:mutation')
    runs-on: ubuntu-latest
    steps:
      - run: cargo mutants
</code></pre>
<p><strong>Savings</strong>: Prevents 15 unnecessary mutation runs/month √ó $0.160 = $2.40/month ‚Üí $28.80/year</p>
<h3 id="6-optimized-test-parallelization"><a class="header" href="#6-optimized-test-parallelization">6. Optimized Test Parallelization</a></h3>
<p><strong>Impact</strong>: Reduces test execution time by 20-40%</p>
<pre><code class="language-yaml">env:
  RUST_TEST_THREADS: 2
  CARGO_BUILD_JOBS: 2
  RUSTFLAGS: "-Cdebuginfo=0 -Copt-level=1"
</code></pre>
<p><strong>Why this helps</strong>:</p>
<ul>
<li>Prevents memory exhaustion on GitHub runners</li>
<li>Avoids OOM kills that waste entire job</li>
<li>Reduces linker pressure (LLD thrashing)</li>
</ul>
<p><strong>Cost impact</strong>: Prevents ~5 job failures/month √ó $0.092 = $0.46/month ‚Üí $5.52/year</p>
<h3 id="7-fast-fail-checks-early-termination"><a class="header" href="#7-fast-fail-checks-early-termination">7. Fast Fail Checks (Early Termination)</a></h3>
<p><strong>Impact</strong>: Saves time when failures are obvious</p>
<pre><code class="language-yaml">jobs:
  format:
    runs-on: ubuntu-latest
    steps:
      - run: cargo fmt --check  # Fails in &lt;30s if issues found

  tests:
    needs: [format]  # Only run if format passes
</code></pre>
<p><strong>Benefit</strong>: If formatting fails, skip remaining jobs (saves ~4 minutes)</p>
<p><strong>Monthly savings</strong>: 10 format catches √ó 4 min √ó $0.008 √ó 12 = $3.84/year</p>
<hr />
<h2 id="monitoring"><a class="header" href="#monitoring">Monitoring</a></h2>
<h3 id="using-scriptsci-cost-monitorsh"><a class="header" href="#using-scriptsci-cost-monitorsh">Using <code>scripts/ci-cost-monitor.sh</code></a></h3>
<p><strong>Note</strong>: This script doesn‚Äôt exist yet. Below is the specification for creating it.</p>
<pre><code class="language-bash">#!/bin/bash
# scripts/ci-cost-monitor.sh
# Estimates CI costs from GitHub Actions API

# Usage:
#   bash scripts/ci-cost-monitor.sh [--month YYYY-MM] [--repo owner/name]

# Fetch workflow runs for the month
# Calculate total minutes per runner type
# Multiply by pricing
# Output cost breakdown and trends
</code></pre>
<p><strong>Planned implementation</strong> (Issue #211 Phase 3):</p>
<pre><code class="language-bash"># Show current month costs
bash scripts/ci-cost-monitor.sh

# Output:
# CI Cost Report (2025-01)
# ========================
# Linux:    127 min √ó $0.008 = $1.02
# Windows:   45 min √ó $0.016 = $0.72
# macOS:      0 min √ó $0.080 = $0.00
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Total:                       $1.74
#
# PRs:        18
# Avg/PR:     $0.097
# Trend:      ‚Üì 12% vs last month
</code></pre>
<h3 id="reading-github-billing-reports"><a class="header" href="#reading-github-billing-reports">Reading GitHub Billing Reports</a></h3>
<p>GitHub provides billing information at:</p>
<ul>
<li><strong>Organization</strong>: <code>Settings ‚Üí Billing ‚Üí Usage this month</code></li>
<li><strong>Personal</strong>: <code>Settings ‚Üí Billing and plans ‚Üí Plans and usage</code></li>
</ul>
<p><strong>Key metrics to track</strong>:</p>
<ol>
<li><strong>Total minutes used</strong> (current month)</li>
<li><strong>Minutes per repository</strong> (identify high-cost repos)</li>
<li><strong>Cost breakdown by runner type</strong> (Linux/Windows/macOS split)</li>
<li><strong>Trend over time</strong> (month-over-month comparison)</li>
</ol>
<p><strong>Export options</strong>:</p>
<ul>
<li>Download usage CSV: <code>Billing ‚Üí Usage ‚Üí Download CSV</code></li>
<li>API access: <code>GET /orgs/{org}/settings/billing/actions</code></li>
</ul>
<h3 id="setting-up-alerts"><a class="header" href="#setting-up-alerts">Setting Up Alerts</a></h3>
<h4 id="option-1-github-spending-limits"><a class="header" href="#option-1-github-spending-limits">Option 1: GitHub Spending Limits</a></h4>
<p>Navigate to: <code>Settings ‚Üí Billing ‚Üí Spending limits</code></p>
<pre><code>Recommended limits for perl-lsp:
- Monthly spending limit: $10
- Email alert at: $5 (50% threshold)
- Email alert at: $8 (80% threshold)
</code></pre>
<h4 id="option-2-github-actions-workflow-monitor"><a class="header" href="#option-2-github-actions-workflow-monitor">Option 2: GitHub Actions Workflow Monitor</a></h4>
<p>Create <code>.github/workflows/cost-monitor.yml</code>:</p>
<pre><code class="language-yaml">name: Cost Monitor

on:
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Monday
  workflow_dispatch:

jobs:
  cost-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Fetch usage data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Query workflow runs from past week
          gh api /repos/${{ github.repository }}/actions/runs \
            --jq '.workflow_runs[] | select(.created_at &gt; (now - 604800)) | .run_duration_ms' \
            | awk '{sum+=$1} END {print "Total: " sum/60000 " minutes"}'

      - name: Alert if high usage
        run: |
          # If &gt; 500 minutes/week, send alert
          # (Implementation TBD)
</code></pre>
<h4 id="option-3-external-monitoring"><a class="header" href="#option-3-external-monitoring">Option 3: External Monitoring</a></h4>
<p>Use third-party tools:</p>
<ul>
<li><strong>ActionsUsage</strong>: GitHub marketplace app for usage tracking</li>
<li><strong>Grafana + GitHub API</strong>: Custom dashboard</li>
<li><strong>Prometheus exporter</strong>: For integrated monitoring</li>
</ul>
<hr />
<h2 id="decision-matrix"><a class="header" href="#decision-matrix">Decision Matrix</a></h2>
<h3 id="when-to-run-ci-vs-local-validation"><a class="header" href="#when-to-run-ci-vs-local-validation">When to Run CI vs Local Validation</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Scenario</th><th>Local Validation</th><th>GitHub Actions CI</th></tr></thead><tbody>
<tr><td><strong>Fixing typo in code</strong></td><td>‚úÖ <code>just ci-gate</code></td><td>‚ùå Skip (use <code>--no-verify</code>)</td></tr>
<tr><td><strong>Adding new feature</strong></td><td>‚úÖ <code>just ci-full</code></td><td>‚úÖ Essential jobs</td></tr>
<tr><td><strong>Refactoring parser</strong></td><td>‚úÖ <code>just ci-full</code> + smoke test</td><td>‚úÖ Essential + <code>ci:stress</code></td></tr>
<tr><td><strong>Updating docs only</strong></td><td>‚ùå Not needed</td><td>‚ùå Skipped (path filter)</td></tr>
<tr><td><strong>Pre-release testing</strong></td><td>‚úÖ <code>just ci-full-msrv</code></td><td>‚úÖ All jobs + labels</td></tr>
<tr><td><strong>Hotfix for prod</strong></td><td>‚úÖ <code>just ci-gate</code> minimum</td><td>‚úÖ Essential jobs</td></tr>
<tr><td><strong>Experimenting/WIP</strong></td><td>‚ö†Ô∏è Optional</td><td>‚ùå Push to fork instead</td></tr>
</tbody></table>
</div>
<h3 id="essential-vs-optional-workflows"><a class="header" href="#essential-vs-optional-workflows">Essential vs Optional Workflows</a></h3>
<h4 id="essential-every-pr"><a class="header" href="#essential-every-pr">Essential (Every PR)</a></h4>
<p><strong>Criteria</strong>: Fast (&lt;5 min), high value, catches critical issues</p>
<ul>
<li>‚úÖ Format check (<code>cargo fmt --check</code>)</li>
<li>‚úÖ Clippy (lib only) (<code>cargo clippy --workspace --lib</code>)</li>
<li>‚úÖ Library tests (<code>cargo test --workspace --lib</code>)</li>
<li>‚úÖ Panic safety check (no unwrap/expect in production)</li>
<li>‚úÖ Policy checks (exit status, metrics freshness)</li>
<li>‚úÖ LSP semantic tests (core functionality)</li>
</ul>
<p><strong>Total cost</strong>: ~$0.08/PR
<strong>Total time</strong>: ~5-8 minutes</p>
<h4 id="optional-label-gated"><a class="header" href="#optional-label-gated">Optional (Label-Gated)</a></h4>
<p><strong>Criteria</strong>: Expensive (&gt;5 min), specialized, not always needed</p>
<ul>
<li>
<p>üè∑Ô∏è <strong>Mutation testing</strong> (<code>ci:mutation</code>)</p>
<ul>
<li>When: Before releases, major refactors</li>
<li>Cost: $0.16/run</li>
<li>Time: ~20 minutes</li>
</ul>
</li>
<li>
<p>üè∑Ô∏è <strong>Benchmarks</strong> (<code>ci:bench</code>)</p>
<ul>
<li>When: Performance-critical changes</li>
<li>Cost: $0.04/run</li>
<li>Time: ~5 minutes</li>
</ul>
</li>
<li>
<p>üè∑Ô∏è <strong>Coverage</strong> (<code>ci:coverage</code>)</p>
<ul>
<li>When: Quarterly health checks</li>
<li>Cost: $0.06/run</li>
<li>Time: ~8 minutes</li>
</ul>
</li>
<li>
<p>üè∑Ô∏è <strong>macOS</strong> (<code>ci:mac</code>)</p>
<ul>
<li>When: Platform-specific features only</li>
<li>Cost: $0.80/run (expensive!)</li>
<li>Time: ~10 minutes</li>
</ul>
</li>
<li>
<p>üè∑Ô∏è <strong>Full LSP tests</strong> (auto-triggers on code changes)</p>
<ul>
<li>When: Changes to <code>crates/perl-lsp/</code> or <code>crates/perl-parser/src/lsp/</code></li>
<li>Cost: $0.03/run</li>
<li>Time: ~4 minutes</li>
</ul>
</li>
<li>
<p>üè∑Ô∏è <strong>Property tests</strong> (<code>ci:property</code>)</p>
<ul>
<li>When: Parser changes, stress testing</li>
<li>Cost: $0.05/run</li>
<li>Time: ~6 minutes</li>
</ul>
</li>
</ul>
<h4 id="never-in-ci-local-only"><a class="header" href="#never-in-ci-local-only">Never in CI (Local Only)</a></h4>
<p><strong>Criteria</strong>: Extremely expensive, exploratory, manual intervention</p>
<ul>
<li>‚ùå <strong>Interactive debugging</strong> (use local Rust debugger)</li>
<li>‚ùå <strong>Profiling</strong> (use <code>cargo flamegraph</code> locally)</li>
<li>‚ùå <strong>Experimental features</strong> (test on fork or local first)</li>
<li>‚ùå <strong>Manual smoke tests</strong> (editor integration checks)</li>
</ul>
<hr />
<h2 id="best-practices-summary"><a class="header" href="#best-practices-summary">Best Practices Summary</a></h2>
<h3 id="do"><a class="header" href="#do">DO</a></h3>
<p>‚úÖ <strong>Run <code>just ci-gate</code> before every push</strong> (automatic with pre-push hook)
‚úÖ <strong>Use concurrency cancellation</strong> in all workflows
‚úÖ <strong>Add path filters</strong> to skip irrelevant changes
‚úÖ <strong>Label-gate expensive jobs</strong> (mutation, benchmarks, macOS)
‚úÖ <strong>Cache cargo dependencies</strong> and build artifacts
‚úÖ <strong>Monitor monthly costs</strong> via GitHub billing
‚úÖ <strong>Set spending limits</strong> and alerts ($10/month cap recommended)
‚úÖ <strong>Optimize test parallelization</strong> (RUST_TEST_THREADS=2)
‚úÖ <strong>Fast-fail on format/clippy</strong> before running tests
‚úÖ <strong>Iterate locally</strong> before pushing to CI</p>
<h3 id="dont"><a class="header" href="#dont">DON‚ÄôT</a></h3>
<p>‚ùå <strong>Push without local validation</strong> (wastes money and time)
‚ùå <strong>Run expensive jobs on every PR</strong> (use label gates)
‚ùå <strong>Use macOS runners by default</strong> (10x cost of Linux!)
‚ùå <strong>Forget to cache dependencies</strong> (rebuilds are expensive)
‚ùå <strong>Skip concurrency groups</strong> (old runs waste money)
‚ùå <strong>Test docs changes in CI</strong> (use path filters)
‚ùå <strong>Force-push repeatedly</strong> without cancellation
‚ùå <strong>Ignore flaky tests</strong> (reruns multiply costs)
‚ùå <strong>Over-parallelize tests</strong> (causes OOM, wastes runner time)
‚ùå <strong>Run mutation tests on every commit</strong> (20+ minutes each)</p>
<hr />
<h2 id="cost-reduction-checklist"><a class="header" href="#cost-reduction-checklist">Cost Reduction Checklist</a></h2>
<p>Use this checklist when adding new workflows or jobs:</p>
<ul>
<li><input disabled="" type="checkbox"/>
Does this job need to run on every PR? (If no, add label gate)</li>
<li><input disabled="" type="checkbox"/>
Can this job be skipped for docs-only changes? (Add path filter)</li>
<li><input disabled="" type="checkbox"/>
Is concurrency cancellation configured? (Prevent parallel runs)</li>
<li><input disabled="" type="checkbox"/>
Are dependencies cached? (Cargo registry, git, target/)</li>
<li><input disabled="" type="checkbox"/>
Is the runner type optimal? (Prefer Linux over Windows/macOS)</li>
<li><input disabled="" type="checkbox"/>
Can this be validated locally first? (Add to <code>just ci-gate</code>)</li>
<li><input disabled="" type="checkbox"/>
Is the job timeout reasonable? (Prevent runaway jobs)</li>
<li><input disabled="" type="checkbox"/>
Are tests parallelized safely? (RUST_TEST_THREADS=2)</li>
<li><input disabled="" type="checkbox"/>
Does the job fail fast? (Early termination on errors)</li>
<li><input disabled="" type="checkbox"/>
Is the job matrix minimal? (Only test necessary combinations)</li>
</ul>
<hr />
<h2 id="related-documentation"><a class="header" href="#related-documentation">Related Documentation</a></h2>
<ul>
<li><strong><a href="CI_LOCAL_VALIDATION.html">CI_LOCAL_VALIDATION.md</a></strong> - Local-first validation workflow</li>
<li><strong><a href="CI.html">CI.md</a></strong> - GitHub Actions architecture</li>
<li><strong><a href="CI_TEST_LANES.html">CI_TEST_LANES.md</a></strong> - Test lane organization</li>
<li><strong><a href="COMMANDS_REFERENCE.html">COMMANDS_REFERENCE.md</a></strong> - Full command catalog</li>
<li><strong>Issue #211</strong> - CI Pipeline Cleanup (tracking issue)</li>
</ul>
<hr />
<p><strong>Last Updated</strong>: 2025-01-11
<strong>Issue</strong>: #211 (CI Pipeline Cleanup)
<strong>Status</strong>: Phase 2 - Cost Model Documentation</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../ci/test-lanes.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../ci/debt-tracking.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../ci/test-lanes.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../ci/debt-tracking.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
