# ============================================================================
# Fuzzing Recipes (cargo-fuzz integration)
# ============================================================================

# Run fuzzing on specific target (default: 60 seconds)
fuzz target='parser_comprehensive' duration='60':
    @echo "ðŸ”¥ Fuzzing {{target}} for {{duration}} seconds..."
    @cargo +nightly fuzz run {{target}} -- -max_total_time={{duration}}

# Run fuzzing with custom libFuzzer arguments
fuzz-custom target args='':
    @echo "ðŸ”¥ Fuzzing {{target}} with custom args..."
    @cargo +nightly fuzz run {{target}} -- {{args}}

# List available fuzz targets
fuzz-list:
    @echo "ðŸ“‹ Available fuzz targets:"
    @cargo +nightly fuzz list

# Check fuzz corpus coverage for a target
fuzz-coverage target='parser_comprehensive':
    @echo "ðŸ“Š Checking coverage for {{target}}..."
    @cargo +nightly fuzz coverage {{target}}
    @echo ""
    @echo "To view coverage report, open: fuzz/coverage/{{target}}/coverage/index.html"

# Minimize a crash case to smallest reproducing input
fuzz-minimize target crash:
    @echo "ðŸ” Minimizing crash case for {{target}}..."
    @cargo +nightly fuzz cmin {{target}} {{crash}}

# Run continuous fuzzing (for local development, Ctrl+C to stop)
fuzz-continuous target='parser_comprehensive':
    @echo "ðŸ”¥ Running continuous fuzzing on {{target}} (Ctrl+C to stop)..."
    @echo "ðŸ“Š Corpus location: fuzz/corpus/{{target}}"
    @echo "ðŸ’¥ Crashes will be saved to: fuzz/artifacts/{{target}}"
    @cargo +nightly fuzz run {{target}}

# Seed corpus with existing test files
fuzz-seed-corpus:
    @echo "ðŸŒ± Seeding fuzz corpus from test files..."
    @mkdir -p fuzz/corpus/parser_comprehensive
    @mkdir -p fuzz/corpus/lexer_robustness
    @find examples -name "*.pl" -type f 2>/dev/null | head -50 | while read f; do cp "$$f" "fuzz/corpus/parser_comprehensive/" 2>/dev/null || true; done
    @find test_corpus -name "*.pl" -type f 2>/dev/null | head -50 | while read f; do cp "$$f" "fuzz/corpus/lexer_robustness/" 2>/dev/null || true; done
    @echo "âœ… Corpus seeding complete"
    @echo "   Parser corpus: $$(ls fuzz/corpus/parser_comprehensive/ 2>/dev/null | wc -l) files"
    @echo "   Lexer corpus: $$(ls fuzz/corpus/lexer_robustness/ 2>/dev/null | wc -l) files"

# Check for crash artifacts (fails if crashes found)
fuzz-check-crashes:
    @echo "ðŸ’¥ Checking for crash artifacts..."
    @if [ -d fuzz/artifacts ]; then \
        CRASHES=$$(find fuzz/artifacts -type f 2>/dev/null | wc -l); \
        if [ $$CRASHES -gt 0 ]; then \
            echo "âš ï¸  Found $$CRASHES crash artifacts:"; \
            find fuzz/artifacts -type f 2>/dev/null; \
            exit 1; \
        else \
            echo "âœ… No crashes found"; \
        fi; \
    else \
        echo "âœ… No artifacts directory (no crashes)"; \
    fi

# Run all fuzz targets for regression testing (short duration)
fuzz-regression duration='30':
    @echo "ðŸ”¥ Running fuzz regression tests ({{duration}}s per target)..."
    @just fuzz parser_comprehensive {{duration}} || true
    @just fuzz lexer_robustness {{duration}} || true
    @just fuzz substitution_parsing {{duration}} || true
    @just fuzz builtin_functions {{duration}} || true
    @just fuzz unicode_positions {{duration}} || true
    @just fuzz lsp_navigation {{duration}} || true
    @just fuzz heredoc_parsing {{duration}} || true
    @just fuzz-check-crashes
    @echo "âœ… Fuzz regression testing complete"
