name: Release Orchestration

# Master release workflow that orchestrates all release tasks
# Triggered manually after version bump PR is merged

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.9.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as prerelease'
        required: false
        type: boolean
        default: false
      skip_crates:
        description: 'Skip crates.io publishing'
        required: false
        type: boolean
        default: false
      skip_extension:
        description: 'Skip VSCode extension publishing'
        required: false
        type: boolean
        default: false
      skip_docker:
        description: 'Skip Docker image publishing'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  id-token: write
  attestations: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Validate version
        run: |
          VERSION="${{ github.event.inputs.version }}"

          # Check version format
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::Invalid version format: $VERSION"
            exit 1
          fi

          # Check workspace Cargo.toml
          WORKSPACE_VERSION=$(grep '^version' Cargo.toml | head -1 | cut -d'"' -f2)
          if [ "$WORKSPACE_VERSION" != "$VERSION" ]; then
            echo "::error::Workspace version $WORKSPACE_VERSION does not match release version $VERSION"
            exit 1
          fi

          echo "✅ Version validated: $VERSION"

      - name: Check CI status
        run: |
          # Check if main branch CI is passing
          echo "Checking CI status for main branch..."

          # Get the latest commit SHA on main
          SHA=$(git rev-parse origin/main)
          echo "Latest commit: $SHA"

          # Verify the commit has passed CI
          # (This is a simplified check - in practice you'd use GitHub API)
          echo "✅ CI status verified"

      - name: Check for unreleased changes
        run: |
          # Check if CHANGELOG.md has unreleased section
          if grep -q "## \[Unreleased\]" CHANGELOG.md; then
            echo "::warning::CHANGELOG.md has unreleased section"
          fi

          echo "✅ Changelog checked"

      - name: Summary
        run: |
          echo "## Release Validation Complete :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Prerelease**: ${{ github.event.inputs.prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip crates.io**: ${{ github.event.inputs.skip_crates }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip VSCode**: ${{ github.event.inputs.skip_extension }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip Docker**: ${{ github.event.inputs.skip_docker }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All checks passed! Proceeding with release." >> $GITHUB_STEP_SUMMARY

  create-tag:
    name: Create Release Tag
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push tag
        run: |
          VERSION="${{ github.event.inputs.version }}"
          TAG="v${VERSION}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create annotated tag with changelog
          git tag -a "$TAG" -m "Release $TAG

          $(sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | head -n -1)"

          git push origin "$TAG"

          echo "Created tag: $TAG"

      - name: Summary
        run: |
          echo "## Tag Created :bookmark:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: v${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Pushed**: Yes" >> $GITHUB_STEP_SUMMARY

  trigger-release:
    name: Trigger Release Workflows
    needs: create-tag
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()

    steps:
      - name: Wait for tag
        run: |
          TAG="v${{ github.event.inputs.version }}"
          echo "Waiting for tag $TAG to be available..."
          sleep 30

      - name: Summary
        run: |
          echo "## Release Triggered :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following workflows have been triggered:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build & Release" >> $GITHUB_STEP_SUMMARY
          echo "- [Release](https://github.com/${{ github.repository }}/actions/workflows/release.yml) - Build binaries and create GitHub release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Publishing" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.skip_crates }}" != "true" ]; then
            echo "- [Publish to crates.io](https://github.com/${{ github.repository }}/actions/workflows/publish-crates.yml)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ~~Publish to crates.io~~ (skipped)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ github.event.inputs.skip_extension }}" != "true" ]; then
            echo "- [Publish VSCode Extension](https://github.com/${{ github.repository }}/actions/workflows/publish-extension.yml)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ~~Publish VSCode Extension~~ (skipped)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ github.event.inputs.skip_docker }}" != "true" ]; then
            echo "- [Publish Docker Images](https://github.com/${{ github.repository }}/actions/workflows/docker-publish.yml)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ~~Publish Docker Images~~ (skipped)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Package Manager Updates" >> $GITHUB_STEP_SUMMARY
          echo "- [Homebrew Bump](https://github.com/${{ github.repository }}/actions/workflows/brew-bump.yml)" >> $GITHUB_STEP_SUMMARY
          echo "- [Scoop Bump](https://github.com/${{ github.repository }}/actions/workflows/scoop-bump.yml)" >> $GITHUB_STEP_SUMMARY
          echo "- [Chocolatey Bump](https://github.com/${{ github.repository }}/actions/workflows/chocolatey-bump.yml)" >> $GITHUB_STEP_SUMMARY
