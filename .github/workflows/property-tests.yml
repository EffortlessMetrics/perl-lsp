name: Property Tests

on:
  workflow_dispatch: {}
  pull_request:
    branches: [ main, master ]
    types: [labeled]

# Cancel in-flight runs on new pushes (saves minutes)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  property-tests-standard:
    name: Property Tests (Standard)
    timeout-minutes: 20
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.labels.*.name, 'ci:property')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate Cargo.lock (strict)
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f Cargo.lock ]; then
            echo "::error:: Cargo.lock is required for --locked builds. Commit it." >&2
            exit 1
          fi
          # Prove the lockfile can be consumed without mutation
          cargo metadata --format-version=1 --locked >/dev/null
          # Prevent nested lockfiles
          if git ls-files | grep -E '(.+/)?Cargo\.lock' | grep -v '^Cargo\.lock' | grep -q .; then
            echo "::error::Nested Cargo.lock files detected:"
            git ls-files | grep -E '(.+/)?Cargo\.lock' | grep -v '^Cargo\.lock'
            exit 1
          fi

      - name: CI policy - enforce --locked on cargo commands
        shell: bash
        run: |
          set -euo pipefail
          if grep -RIn --exclude-dir=target --include="*.yml" -E 'cargo (build|test|install|nextest|bench|clippy|doc|run|check|publish)\b' .github/workflows | grep -v '\-\-locked' | tee /dev/stderr | grep -q .; then
            echo "::error::Found cargo invocations without --locked (see above)."
            exit 1
          fi

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: property-tests-${{ hashFiles('Cargo.lock') }}
          cache-on-failure: true
      
      - name: Run standard property tests
        run: |
          echo "Running property tests with default case count..."
          cargo test --locked -p perl-lexer --test prop_lexer_termination
          cargo test --locked -p perl-parser --test prop_invariants
          cargo test --locked -p perl-parser --test prop_qw
          cargo test --locked -p perl-parser --test prop_quote_like
          cargo test --locked -p perl-parser --test prop_whitespace
          cargo test --locked -p perl-parser --test prop_whitespace_idempotence
          cargo test --locked -p perl-parser --test prop_deletion

      - name: Assert lockfile unchanged
        if: ${{ always() }}
        shell: bash
        run: |
          if ! git diff --quiet -- Cargo.lock; then
            echo "::error::Cargo.lock changed during this job. Run 'cargo update' locally and commit the result."
            git --no-pager diff -- Cargo.lock | sed -n '1,200p'
            exit 1
          fi

  property-tests-extended:
    name: Property Tests (Extended - 256 cases)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Only run extended tests on schedule, dispatch, or when ci:property label is present
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.labels.*.name, 'ci:property')
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: property-tests-extended-${{ hashFiles('Cargo.lock') }}
          cache-on-failure: true
      
      - name: Run extended property tests
        env:
          PROPTEST_CASES: 256
        run: |
          echo "Running property tests with PROPTEST_CASES=256..."
          cargo test --locked -p perl-lexer --test prop_lexer_termination -- --nocapture
          cargo test --locked -p perl-parser --test prop_invariants -- --nocapture
          cargo test --locked -p perl-parser --test prop_qw -- --nocapture
          cargo test --locked -p perl-parser --test prop_quote_like -- --nocapture
          cargo test --locked -p perl-parser --test prop_whitespace -- --nocapture
          cargo test --locked -p perl-parser --test prop_whitespace_idempotence -- --nocapture
          cargo test --locked -p perl-parser --test prop_deletion -- --nocapture

      - name: Assert lockfile unchanged
        if: ${{ always() }}
        shell: bash
        run: |
          if ! git diff --quiet -- Cargo.lock; then
            echo "::error::Cargo.lock changed during this job. Run 'cargo update' locally and commit the result."
            git --no-pager diff -- Cargo.lock | sed -n '1,200p'
            exit 1
          fi

  lexer-contract-tests:
    name: Lexer Contract Tests
    timeout-minutes: 15
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.labels.*.name, 'ci:property')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: lexer-contract-tests-${{ hashFiles('Cargo.lock') }}
          cache-on-failure: true
      
      - name: Run lexer contract tests
        run: |
          cargo test --locked -p perl-lexer --test lexer_contract_tests

      - name: Assert lockfile unchanged
        if: ${{ always() }}
        shell: bash
        run: |
          if ! git diff --quiet -- Cargo.lock; then
            echo "::error::Cargo.lock changed during this job. Run 'cargo update' locally and commit the result."
            git --no-pager diff -- Cargo.lock | sed -n '1,200p'
            exit 1
          fi

  parser-integration-tests:
    name: Parser Integration Tests
    timeout-minutes: 15
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.labels.*.name, 'ci:property')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: parser-integration-tests-${{ hashFiles('Cargo.lock') }}
          cache-on-failure: true
      
      - name: Run parser token integration tests
        run: |
          cargo test --locked -p perl-parser --test parser_token_integration_tests

      - name: Assert lockfile unchanged
        if: ${{ always() }}
        shell: bash
        run: |
          if ! git diff --quiet -- Cargo.lock; then
            echo "::error::Cargo.lock changed during this job. Run 'cargo update' locally and commit the result."
            git --no-pager diff -- Cargo.lock | sed -n '1,200p'
            exit 1
          fi
