name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.6.0)'
        required: true
        type: string

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            archive: tar.gz
          - target: x86_64-apple-darwin
            os: macos-latest
            archive: tar.gz
          - target: aarch64-apple-darwin
            os: macos-latest
            archive: tar.gz
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            archive: zip

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      - name: Build binaries
        run: |
          cargo build --release -p perl-parser --bin perl-lsp --target ${{ matrix.target }}
          cargo build --release -p perl-parser --bin perl-dap --target ${{ matrix.target }}

      - name: Strip binaries (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          strip target/${{ matrix.target }}/release/perl-lsp
          strip target/${{ matrix.target }}/release/perl-dap

      - name: Package (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          mkdir -p dist
          cd target/${{ matrix.target }}/release
          tar czf ../../../dist/perl-lsp-${{ github.event.inputs.version || github.ref_name }}-${{ matrix.target }}.tar.gz perl-lsp perl-dap
          cd ../../../
          sha256sum dist/*.tar.gz > dist/checksums-${{ matrix.target }}.txt

      - name: Package (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist
          Compress-Archive -Path target\${{ matrix.target }}\release\perl-lsp.exe, target\${{ matrix.target }}\release\perl-dap.exe -DestinationPath dist\perl-lsp-${{ github.event.inputs.version || github.ref_name }}-${{ matrix.target }}.zip
          Get-FileHash dist\*.zip | Format-Table -AutoSize | Out-File -FilePath dist\checksums-${{ matrix.target }}.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.target }}
          path: dist/*

  build-vscode:
    name: Build VSCode Extension
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: vscode-extension/package-lock.json

      - name: Install dependencies
        working-directory: vscode-extension
        run: npm ci

      - name: Build extension
        working-directory: vscode-extension
        run: |
          npm run compile
          npx vsce package

      - name: Upload VSIX
        uses: actions/upload-artifact@v4
        with:
          name: vscode-extension
          path: vscode-extension/*.vsix

  release:
    name: Create Release
    needs: [build, build-vscode]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          mv artifacts/binaries-*/* release/
          mv artifacts/vscode-extension/*.vsix release/
          cd release
          cat checksums-*.txt > checksums.txt
          rm checksums-*.txt
          ls -la

      - name: Create release notes
        run: |
          VERSION=${{ github.event.inputs.version || github.ref_name }}
          cat > release-notes.md << EOF
          # Perl Language Server ${VERSION}
          
          ## ðŸŽ‰ Highlights
          
          - **Call Hierarchy**: Navigate incoming and outgoing function calls
          - **Inlay Hints**: See parameter names and type hints inline
          - **Test Explorer**: Discover and run Perl tests from your IDE
          - **Debug Support**: Full DAP implementation with breakpoints and stepping
          - **Performance**: AST caching and symbol indexing for large projects
          
          ## ðŸ“¦ Installation
          
          ### Quick Install (Linux/macOS)
          \`\`\`bash
          curl -fsSL https://raw.githubusercontent.com/EffortlessSteven/tree-sitter-perl/main/install.sh | bash
          \`\`\`
          
          ### Homebrew (macOS)
          \`\`\`bash
          brew tap tree-sitter-perl/tap
          brew install perl-lsp
          \`\`\`
          
          ### VSCode Extension
          Install from the marketplace or download the VSIX file below.
          
          ### Manual Installation
          Download the appropriate archive for your platform and extract to your PATH.
          
          ## ðŸ“‹ Checksums
          See \`checksums.txt\` for SHA256 hashes of all release files.
          
          ## ðŸ“š Documentation
          - [Getting Started](https://github.com/EffortlessSteven/tree-sitter-perl#quick-start)
          - [Configuration](https://github.com/EffortlessSteven/tree-sitter-perl#configuration)
          - [Contributing](https://github.com/EffortlessSteven/tree-sitter-perl#contributing)
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: v${{ github.event.inputs.version || github.ref_name }}
          body_path: release-notes.md
          files: release/*
          draft: false
          prerelease: false

  publish-crates:
    name: Publish to crates.io
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish perl-lexer
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          cd crates/perl-lexer
          cargo publish --no-verify

      - name: Wait for crates.io
        run: sleep 30

      - name: Publish perl-parser
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          cd crates/perl-parser
          cargo publish --no-verify

  publish-vscode:
    name: Publish VSCode Extension
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: vscode-extension
        run: npm ci

      - name: Publish to marketplace
        working-directory: vscode-extension
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: npx vsce publish