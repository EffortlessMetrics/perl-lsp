name: Dead Code Detection

on:
  workflow_dispatch: {}
  pull_request:
    branches: [ main, master ]
    types: [labeled]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.claude/**'
  schedule:
    # Run weekly on Monday at 3 AM UTC
    - cron: '0 3 * * 1'

# Cancel in-flight runs on new pushes (saves minutes)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: "1"

jobs:
  dead-code-check:
    name: Dead Code Detection
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    # Run on: workflow_dispatch, schedule, or PRs with ci:dead-code label
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'pull_request' &&
       contains(github.event.pull_request.labels.*.name, 'ci:dead-code'))
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Install Rust nightly (for cargo-udeps)
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: dead-code-${{ hashFiles('Cargo.lock') }}
          cache-on-failure: true

      - name: Install cargo-udeps
        run: cargo install cargo-udeps --locked

      - name: Run dead code detection
        run: |
          bash scripts/dead-code-check.sh check

      - name: Upload dead code report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: dead-code-report
          path: |
            target/dead-code/*.txt
            target/dead-code/report.json
          retention-days: 7

      - name: Generate PR comment (on PR)
        if: github.event_name == 'pull_request'
        run: |
          if [ -f target/dead-code/report.json ]; then
            echo "## Dead Code Detection Results" > pr-comment.md
            echo "" >> pr-comment.md

            # Extract counts from JSON
            unused_deps=$(jq -r '.results.unused_dependencies' target/dead-code/report.json)
            dead_code=$(jq -r '.results.dead_code_items' target/dead-code/report.json)
            unused_imports=$(jq -r '.results.unused_imports' target/dead-code/report.json)
            unused_vars=$(jq -r '.results.unused_variables' target/dead-code/report.json)
            total=$(jq -r '.results.total_issues' target/dead-code/report.json)

            echo "| Category | Count |" >> pr-comment.md
            echo "|----------|-------|" >> pr-comment.md
            echo "| Unused Dependencies | $unused_deps |" >> pr-comment.md
            echo "| Dead Code Items | $dead_code |" >> pr-comment.md
            echo "| Unused Imports | $unused_imports |" >> pr-comment.md
            echo "| Unused Variables | $unused_vars |" >> pr-comment.md
            echo "| **Total** | **$total** |" >> pr-comment.md
            echo "" >> pr-comment.md

            if [ "$total" -eq 0 ]; then
              echo "✅ No dead code detected!" >> pr-comment.md
            else
              echo "⚠️ Some dead code detected. Review the artifacts for details." >> pr-comment.md
            fi

            echo "" >> pr-comment.md
            echo "<details>" >> pr-comment.md
            echo "<summary>View full reports</summary>" >> pr-comment.md
            echo "" >> pr-comment.md
            echo "Download the artifacts from this workflow run for detailed reports." >> pr-comment.md
            echo "</details>" >> pr-comment.md

            cat pr-comment.md
          fi

  unused-deps-only:
    name: Unused Dependencies (Fast)
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    # Run on all PRs for quick feedback
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: udeps-${{ hashFiles('Cargo.lock') }}

      - name: Install cargo-udeps
        run: cargo install cargo-udeps --locked

      - name: Check for unused dependencies
        run: |
          echo "Checking for unused dependencies..."
          cargo +nightly udeps --workspace --all-targets --locked 2>&1 | tee udeps-output.txt

          # Count unused dependencies
          unused_count=$(grep -c "unused" udeps-output.txt || echo 0)

          echo ""
          echo "Summary: Found $unused_count unused dependency warnings"

          if [ "$unused_count" -gt 0 ]; then
            echo "::warning::Found $unused_count unused dependencies"
          else
            echo "✅ No unused dependencies detected"
          fi

  clippy-dead-code:
    name: Clippy Dead Code Lint
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    # Run on all PRs for quick feedback
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: clippy-dead-code-${{ hashFiles('Cargo.lock') }}

      - name: Run clippy with dead_code lint
        run: |
          echo "Checking for dead code with clippy..."

          # Run clippy with dead code warnings (but don't fail the build)
          cargo clippy --workspace --lib --bins --locked \
            -- -W dead_code -W unused_imports -W unused_variables \
            2>&1 | tee clippy-dead-code.txt || true

          # Count warnings
          dead_code_count=$(grep -c "warning:.*dead_code" clippy-dead-code.txt || echo 0)
          unused_imports_count=$(grep -c "warning:.*unused_imports" clippy-dead-code.txt || echo 0)
          unused_vars_count=$(grep -c "warning:.*unused_variables" clippy-dead-code.txt || echo 0)

          total=$((dead_code_count + unused_imports_count + unused_vars_count))

          echo ""
          echo "Summary:"
          echo "  Dead code warnings:      $dead_code_count"
          echo "  Unused imports warnings: $unused_imports_count"
          echo "  Unused variables warnings: $unused_vars_count"
          echo "  Total:                   $total"

          if [ "$total" -gt 0 ]; then
            echo "::warning::Found $total dead code/unused warnings"
          else
            echo "✅ No dead code detected by clippy"
          fi

      - name: Upload clippy output
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: clippy-dead-code-output
          path: clippy-dead-code.txt
          retention-days: 7
