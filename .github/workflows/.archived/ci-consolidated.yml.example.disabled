# Example: Consolidated CI Workflow using Reusable Components
#
# This file demonstrates how to use the reusable workflow and composite actions
# to build a tiered CI system. Copy and adapt as needed.
#
# To use: Rename to ci-consolidated.yml (remove .example suffix)

name: CI (Consolidated)

on:
  pull_request:
    branches: [master, main]
  push:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      tier:
        description: 'Tier to run'
        required: true
        default: 'merge-gate'
        type: choice
        options:
          - pr-fast
          - merge-gate
          - nightly
  schedule:
    # Nightly at 2am UTC
    - cron: '0 2 * * *'

# Cancel in-progress runs on new pushes
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: '1'

jobs:
  # ==========================================================================
  # Determine which tier to run based on context
  # ==========================================================================
  determine-tier:
    name: Determine Tier
    runs-on: ubuntu-latest
    outputs:
      tier: ${{ steps.tier.outputs.tier }}
      os: ${{ steps.tier.outputs.os }}
    steps:
      - name: Determine tier
        id: tier
        run: |
          # Manual dispatch with specific tier
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tier=${{ github.event.inputs.tier }}" >> $GITHUB_OUTPUT
            if [ "${{ github.event.inputs.tier }}" = "nightly" ]; then
              echo 'os=["ubuntu-latest", "windows-latest", "macos-latest"]' >> $GITHUB_OUTPUT
            else
              echo 'os=["ubuntu-latest"]' >> $GITHUB_OUTPUT
            fi
            exit 0
          fi

          # Scheduled runs = nightly tier
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "tier=nightly" >> $GITHUB_OUTPUT
            echo 'os=["ubuntu-latest", "windows-latest", "macos-latest"]' >> $GITHUB_OUTPUT
            exit 0
          fi

          # Push to main = merge-gate
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "tier=merge-gate" >> $GITHUB_OUTPUT
            echo 'os=["ubuntu-latest", "windows-latest"]' >> $GITHUB_OUTPUT
            exit 0
          fi

          # PR with 'ready-to-merge' label = merge-gate
          if [ "${{ contains(github.event.pull_request.labels.*.name, 'ready-to-merge') }}" = "true" ]; then
            echo "tier=merge-gate" >> $GITHUB_OUTPUT
            echo 'os=["ubuntu-latest", "windows-latest"]' >> $GITHUB_OUTPUT
            exit 0
          fi

          # Default for PRs = pr-fast
          echo "tier=pr-fast" >> $GITHUB_OUTPUT
          echo 'os=["ubuntu-latest"]' >> $GITHUB_OUTPUT

  # ==========================================================================
  # Run the determined tier using reusable workflow
  # ==========================================================================
  ci:
    name: CI
    needs: determine-tier
    uses: ./.github/workflows/_rust-tier.yml
    with:
      tier: ${{ needs.determine-tier.outputs.tier }}
      os: ${{ needs.determine-tier.outputs.os }}
      toolchain: '1.89.0'
      upload-receipt: true
    secrets: inherit

  # ==========================================================================
  # Optional: Additional platform checks (only for merge-gate and nightly)
  # ==========================================================================
  platform-matrix:
    name: Platform Matrix
    if: needs.determine-tier.outputs.tier != 'pr-fast'
    needs: [determine-tier, ci]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        toolchain: [stable, '1.89.0']
        exclude:
          # Skip MSRV on non-Linux to save time
          - os: windows-latest
            toolchain: '1.89.0'
          - os: macos-latest
            toolchain: '1.89.0'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: ${{ matrix.toolchain }}
          cache: true
          cache-key-suffix: platform-${{ matrix.os }}-${{ matrix.toolchain }}

      - name: Build
        run: cargo build --locked --release -p perl-lsp

      - name: Basic tests
        run: cargo test --locked -p perl-parser --lib

  # ==========================================================================
  # Label-gated: Coverage (only when ci:coverage label is present)
  # ==========================================================================
  coverage:
    name: Coverage
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.labels.*.name, 'ci:coverage')
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
          components: llvm-tools-preview
          cache: true
          cache-key-suffix: coverage

      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov --locked

      - name: Generate coverage
        run: |
          cargo llvm-cov -p perl-parser --tests --lcov --output-path lcov.info
          cargo llvm-cov report -p perl-parser

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          fail_ci_if_error: false

  # ==========================================================================
  # Label-gated: Security Audit (only when ci:audit label is present)
  # ==========================================================================
  security:
    name: Security Audit
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      contains(github.event.pull_request.labels.*.name, 'ci:audit')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
          cache: false  # Audit doesn't need build cache

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run audit
        run: cargo audit

  # ==========================================================================
  # Summary job for branch protection
  # ==========================================================================
  ci-summary:
    name: CI Summary
    if: always()
    needs: [ci, platform-matrix]
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.ci.result }}" != "success" ]; then
            echo "CI tier failed"
            exit 1
          fi
          # Platform matrix is optional, only fail if it ran and failed
          if [ "${{ needs.platform-matrix.result }}" = "failure" ]; then
            echo "Platform matrix failed"
            exit 1
          fi
          echo "All required checks passed"
