name: CI (Nightly)

# Consolidated workflow for comprehensive nightly tests and label-gated jobs
# Combines: ci-expensive.yml, quality-checks.yml, fuzz.yml
# Cost: ~$0.15 per run (label-gated), ~$0.30 per nightly run

on:
  pull_request:
    branches: [ main, master ]
    types: [labeled]
  schedule:
    # Run nightly at 3am UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      run_mutation:
        description: 'Run mutation testing'
        required: false
        type: boolean
        default: true
      run_benchmarks:
        description: 'Run performance benchmarks'
        required: false
        type: boolean
        default: true
      run_coverage:
        description: 'Run test coverage'
        required: false
        type: boolean
        default: true
      run_fuzz:
        description: 'Run fuzz testing'
        required: false
        type: boolean
        default: true

# Cancel in-flight runs on new pushes (saves minutes)
concurrency:
  group: ci-nightly-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: full

jobs:
  # ============================================================================
  # Label-Gated Jobs (run on PR with specific labels)
  # ============================================================================

  mutation:
    name: Mutation Testing
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' &&
       contains(github.event.pull_request.labels.*.name, 'ci:mutation')) ||
      (github.event_name == 'schedule' && github.event.inputs.run_mutation != 'false')
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with: { toolchain: 1.92.0 }
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          key: ${{ runner.os }}-mutation-${{ hashFiles('Cargo.lock') }}
      - run: cargo install cargo-mutants --locked || true
      - run: cargo mutants --timeout 60 --no-shuffle || true

  benchmark:
    name: Performance Benchmarks
    timeout-minutes: 45
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      contains(github.event.pull_request.labels.*.name, 'ci:bench')
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        submodules: recursive

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo dependencies
      uses: Swatinem/rust-cache@v2
      with:
        key: ${{ runner.os }}-bench-${{ hashFiles('Cargo.lock') }}
        cache-on-failure: true

    - name: Install just
      run: cargo install just

    - name: Run benchmarks
      run: |
        # Run full benchmark suite
        cargo bench --workspace --locked -- --noplot 2>&1 | tee benchmarks/results/raw-output.txt || true

        # Extract structured results from Criterion
        python3 ./benchmarks/scripts/extract-criterion.py --output benchmarks/results/latest.json

    - name: Compare against baseline
      id: compare
      continue-on-error: true
      run: |
        if [ -f "benchmarks/baselines/v0.9.0.json" ]; then
          ./benchmarks/scripts/compare.sh --fail-on-regression 2>&1 | tee comparison.txt
          echo "REGRESSION=$?" >> $GITHUB_OUTPUT
        else
          echo "No baseline found, skipping comparison"
          echo "REGRESSION=0" >> $GITHUB_OUTPUT
        fi

    - name: Generate benchmark receipt
      run: |
        python3 ./benchmarks/scripts/format-results.py benchmarks/results/latest.json --receipt > benchmark_receipt.txt
        cat benchmark_receipt.txt

    - name: Generate markdown report
      run: |
        python3 ./benchmarks/scripts/format-results.py benchmarks/results/latest.json --markdown > benchmark_report.md

    - name: Generate performance alerts
      id: alert
      continue-on-error: true
      run: |
        if [ -f "benchmarks/baselines/v0.9.0.json" ]; then
          python3 ./benchmarks/scripts/alert.py --format markdown > alert.md
          python3 ./benchmarks/scripts/alert.py --check 2>&1
          echo "CRITICAL=$?" >> $GITHUB_OUTPUT
        else
          echo "No baseline found, skipping alerts"
          echo "CRITICAL=0" >> $GITHUB_OUTPUT
        fi

    - name: Comment on PR (performance alerts)
      if: github.event_name == 'pull_request' && (steps.compare.outputs.REGRESSION == '1' || steps.alert.outputs.CRITICAL != '')
      uses: actions/github-script@v8
      with:
        script: |
          const fs = require('fs');
          let body = '';

          if (fs.existsSync('alert.md')) {
            body = fs.readFileSync('alert.md', 'utf8');
          } else if (fs.existsSync('comparison.txt')) {
            const comparison = fs.readFileSync('comparison.txt', 'utf8');
            body = `## Performance Regression Detected\n\n\`\`\`\n${comparison}\n\`\`\`\n\nPlease review the benchmark results and address any performance regressions.`;
          }

          if (body) {
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
          }

    - name: Upload benchmark artifacts
      uses: actions/upload-artifact@v6
      with:
        name: benchmark-results-${{ github.sha }}
        path: |
          benchmarks/results/latest.json
          benchmarks/results/raw-output.txt
          benchmark_receipt.txt
          benchmark_report.md
          comparison.txt
          alert.md
        retention-days: 30

  test-coverage:
    name: Test Coverage
    runs-on: ubuntu-24.04
    timeout-minutes: 45
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' &&
       contains(github.event.pull_request.labels.*.name, 'ci:coverage')) ||
      github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ runner.os }}-coverage-${{ hashFiles('Cargo.lock') }}
          cache-on-failure: true

      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov --locked

      - name: Create legacy LSP fixtures (CI-only)
        run: |
          mkdir -p archive/legacy-tests/test_fixtures
          touch archive/legacy-tests/test_fixtures/main.pl
          touch archive/legacy-tests/test_fixtures/Module.pm
          touch archive/legacy-tests/test_fixtures/test.t

      - name: Run tests with coverage (parser only, lean)
        env:
          RUSTFLAGS: "-Copt-level=1 -Cdebuginfo=2"
          CARGO_BUILD_JOBS: 2
        run: |
          cargo llvm-cov -p perl-parser --tests --lcov --output-path lcov.info
          cargo llvm-cov report -p perl-parser

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: lcov.info
          fail_ci_if_error: false

  tautology-check:
    name: Tautology Detection
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' &&
       contains(github.event.pull_request.labels.*.name, 'ci:strict'))
    steps:
      - uses: actions/checkout@v6

      - name: Check for tautological assertions
        run: |
          echo "Checking for tautological test patterns..."

          if grep -r "assert!(.*\.is_some() || .*\.is_none())" tests/; then
            echo "❌ Found tautological assertions (is_some || is_none)"
            exit 1
          fi

          if grep -r "assert!(true)" tests/; then
            echo "❌ Found assert!(true)"
            exit 1
          fi

          if grep -r "assert!(.*\.len() >= 0)" tests/; then
            echo "❌ Found tautological length check (>= 0)"
            exit 1
          fi

          echo "✅ No tautological patterns found"

  semver-check:
    name: API Compatibility
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'pull_request' ||
      github.event_name == 'schedule'
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: semver-${{ hashFiles('Cargo.lock') }}
          cache-on-failure: true

      - name: Install cargo-semver-checks
        run: cargo install cargo-semver-checks --locked

      - name: Determine baseline tag
        id: baseline
        run: |
          BASELINE=$(git tag | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -1)
          echo "baseline=$BASELINE" >> $GITHUB_OUTPUT
          echo "Using baseline: $BASELINE"

      - name: Check perl-parser API compatibility
        run: |
          cargo semver-checks check-release -p perl-parser \
            --baseline-rev ${{ steps.baseline.outputs.baseline }} \
            || echo "::warning::Breaking changes detected in perl-parser"

      - name: Check perl-lexer API compatibility
        run: |
          cargo semver-checks check-release -p perl-lexer \
            --baseline-rev ${{ steps.baseline.outputs.baseline }} \
            || echo "::warning::Breaking changes detected in perl-lexer"

      - name: Check perl-parser-core API compatibility
        run: |
          cargo semver-checks check-release -p perl-parser-core \
            --baseline-rev ${{ steps.baseline.outputs.baseline }} \
            || echo "::warning::Breaking changes detected in perl-parser-core"

      - name: Generate breaking changes report
        if: always()
        run: |
          mkdir -p target/semver-reports
          cargo semver-checks check-release --workspace \
            --baseline-rev ${{ steps.baseline.outputs.baseline }} \
            --output-format json > target/semver-reports/breaking-changes.json || true

      - name: Upload breaking changes report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: semver-breaking-changes-report
          path: target/semver-reports/breaking-changes.json
          retention-days: 30

  clippy-strict:
    name: Clippy (Strict)
    timeout-minutes: 20
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' &&
       contains(github.event.pull_request.labels.*.name, 'ci:strict'))
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ runner.os }}-clippy-strict-${{ hashFiles('Cargo.lock') }}
          cache-on-failure: true

      - name: Run clippy (strict mode)
        run: |
          cargo clippy --workspace --locked -- -D warnings -D clippy::all -A missing_docs

  # ============================================================================
  # Fuzz Testing (nightly only)
  # ============================================================================

  fuzz:
    name: Fuzz Target (${{ matrix.target }})
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule'
    strategy:
      fail-fast: false
      matrix:
        target: [
          builtin_functions,
          heredoc_parsing,
          lsp_navigation,
          substitution_parsing,
          unicode_positions
        ]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Install Rust toolchain (nightly)
      uses: dtolnay/rust-toolchain@nightly
      with:
        components: rust-src

    - name: Cache cargo dependencies
      uses: Swatinem/rust-cache@v2
      with:
        key: ${{ runner.os }}-fuzz-${{ matrix.target }}-${{ hashFiles('Cargo.lock') }}
        cache-on-failure: true

    - name: Install cargo-fuzz
      run: cargo install cargo-fuzz

    - name: Run fuzzer
      run: |
        DURATION=${{ github.event.inputs.duration || '600' }}
        cargo +nightly fuzz run ${{ matrix.target }} -- -max_total_time=$DURATION -max_len=1000 -timeout=25

    - name: Upload crash artifacts
      if: failure()
      uses: actions/upload-artifact@v6
      with:
        name: fuzz-artifacts-${{ matrix.target }}-${{ github.sha }}
        path: |
          fuzz/artifacts/
          fuzz/corpus/
        retention-days: 30
