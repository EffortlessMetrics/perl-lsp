name: CI

# Main merge-blocking gate for all PRs
# Runs comprehensive checks required before merge
# Cost: ~$0.05 per PR

on:
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: {}

# Cancel in-flight runs on new pushes (saves minutes)
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  ci-gate:
    name: CI Gate (Merge-Blocking)
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
          components: rustfmt, clippy

      - name: Install just
        uses: taiki-e/install-action@v2
        with:
          tool: just

      # Aggressive caching for dependencies and build artifacts
      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          cache-all-crates: true
          shared-key: ci-gate-${{ hashFiles('Cargo.lock') }}

      - name: Run ci-gate with receipts
        run: just gates

      - name: Upload gate receipt
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: gate-receipt-${{ github.sha }}
          path: |
            target/receipts/receipt.json
            target/receipts/logs/*.log
            target/receipts/artifacts/*
          if-no-files-found: warn
          retention-days: 7

      - name: Gate summary
        if: always()
        shell: bash
        run: |
          python3 - <<'PY'
          import json
          import os
          from pathlib import Path

          receipt_path = Path("target/receipts/receipt.json")
          summary_path = os.environ.get("GITHUB_STEP_SUMMARY")

          if not summary_path:
              raise SystemExit(0)

          lines = ["### CI Gate Receipt", ""]
          if not receipt_path.exists():
              lines.append("Receipt not found.")
              Path(summary_path).write_text("\n".join(lines) + "\n", encoding="utf-8")
              raise SystemExit(0)

          data = json.loads(receipt_path.read_text(encoding="utf-8"))
          lines.append(f"Generated: {data.get('generated_at', '')}")
          lines.append(f"Commit: {data.get('commit', '')}")
          lines.append("")
          lines.append("| Gate | Status | Exit | Duration (s) |")
          lines.append("| --- | --- | --- | --- |")
          for gate in data.get("gates", []):
              lines.append(
                  f"| {gate.get('name', '')} | {gate.get('status', '')} | "
                  f"{gate.get('exit_code', '')} | {gate.get('duration_seconds', '')} |"
              )

          Path(summary_path).write_text("\n".join(lines) + "\n", encoding="utf-8")
          PY

      - name: Set PR status (check)
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            let status = 'success';
            let description = 'All checks passed';

            if (!fs.existsSync('target/receipts/receipt.json')) {
              status = 'failure';
              description = 'Gate receipt not found';
            } else {
              const data = JSON.parse(fs.readFileSync('target/receipts/receipt.json', 'utf8'));
              const failedGates = data.gates.filter(g => g.status !== 'passed');
              if (failedGates.length > 0) {
                status = 'failure';
                description = `${failedGates.length} gate(s) failed: ${failedGates.map(g => g.name).join(', ')}`;
              }
            }

            console.log(`Setting PR status to: ${status}`);
            console.log(`Description: ${description}`);
