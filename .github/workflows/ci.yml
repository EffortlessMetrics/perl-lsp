name: CI

# Main merge-blocking gate for all PRs
# Runs comprehensive checks required before merge
# Cost: ~$0.05 per PR

on:
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: {}

# Cancel in-flight runs on new pushes (saves minutes)
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  ci-gate:
    name: CI Gate (Merge-Blocking)
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
          components: rustfmt, clippy

      - name: Install just
        uses: taiki-e/install-action@v2
        with:
          tool: just

      # Aggressive caching for dependencies and build artifacts
      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          cache-all-crates: true
          shared-key: ci-gate-${{ hashFiles('Cargo.lock') }}

      - name: Run ci-gate with receipts
        run: just gates

      - name: Upload gate receipt
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: gate-receipt-${{ github.sha }}
          path: |
            target/receipts/receipt.json
            target/receipts/logs/*.log
            target/receipts/artifacts/*
          if-no-files-found: warn
          retention-days: 7

      - name: Dump gate failures on error
        if: failure()
        run: |
          echo "=== receipt.json (tail) ==="
          test -f target/receipts/receipt.json && tail -200 target/receipts/receipt.json || true
          echo "=== failed gates ==="
          python3 - <<'PY' || true
          import json, pathlib
          p = pathlib.Path("target/receipts/receipt.json")
          if not p.exists(): raise SystemExit(0)
          data = json.loads(p.read_text())
          for g in data.get("gates", []):
              if str(g.get("status", "")).lower() not in ("passed", "pass", "skipped", "skip"):
                  print(f"- {g.get('gate_name', g.get('name', '<unnamed>'))}: {g.get('status', '')} (exit {g.get('exit_code', '?')})")
          PY

      - name: Gate summary
        if: always()
        shell: bash
        run: |
          python3 - <<'PY'
          import json
          import os
          from pathlib import Path

          receipt_path = Path("target/receipts/receipt.json")
          summary_path = os.environ.get("GITHUB_STEP_SUMMARY")

          if not summary_path:
              raise SystemExit(0)

          lines = ["### CI Gate Receipt", ""]
          if not receipt_path.exists():
              lines.append("Receipt not found.")
              Path(summary_path).write_text("\n".join(lines) + "\n", encoding="utf-8")
              raise SystemExit(0)

          data = json.loads(receipt_path.read_text(encoding="utf-8"))
          md = data.get("metadata", {})
          lines.append(f"Generated: {md.get('timestamp', data.get('generated_at', ''))}")
          lines.append(f"Commit: {md.get('git_sha_short', data.get('commit', ''))}")
          lines.append("")
          lines.append("| Gate | Status | Exit | Duration (s) |")
          lines.append("| --- | --- | --- | --- |")
          for gate in data.get("gates", []):
              gate_label = gate.get('gate_name', gate.get('name', ''))
              dur_ms = gate.get('duration_ms')
              dur_s = f"{dur_ms / 1000:.1f}" if dur_ms is not None else str(gate.get('duration_seconds', ''))
              lines.append(
                  f"| {gate_label} | {gate.get('status', '')} | "
                  f"{gate.get('exit_code', '')} | {dur_s} |"
              )

          Path(summary_path).write_text("\n".join(lines) + "\n", encoding="utf-8")
          PY

      - name: Set PR status (check)
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            let status = 'success';
            let description = 'All checks passed';

            if (!fs.existsSync('target/receipts/receipt.json')) {
              status = 'failure';
              description = 'Gate receipt not found';
            } else {
              const data = JSON.parse(fs.readFileSync('target/receipts/receipt.json', 'utf8'));
              const ok = s => ['passed', 'pass', 'skipped', 'skip'].includes(String(s || '').toLowerCase());
              const failedGates = (data.gates || []).filter(g => !ok(g.status));
              if (failedGates.length > 0) {
                status = 'failure';
                description = `${failedGates.length} gate(s) failed: ${failedGates.map(g => g.gate_name || g.name || '<unnamed>').join(', ')}`;
              }
            }

            console.log(`Setting PR status to: ${status}`);
            console.log(`Description: ${description}`);
