name: CI

on:
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: {}

# Cancel in-flight runs on new pushes (saves minutes)
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  ci-gate:
    name: CI Gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.89.0
          components: rustfmt, clippy
      - uses: taiki-e/install-action@v2
        with:
          tool: just
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
      - name: Run ci-gate with receipts
        run: just gates
      - name: Upload gate receipt
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gate-receipt
          path: |
            target/receipts/receipt.json
            target/receipts/logs/*.log
            target/receipts/artifacts/*
          if-no-files-found: warn
      - name: Gate summary
        if: always()
        shell: bash
        run: |
          python3 - <<'PY'
          import json
          import os
          from pathlib import Path

          receipt_path = Path("target/receipts/receipt.json")
          summary_path = os.environ.get("GITHUB_STEP_SUMMARY")

          if not summary_path:
              raise SystemExit(0)

          lines = ["### Gate Receipt", ""]
          if not receipt_path.exists():
              lines.append("Receipt not found.")
              Path(summary_path).write_text("\n".join(lines) + "\n", encoding="utf-8")
              raise SystemExit(0)

          data = json.loads(receipt_path.read_text(encoding="utf-8"))
          lines.append(f"Generated: {data.get('generated_at', '')}")
          lines.append(f"Commit: {data.get('commit', '')}")
          lines.append("")
          lines.append("| Gate | Status | Exit | Duration (s) |")
          lines.append("| --- | --- | --- | --- |")
          for gate in data.get("gates", []):
              lines.append(
                  f"| {gate.get('name', '')} | {gate.get('status', '')} | "
                  f"{gate.get('exit_code', '')} | {gate.get('duration_seconds', '')} |"
              )

          Path(summary_path).write_text("\n".join(lines) + "\n", encoding="utf-8")
          PY
