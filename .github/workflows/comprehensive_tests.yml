name: Comprehensive Test Suite

on:
  workflow_dispatch: {}
  pull_request:
    branches: [ main, master ]
    types: [labeled]

# Cancel in-flight runs on new pushes (saves minutes)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  test:
    name: Run All Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.labels.*.name, 'ci:all-tests')

    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
    
    - name: Cache cargo dependencies
      uses: Swatinem/rust-cache@v2
      with:
        key: ${{ runner.os }}-comprehensive-${{ hashFiles('Cargo.lock') }}
        cache-on-failure: true
    
    - name: Run comprehensive test suite (print everything)
      env:
        RUST_BACKTRACE: full
      run: |
        set -euo pipefail
        echo "== perl-parser (full, excluding fuzz) =="
        cargo test --locked --no-fail-fast -p perl-parser -- --nocapture \
          --skip fuzz_regression_test
        echo "== substitution_operator_tests (focused) =="
        cargo test --locked --no-fail-fast -p perl-parser substitution_operator_tests -- --nocapture
    
    - name: Verify no empty test binaries
      run: |
        echo "Checking for test files with 0 tests..."
        EMPTY_TESTS=""
        
        for test_file in crates/perl-parser/tests/*.rs; do
          test_name=$(basename "$test_file" .rs)
          TEST_COUNT=$(cargo test --locked -p perl-parser --test "$test_name" -- --list 2>/dev/null | grep -c ": test" || echo "0")
          
          if [ "$TEST_COUNT" = "0" ]; then
            EMPTY_TESTS="$EMPTY_TESTS $test_name"
          fi
        done
        
        if [ -n "$EMPTY_TESTS" ]; then
          echo "❌ ERROR: The following test files have 0 tests:"
          for empty in $EMPTY_TESTS; do
            echo "  - $empty"
          done
          echo ""
          echo "This may indicate a wrapper issue or missing tests. Please investigate!"
          exit 1
        else
          echo "✅ All test files contain runnable tests"
        fi
    
    - name: Run tests with all features
      run: cargo test --locked --workspace --all-features --all-targets
    
    - name: Check for orphaned tests
      run: |
        # Count test functions in source vs executed
        SOURCE_TEST_COUNT=$(grep -r "#\[test\]" crates/perl-parser/tests/ | wc -l)
        echo "Test functions in source: $SOURCE_TEST_COUNT"
        
        # This is a sanity check - if the executed count is way lower than source,
        # we likely have a discovery issue
        if [ "$SOURCE_TEST_COUNT" -gt 100 ]; then
          echo "✅ Found $SOURCE_TEST_COUNT test functions in source files"
        else
          echo "⚠️  Warning: Only found $SOURCE_TEST_COUNT test functions, expected more"
        fi
