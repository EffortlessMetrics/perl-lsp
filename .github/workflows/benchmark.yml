name: Benchmarks

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  benchmark:
    name: Performance Benchmarks
    if: contains(github.event.pull_request.labels.*.name, 'ci:bench')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo dependencies
      uses: Swatinem/rust-cache@v2
      with:
        key: ${{ runner.os }}-bench-${{ hashFiles('Cargo.lock') }}
        cache-on-failure: true

    - name: Install hyperfine
      run: |
        wget https://github.com/sharkdp/hyperfine/releases/download/v1.18.0/hyperfine_1.18.0_amd64.deb
        sudo dpkg -i hyperfine_1.18.0_amd64.deb

    - name: Run Rust benchmarks
      run: |
        cargo bench -p perl-parser --bench parser_benchmark -- --output-format bencher | tee output.txt

    - name: Run comparison benchmarks
      run: |
        ./scripts/benchmark_all.sh > benchmark_results.txt 2>&1 || true
        ./scripts/compare_all_levels.sh > comparison_results.txt 2>&1 || true

    - name: Store benchmark result
      uses: benchmark-action/github-action-benchmark@v1
      with:
        name: Rust Benchmark
        tool: 'cargo'
        output-file-path: output.txt
        github-token: ${{ secrets.GITHUB_TOKEN }}
        auto-push: false
        alert-threshold: '200%'
        comment-on-alert: true
        alert-comment-cc-users: '@maintainers'

    - name: Upload benchmark artifacts
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: |
          output.txt
          benchmark_results.txt
          comparison_results.txt

  comparison-benchmark:
    name: Parser Comparison Benchmark
    if: contains(github.event.pull_request.labels.*.name, 'ci:bench')
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Run comparison benchmarks
      run: |
        echo "# Parser Comparison Results" > comparison_report.md
        echo "" >> comparison_report.md
        echo "## Summary Statistics" >> comparison_report.md
        cargo bench -p perl-parser --bench positions_bench -- --warm-up-time 1 --measurement-time 5 2>&1 | tee -a comparison_report.md || true
        
    - name: Upload comparison report
      uses: actions/upload-artifact@v4
      with:
        name: comparison-report
        path: comparison_report.md

  memory-profile:
    name: Memory Usage Profile
    if: contains(github.event.pull_request.labels.*.name, 'ci:bench')
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Install valgrind
      run: sudo apt-get update && sudo apt-get install -y valgrind

    - name: Profile memory usage
      run: |
        echo "# Memory Usage Profile" > memory_report.md
        echo "" >> memory_report.md
        echo "Memory profiling requires valid parser binary - skipped when labeled ci:bench" >> memory_report.md
        echo "Run parser benchmarks locally with: cargo bench -p perl-parser" >> memory_report.md

    - name: Upload memory profile
      uses: actions/upload-artifact@v4
      with:
        name: memory-profile
        path: |
          memory_report.md
          massif.*.out
