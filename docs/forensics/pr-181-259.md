# PR #181 + #259: Call Hierarchy and Name Span Improvements

**Archaeology Date**: 2026-01-07
**Commits**:
- `8247a302` - fix(lsp): use name_span for selectionRange in call hierarchy (#181)
- `90e47a4f` - feat(parser): add name_span for precise LSP navigation in phase blocks (#259)

**Type**: Capability PR (LSP navigation precision improvement)

---

## 1. Intent

| Field | Description |
|-------|-------------|
| PR Numbers | #181, #259 |
| Issue/AC | Issue #180 (name_span infrastructure), Issue #181 (workspace features) |
| Stated Goal | Improve LSP navigation precision by using name_span for selectionRange instead of full node range |
| Actual Scope | Parser (name_span/phase_span capture), LSP (call hierarchy selectionRange), workspace symbols (container names), tests |

**Problem Statement**:
- Previously: `selectionRange` = full node range (entire `sub function_name { ... }` block)
- This caused imprecise cursor placement when editors navigated to symbols
- LSP clients highlight the full block instead of just the function name

**Solution**:
- PR #181: Use existing `name_span` in call hierarchy provider
- PR #259: Add `phase_span` to PhaseBlock nodes, populate `name_span` properly in parser

---

## 2. Scope Map

### PR #181 (8247a302)

| Directory | Files Changed | Lines Delta | Notes |
|-----------|---------------|-------------|-------|
| `crates/perl-parser/src/` | 2 | +49/-19 | call_hierarchy_provider.rs, capabilities.rs |
| `docs/` | 1 | +45/-22 | CURRENT_STATUS.md metrics update |
| **Total** | 3 | +74/-24 | Net: +50 lines |

### PR #259 (90e47a4f)

| Directory | Files Changed | Lines Delta | Notes |
|-----------|---------------|-------------|-------|
| `crates/perl-parser/src/` | 8 | +273/-41 | ast.rs, parser.rs, call_hierarchy_provider.rs, etc. |
| `crates/perl-parser/tests/` | 1 | +342 | name_spans_special_test.rs (new, 11 tests) |
| `crates/tree-sitter-perl-rs/src/` | 1 | +54/-17 | phase_aware_parser.rs |
| `docs/` | 1 | +45/-22 | CURRENT_STATUS.md metrics update |
| **Total** | 11 | +759/-50 | Net: +709 lines |

**Combined Key Artifacts**:
- `/crates/perl-parser/src/call_hierarchy_provider.rs` - `selection_range_from_name_span()` helper
- `/crates/perl-parser/src/ast.rs` - `phase_span: Option<SourceLocation>` added to PhaseBlock
- `/crates/perl-parser/src/parser.rs` - name_span capture from tokens
- `/crates/perl-parser/tests/name_spans_special_test.rs` - 11 comprehensive span tests
- `/crates/perl-parser/src/workspace_symbols.rs` - container name extraction

---

## 3. Evidence Pointers

### Test Coverage

| Test Suite | Pass | Fail | Ignored | Notes |
|------------|------|------|---------|-------|
| name_spans_special_test.rs | 11 | 0 | 0 | All phase/subroutine span tests |
| call_hierarchy_provider tests | 3 | 0 | 0 | prepare, incoming, outgoing calls |
| workspace_symbols tests | 4+ | 0 | 0 | container name extraction |

### Test Categories (name_spans_special_test.rs)
1. `test_autoload_name_span` - AUTOLOAD subroutine span validation
2. `test_destroy_name_span` - DESTROY subroutine span validation
3. `test_begin_phase_span` - BEGIN phase block span
4. `test_end_phase_span` - END phase block span
5. `test_check_phase_span` - CHECK phase block span
6. `test_init_phase_span` - INIT phase block span
7. `test_unitcheck_phase_span` - UNITCHECK phase block span
8. `test_multiple_phase_blocks_with_spans` - Multiple blocks in one file
9. `test_autoload_and_destroy_both_have_spans` - Combined special subs
10. `test_name_span_not_entire_block` - Verifies span is just identifier
11. `test_phase_span_not_entire_block` - Verifies span is just keyword

### Test Verification (2026-01-07)
```
$ cargo test -p perl-parser --test name_spans_special_test
running 11 tests
test test_autoload_name_span ... ok
test test_begin_phase_span ... ok
test test_destroy_name_span ... ok
test test_end_phase_span ... ok
test test_check_phase_span ... ok
test test_init_phase_span ... ok
test test_unitcheck_phase_span ... ok
test test_multiple_phase_blocks_with_spans ... ok
test test_autoload_and_destroy_both_have_spans ... ok
test test_name_span_not_entire_block ... ok
test test_phase_span_not_entire_block ... ok

test result: ok. 11 passed; 0 failed; 0 ignored
```

---

## 4. Findings

| Category | Finding | Severity | Evidence |
|----------|---------|----------|----------|
| Clean Implementation | name_span correctly consumed in call hierarchy | - | call_hierarchy_provider.rs:121-122 |
| Clean Implementation | phase_span added to PhaseBlock AST node | - | ast.rs:1527 |
| Helper Method | `selection_range_from_name_span()` added for reuse | - | call_hierarchy_provider.rs:501-513 |
| Bonus Feature | Container names added to workspace symbols | - | workspace_symbols.rs:73-88 |
| Test Coverage | 11 dedicated span validation tests | - | name_spans_special_test.rs |
| TODO Resolved | "TODO: Calculate name range" replaced with actual implementation | - | call_hierarchy_provider.rs diff |

### Behavioral Change Analysis

**Before (selectionRange = full range)**:
```rust
// call_hierarchy_provider.rs (old)
let range = self.node_to_range(node);
let selection_range = range.clone(); // TODO: Calculate name range
```

**After (selectionRange = name_span)**:
```rust
// call_hierarchy_provider.rs (new)
let range = self.node_to_range(node);
let selection_range = self.selection_range_from_name_span(name_span, &range);
```

This means:
- `sub my_function { ... }` now has selectionRange covering just `my_function`
- `BEGIN { ... }` now has selectionRange covering just `BEGIN`
- Editor "go to definition" now places cursor on the identifier, not start of block

---

## 5. Budget Estimates

| Metric | Value | Notes |
|--------|-------|-------|
| DevLT (human attention) | 60-90 min | 30-120 band - moderate complexity |
| Compute (tokens/CI) | Moderate | ~30K tokens estimated, parser + LSP changes |
| Efficiency | High | Clean, focused implementation with good test coverage |

### Scope Assessment
- **PR #181**: Minimal scope - 3 files, used existing infrastructure
- **PR #259**: Expanded scope - added tests, phase_span, container names
- Combined: Appropriate scope expansion to ensure correctness

---

## 6. Factory Delta

| Guardrail | Before | After | Notes |
|-----------|--------|-------|-------|
| name_span usage | Declared but unused | Used in call hierarchy | LSP precision improved |
| phase_span | Did not exist | Available for phase blocks | BEGIN/END/CHECK/INIT/UNITCHECK |
| Span tests | None | 11 tests | Prevents regressions |
| Container names | Not populated | Extracted from qualified_name | Workspace symbol disambiguation |

### LSP Protocol Compliance
- `selectionRange` now correctly identifies the "symbol name" portion
- Matches LSP 3.17 specification: "The range that should be selected and revealed when this symbol is being picked"

---

## 7. Exhibit Score

| Dimension | Score (1-5) | Notes |
|-----------|-------------|-------|
| Clarity of intent | 5 | Clear commit messages, well-documented problem/solution |
| Scope discipline | 4 | #259 expanded scope appropriately for completeness |
| Evidence quality | 5 | 11 tests with byte-precise assertions |
| Test coverage | 5 | Comprehensive span validation, edge cases covered |
| DevLT efficiency | 5 | Focused changes, good reuse of helpers |

**Overall**: This is a model capability PR - clear intent, precise implementation, thorough testing.

---

## 8. Technical Details

### AST Changes (ast.rs)
```rust
// PhaseBlock with new phase_span field
PhaseBlock {
    phase: String, // BEGIN, END, CHECK, INIT, UNITCHECK
    phase_span: Option<SourceLocation>,  // NEW: precise location of keyword
    block: Box<Node>,
}
```

### Parser Changes (parser.rs)
```rust
// parse_phase_block now captures phase_span
let phase_token = self.consume_token()?;
let phase = phase_token.text.clone();
let phase_span = Some(SourceLocation {
    start: phase_token.start,
    end: phase_token.end
});

// parse_special_subroutine now captures name_span
let name_token = self.consume_token()?;
let name_span = Some(SourceLocation {
    start: name_token.start,
    end: name_token.end
});
```

### Call Hierarchy Integration
```rust
fn selection_range_from_name_span(
    &self,
    name_span: &Option<crate::SourceLocation>,
    full_range: &Range,
) -> Range {
    match name_span {
        Some(span) => Range {
            start: self.offset_to_position(span.start),
            end: self.offset_to_position(span.end),
        },
        None => full_range.clone(),
    }
}
```

---

## 9. Related Issues/PRs

- **Issue #180**: Name spans infrastructure (parent issue)
- **Issue #181**: Workspace features tracking
- **PR #259**: Extended #181 with phase block support
- **Sprint B**: Both PRs part of Sprint B improvements

---

## 10. Lessons Learned

1. **Infrastructure before consumption**: name_span was declared in AST but not populated - #259 fixed the parser to actually capture it

2. **Helper methods for reuse**: `selection_range_from_name_span()` encapsulates the fallback logic cleanly

3. **Test byte positions explicitly**: The tests verify exact byte offsets (e.g., `span.start == 4` for `"sub AUTOLOAD"`) - this catches off-by-one errors

4. **Cover both normal and special cases**: Tests include AUTOLOAD, DESTROY, and all 5 phase block types

5. **Bonus features welcome**: Adding container names to workspace symbols was out of original scope but improves the feature
