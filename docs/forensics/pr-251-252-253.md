# PR Forensics: Test Harness Hardening (PRs #251, #252, #253)

**Category**: Mechanization - Test Infrastructure
**Date**: 2025-12-30
**Combined scope**: Test reliability, JSON-RPC compliance, BrokenPipe elimination

---

## 1. Intent

| Field | Description |
|-------|-------------|
| PR numbers | #251, #252, #253 (sequential, same-day commits) |
| Issue/AC | Test flakiness remediation; LSP protocol compliance |
| Stated goal | Fix BrokenPipe errors, harden test harness, ensure JSON-RPC compliance |
| Actual scope | `crates/perl-lsp/tests/`, `crates/perl-parser/src/lsp/protocol/errors.rs`, test infrastructure |

### Per-PR Breakdown

**PR #251**: `fd3c06cb` - Initial BrokenPipe sweep
- Goal: Remove `#[ignore]` from tests that were flaky due to missing LSP protocol compliance
- Key fix: Added `initialized` notification after `initialize` request (required per LSP spec)

**PR #252**: `dda113d1` - Test harness hardening
- Goal: Add shutdown guards, proper error codes, atomic flags
- Key fix: Introduced `is_shutting_down` atomic flag to prevent writes after shutdown

**PR #253**: `b2157154` - JSON-RPC compliance completion
- Goal: Ensure all error responses include proper JSON-RPC 2.0 envelope (`jsonrpc`, `id`, `error`)
- Key fix: Request IDs extracted before error handling; proper `map_send_error()` function

---

## 2. Scope Map

| Directory | Files Changed | Lines Delta | Notes |
|-----------|---------------|-------------|-------|
| `crates/perl-lsp/tests/` | 64 (combined) | +500/-650 | Test unignoring + shutdown calls |
| `crates/perl-lsp/tests/common/mod.rs` | 3 (repeated) | +200 net | Core harness improvements |
| `crates/perl-parser/src/lsp/protocol/errors.rs` | 2 | +50 | New error codes |
| `scripts/` | 3 | +20 | Baseline updates |

### Commit Statistics

| PR | Files | Insertions | Deletions |
|----|-------|------------|-----------|
| #251 | 24 | 76 | 154 |
| #252 | 52 | 222 | 334 |
| #253 | 45 | 375 | 230 |
| **Total** | ~70 unique | +673 | -718 |

---

## 3. Evidence Pointers

### Ignored Test Counts (before/after)

| Metric | Before #251 | After #251 | After #252 | After #253 |
|--------|-------------|------------|------------|------------|
| brokenpipe | 386 | 250 | 17 | **0** |
| total ignored | 580 | 457 | 222 | **215** |

**Key outcome**: BrokenPipe-related ignores reduced from **386 to 0** (100% elimination).

### Protocol Fixes Verified

1. **`initialized` notification**: Added to all tests that call `initialize` (LSP spec requirement)
2. **Explicit `shutdown_and_exit()`**: Added to all tests to ensure graceful server termination
3. **JSON-RPC envelope compliance**: All error responses now include `jsonrpc: "2.0"` and `id`

---

## 4. Findings

| Category | Finding | Severity | Evidence |
|----------|---------|----------|----------|
| Protocol violation | Tests missing `initialized` notification | P1 | `lsp_pull_diagnostics_test.rs` diff |
| Race condition | Writes after shutdown started | P1 | `common/mod.rs` atomic flag |
| Spec non-compliance | Error responses missing JSON-RPC envelope | P2 | `error_response_for_request()` added |
| Test teardown | Missing `shutdown_and_exit()` calls | P2 | 40+ tests missing cleanup |
| Error code mismatch | Used `-32600` (InvalidRequest) for transport errors | P3 | Changed to `-32050` (CONNECTION_CLOSED) |

### Root Cause Analysis

**Why BrokenPipe?**

1. **Missing `initialized`**: Server expected the notification per LSP spec; tests skipped it
2. **Missing shutdown**: Tests ended without graceful shutdown, server wrote to closed pipe
3. **Race condition**: Server process continued writing after test dropped handle

**Why flaky?**

- Timing-dependent: fast machines often passed, slow CI often failed
- Process scheduling: whether server wrote before or after pipe closed was non-deterministic

---

## 5. Budget Estimates

| Metric | Value | Notes |
|--------|-------|-------|
| DevLT (human attention) | 120-180 min | Three PRs, systematic sweep |
| Compute (tokens/CI) | Moderate | 50K+ tokens, multiple test runs |
| Efficiency | High | Systemic fix vs. individual ignores |

Band: **30-120 min (stretched to 120+)** due to three-stage approach

The staged approach (251 -> 252 -> 253) was deliberate:
1. First pass: protocol compliance (easy wins)
2. Second pass: infrastructure hardening (structural)
3. Third pass: JSON-RPC spec compliance (correctness)

---

## 6. Factory Delta

| Guardrail | Before | After | Notes |
|-----------|--------|-------|-------|
| BrokenPipe count | 386 ignored | 0 ignored | Complete elimination |
| Test harness | No shutdown guards | Atomic shutdown flag | Prevents race conditions |
| Error codes | Ad-hoc | Codified in `errors.rs` | CONNECTION_CLOSED (-32050), TRANSPORT_ERROR (-32051) |
| JSON-RPC compliance | Partial | Full envelope | `error_response_for_request()` |
| Test cleanup | Optional | Required pattern | All tests now call `shutdown_and_exit()` |

### New Error Codes Introduced

```rust
// crates/perl-parser/src/lsp/protocol/errors.rs
pub const CONNECTION_CLOSED: i32 = -32050;
pub const TRANSPORT_ERROR: i32 = -32051;
```

### Test Harness Pattern Established

```rust
// Required pattern for all LSP tests:
let mut server = start_lsp_server();
let _ = initialize_lsp(&mut server);
// ... test logic ...
shutdown_and_exit(&mut server);  // REQUIRED
```

---

## 7. Exhibit Score

| Dimension | Score (1-5) | Notes |
|-----------|-------------|-------|
| Clarity of intent | 5 | Clear commit messages, systematic approach |
| Scope discipline | 5 | Focused on test infrastructure only |
| Evidence quality | 5 | Baseline counts before/after |
| Test coverage | 5 | 386 tests unblocked |
| DevLT efficiency | 4 | Three PRs vs. one, but each was coherent |

**Overall**: Exemplary mechanization PR series. Systematic approach eliminated an entire class of flakiness.

---

## 8. Lessons Learned

### What was wrong

1. **LSP protocol compliance**: Tests did not follow LSP initialization sequence
2. **Resource cleanup**: Tests relied on implicit cleanup (Drop) vs. explicit shutdown
3. **Error handling**: Error responses were semantically incorrect (wrong codes, missing envelope)

### What was fixed

1. All tests now send `initialized` after `initialize`
2. All tests now call `shutdown_and_exit()` explicitly
3. Test harness has atomic shutdown flag to prevent post-shutdown writes
4. Error responses are fully JSON-RPC 2.0 compliant

### What prevents recurrence

1. **Pattern documentation**: This dossier documents the required pattern
2. **Infrastructure guards**: Atomic flag rejects writes after shutdown
3. **Code review awareness**: Future tests must follow established pattern
4. **CI stability**: Zero BrokenPipe baseline enforces no regression

---

## 9. Key Code Artifacts

### Error Response Function (PR #253)

```rust
// crates/perl-lsp/tests/common/mod.rs
fn error_response_for_request(id: Option<Value>, code: i64, message: &str) -> Value {
    json!({
        "jsonrpc": "2.0",
        "id": id.unwrap_or(Value::Null),
        "error": {
            "code": code,
            "message": message
        }
    })
}
```

### Shutdown Guard (PR #252)

```rust
// crates/perl-lsp/tests/common/mod.rs
pub fn send_request(server: &mut LspServer, mut request: Value) -> Value {
    // IMPORTANT: Extract/assign ID FIRST, before any early returns.
    let id = match request.get("id") { ... };

    // ... send logic with proper error handling ...
}
```

### Initialized Notification (PR #251)

```rust
// Required after initialize response
let initialized_notification = JsonRpcRequest {
    _jsonrpc: "2.0".into(),
    id: None,
    method: "initialized".into(),
    params: Some(json!({})),
};
let _ = server.handle_request(initialized_notification);
```

---

## References

- Commit `fd3c06cb`: PR #251 - Initial BrokenPipe sweep
- Commit `dda113d1`: PR #252 - Test harness hardening
- Commit `b2157154`: PR #253 - JSON-RPC compliance
- LSP Specification: [lifecycle/initialize](https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#initialize)
