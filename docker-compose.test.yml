version: "3.9"
services:
  rust-tests:
    build: 
      context: .
      dockerfile: .docker/rust/Dockerfile
    command: sh -lc "./scripts/preflight.sh && RUST_TEST_THREADS=2 cargo test -- --test-threads=2"
    cpus: 4
    mem_limit: 16g
    pids_limit: 1024
    ulimits:
      nofile:
        soft: 8192
        hard: 8192
    environment:
      - RUST_TEST_THREADS=2
      - OMP_NUM_THREADS=1
      - OPENBLAS_NUM_THREADS=1
      - MKL_NUM_THREADS=1
      - NUMEXPR_NUM_THREADS=1
    volumes:
      - .:/workspace
      - rust-target:/workspace/target
    working_dir: /workspace

  rust-e2e-tests:
    build: 
      context: .
      dockerfile: .docker/rust/Dockerfile
    command: sh -lc "./scripts/test-e2e-capped.sh"
    cpus: 4
    mem_limit: 16g
    pids_limit: 1024
    ulimits:
      nofile:
        soft: 8192
        hard: 8192
    environment:
      - RUST_TEST_THREADS=2
      - MAX_E2E=2
      - OMP_NUM_THREADS=1
      - OPENBLAS_NUM_THREADS=1
      - MKL_NUM_THREADS=1
      - NUMEXPR_NUM_THREADS=1
    volumes:
      - .:/workspace
      - rust-target:/workspace/target
    working_dir: /workspace

  rust-lsp-tests:
    build: 
      context: .
      dockerfile: .docker/rust/Dockerfile
    command: sh -lc "./scripts/preflight.sh && RUST_TEST_THREADS=2 cargo test -p perl-parser lsp -- --test-threads=2"
    cpus: 4
    mem_limit: 16g
    pids_limit: 1024
    ulimits:
      nofile:
        soft: 8192
        hard: 8192
    environment:
      - RUST_TEST_THREADS=2
      - OMP_NUM_THREADS=1
      - OPENBLAS_NUM_THREADS=1
      - MKL_NUM_THREADS=1
      - NUMEXPR_NUM_THREADS=1
    volumes:
      - .:/workspace
      - rust-target:/workspace/target
    working_dir: /workspace

volumes:
  rust-target: